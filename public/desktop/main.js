"use strict";function jsonp(e,o,t){var n=document.createElement("script");n.type="text/javascript";var s=Date.now()+String(Math.floor(100*Math.random()));n.src=e+(e.indexOf("?")>0?"&":"?")+"callback=CB"+s,n.onload=function(){n.parentNode.removeChild(n)},n.onerror=function(e){t&&t(e)},window["CB"+s]=function(e){o(e)},document.head.appendChild(n)}function createCookie(e,o,t){var n="";if(t){var s=new Date;s.setTime(s.getTime()+24*t*60*60*1e3),n="; expires="+s.toUTCString()}document.cookie=e+"="+o+n+"; path=/"}function readCookie(e){for(var o=e+"=",t=document.cookie.split(";"),n=0;n<t.length;n++){for(var s=t[n];" "==s.charAt(0);)s=s.substring(1,s.length);if(0==s.indexOf(o))return s.substring(o.length,s.length)}return null}function eraseCookie(e){createCookie(e,"",-1)}function getQueryParameterByName(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var o=new RegExp("[\\?&]"+e+"=([^&#]*)"),t=o.exec(location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function configSemantic(){$(".ui.dropdown").dropdown(),$(".ui.search").search({type:"category"}),$(".hasPubInfoPopupBook").popup({inline:!0}),$("#topSearchInputCon").popup({inline:!0,on:"click"}),$(".ui.rating").rating(),$("#menu").sidebar("setting","transition","overlay").sidebar("setting","dimPage",!1).sidebar("toggle"),$("#loadMoreInfiniteScroll").visibility({once:!1,observeChanges:!0,onBottomVisible:function(){var e=angular.element(document).injector(),o=e.get("SearchBook$");o.loadMore()}})}var Model={};if("undefined"!=typeof require)var AV=require("leanengine");Model.User=AV.Object.extend("_User",{avatarUrlWithSize:function(e){var o=this.get("avatarUrl");return o?o.substring(0,o.length-1)+e:null}}),Model.Status=AV.Object.extend("_Status"),Model.BookInfo=AV.Object.extend("BookInfo",{initialize:function(){this.on("change:image",this.genBigImage,this),this.attributes.image&&this.genBigImage()},genBigImage:function(){this.attributes.bigImage=this.get("image"),this.attributes.bigImage.indexOf(".douban.com/")>0&&(this.attributes.bigImage=this.attributes.bigImage.replace("mpic","lpic"))}}),Model.School=AV.Object.extend("School"),Model.UsedBook=AV.Object.extend("UsedBook"),"undefined"!=typeof module&&(module.exports=Model),AV.initialize("kusn9e3cp5znt5lic9fufqfmsvsibsoaejpah089x6v2n7e0","nt5l8v4n4m08zxttpt7upqxwgt6oy47lzb3f8c4juf34otfm"),window.location.host.indexOf("ishuxun.cn")<0&&AV.setProduction(!1);var WECHAT={AppID:"wx2940a8d3ddcad5e9"},LoadCount=Math.floor(document.body.clientWidth/80),RandomStart=(new Date).getDay()*Math.floor(10*Math.random());Array.prototype.pushArray=function(e){for(var o=0;o<e.length;o++)this.push(e[o])},Array.prototype.unshiftArray=function(e){for(var o=0;o<e.length;o++)this.unshift(e[o])};var APP=angular.module("APP",[],null);APP.run(["User$",function(e){e.loginWithUnionId(readCookie("unionId"))}]),setInterval(configSemantic,1e3),APP.service("BookInfo$",["$rootScope",function(e){var o=this;this.getJsonBookByISBN13=function(e){return AV.Cloud.run("getJsonBookByISBN13",{isbn13:e})},this.LatestBook={books:[],hasMoreFlag:!0,loadMore:function(){var t=new AV.Query(Model.BookInfo);t.select(["doubanId","isbn13","title","image","pubdate","author","publisher","pubdate","price"]),t.descending("pubdate"),t.skip(o.LatestBook.books.length+RandomStart),t.limit(LoadCount),t.find().done(function(t){t.length>0?o.LatestBook.books.pushArray(t):o.LatestBook.hasMoreFlag=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return o.LatestBook.hasMoreFlag}},this.searchBook=function(e){var o=new AV.SearchQuery("BookInfo");return o.queryString(e),o.find(null)}}]),APP.service("BookRecommend$",["$rootScope","DoubanBook$","BookInfo$",function(e,o,t){var n=this;this.BookTag={tag:null,load:function(){AV.Cloud.run("getAllBookTags",null,null).done(function(o){n.BookTag.tag=o,e.$apply()})},getTagAttrNames:function(){return n.BookTag.tag?Object.keys(n.BookTag.tag):[]}},this.TagBook={nowTag:"",setTag:function(o){o!=n.TagBook.nowTag&&(n.TagBook.books=[],n.TagBook.nowTag=o,t.searchBook(o).done(function(o){n.TagBook.books.unshiftArray(o),e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")}))},books:[],hasMoreFlag:!0,loadMore:function(){o.getBooksByTag(n.TagBook.nowTag,n.TagBook.books.length,LoadCount,function(o){var t=o.books;if(t.length>0)for(var s=0;s<t.length;s++)n.TagBook.books.push(Model.BookInfo["new"](t[s]));else n.TagBook.hasMoreTag=!1;e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return n.TagBook.hasMoreFlag}},this.MajorBook={major:AV.User.current()?AV.User.current().attributes.major:"",books:[],hasMoreFlag:!0,loadMore:function(){o.getBooksByTag(n.MajorBook.major,n.MajorBook.books.length+RandomStart,LoadCount,function(o){n.MajorBook.totalNum=o.total;var t=o.books;if(t.length>0)for(var s=0;s<t.length;s++)n.MajorBook.books.push(Model.BookInfo["new"](t[s]));else n.MajorBook.hasMoreFlag=!1;e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return n.MajorBook.hasMoreFlag},loadFromBookInfo:function(){t.searchBook(n.MajorBook.major).done(function(o){n.MajorBook.books.unshiftArray(o),e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})}},this.NearNeedBook={needBooks:[],hasMoreFlag:!0,loadMore:function(){var o=AV.User.current()?AV.User.current().get("location"):null,t=new AV.Query(Model.UsedBook);if(t.notEqualTo("owner",AV.User.current()),t.equalTo("role","need"),o&&t.near("location",o),n.NearNeedBook._majorFilter){var s=new AV.Query(Model.User);s.equalTo("major",n.NearNeedBook._majorFilter),t.matchesQuery("owner",s)}t.skip(n.NearNeedBook.needBooks.length+RandomStart),t.limit(LoadCount),t.find().done(function(o){o.length>0?n.NearNeedBook.needBooks.pushArray(o):n.NearNeedBook.hasMoreFlag=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return n.NearNeedBook.hasMoreFlag},_majorFilter:null,setMajorFilter:function(e){e!=n.NearNeedBook._majorFilter&&(n.NearNeedBook.needBooks.length=0,n.NearNeedBook.hasMoreFlag=!0,n.NearNeedBook._majorFilter=e,n.NearNeedBook.loadMore())},getMajorFilter:function(){return n.NearNeedBook._majorFilter}},this.NearUsedBook={usedBooks:[],hasMoreFlag:!0,loadMore:function(){var o=AV.User.current()?AV.User.current().get("location"):null,t=new AV.Query(Model.UsedBook);if(t.notEqualTo("owner",AV.User.current()),t.equalTo("role","sell"),o&&t.near("location",o),n.NearUsedBook._majorFilter){var s=new AV.Query(Model.User);s.equalTo("major",n.NearUsedBook._majorFilter),t.matchesQuery("owner",s)}t.skip(n.NearUsedBook.usedBooks.length),t.limit(LoadCount),t.find().done(function(o){o.length>0?n.NearUsedBook.usedBooks.pushArray(o):n.NearUsedBook.hasMoreFlag=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return n.NearUsedBook.hasMoreFlag},_majorFilter:null,setMajorFilter:function(e){e!=n.NearUsedBook._majorFilter&&(n.NearUsedBook.usedBooks.length=0,n.NearUsedBook.hasMoreFlag=!0,n.NearUsedBook._majorFilter=e,n.NearUsedBook.loadMore())},getMajorFilter:function(){return n.NearUsedBook._majorFilter}},this.NearUser={users:[],hasMoreFlag:!0,loadMore:function(){var o=AV.User.current()?AV.User.current().get("location"):null,t=new AV.Query(Model.User);AV.User.current()&&t.notEqualTo("objectId",AV.User.current().id),o&&t.near("location",o),n.NearUser._majorFilter&&t.equalTo("major",n.NearUser._majorFilter),t.skip(n.NearUser.users.length),t.limit(Math.floor(document.body.clientWidth/50)),t.find().done(function(o){o.length>0?n.NearUser.users.pushArray(o):n.NearUser.hasMoreFlag=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return n.NearUser.hasMoreFlag},_majorFilter:null,setMajorFilter:function(e){e!=n.NearUser._majorFilter&&(n.NearUser.users.length=0,n.NearUser.hasMoreFlag=!0,n.NearUser._majorFilter=e,n.NearUser.loadMore())},getMajorFilter:function(){return n.NearUser._majorFilter}}}]),APP.service("BusinessSite$",function(){this.getBusinessInfoByISBN=function(e){return AV.Cloud.run("getBusinessInfo",{isbn13:e},null)}}),APP.service("DoubanBook$",["$rootScope","BookInfo$",function(e,o){function t(e){for(var o=e.substring(3,12),t=0,n=0;9>n;n++){var s=parseInt(o.charAt(n));t+=s*(10-n)}var i=t%11,a=11-i,r=String(a);return 10==a?r="X":11==a&&(r="0"),String(o+r)}var n=this,s="http://api.douban.com/v2/book";this.getBookByISBD=function(e,n,i){function a(e){var o=s+"/isbn/"+e;return null==i&&(i="id,rating,author,pubdate,image,binding,translator,catalog,pages,publisher,isbn13,title,author_intro,summary,price"),o+="?fields="+i}jsonp(a(e),function(e){n(e)},function(){13==e.length&&jsonp(a(t(e)),function(e){n(e)},function(){o.getJsonBookByISBN13(e).done(function(e){n(e)}).fail(function(){n(null)})})})},this.getBookByISBD_simple=function(e,o){n.getBookByISBD(e,o,"author,pubdate,image,publisher,title,price,isbn13")},this.searchBooks=function(e,o,t,n){var i=s+"/search";return e&&e.length<1?[]:(i+="?q="+e,o&&(i+="&start="+o),t&&(i+="&count="+t),i+="&fields=isbn13,title,image,author,publisher,pubdate,price",void jsonp(i,function(e){n(e)}))},this.getBooksByTag=function(e,o,t,n){var i=s+"/search";return!e||e.length<1?[]:(i+="?tag="+e,o&&(i+="&start="+o),t&&(i+="&count="+t),i+="&fields=isbn13,title,image,author,publisher,pubdate,price",void jsonp(i,function(e){n(e)}))},this.BookReview={reviewList:[],nowBookId:null,hasMoreFlag:!0,loadMore:function(){AV.Cloud.run("getDoubanBookReview",{id:n.BookReview.nowBookId,start:n.BookReview.reviewList.length},null).done(function(o){if(o.length>0)for(var t=0;t<o.length;t++)n.BookReview.reviewList.push(o[t]);else n.BookReview.hasMoreFlag=!1;e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return n.BookReview.hasMoreFlag},clear:function(){n.BookReview.reviewList=[],n.BookReview.hasMoreFlag=!0,e.$broadcast("scroll.infiniteScrollComplete")}}}]),APP.service("InfoService$",["$rootScope",function(e){var o=this;this.majors=[],AV.Cloud.run("getAllMajor",null,null).done(function(e){o.majors=e}),this.searchMajorKeyword="",this.filter_majorByKeyword=function(e){return e.name.indexOf(o.searchMajorKeyword)>-1},this.School={schools:[],loadMore:function(){var t=AV.User.current()?AV.User.current().get("location"):null,n=new AV.Query(Model.School);t&&n.near("location",t),o.School.searchSchoolKeyword.length>0?n.startsWith("name",o.School.searchSchoolKeyword):(n.skip(o.School.schools.length),n.limit(10)),n.find().done(function(t){if(t.length>0)for(var n=0;n<t.length;n++)o.School.schools.push(t[n].get("name"));e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},searchSchoolKeyword:"",filter_schoolByKeyword:function(e){return e.indexOf(o.School.searchSchoolKeyword)>=0}},this.startSchoolYearOptions=[];for(var t=(new Date).getFullYear(),n=t-6;t>=n;n++)o.startSchoolYearOptions.push(n.toString());this.commonUsedBookDesWords=["正版","新书","送笔记","可议价","不议价","配光盘","妹子白送"]}]),APP.service("IonicModalView$",["$rootScope","$ionicModal","$ionicHistory","InfoService$",function(e,o,t,n){this.registerChooseSchoolModalView=function(e,t){e.InfoService$=n,o.fromTemplateUrl("temp/tool/chooseSchoolModalView.html",{scope:e}).then(function(o){e.chooseSchoolModalView=o}),e.schoolOnChoose=function(o){t(o),e.chooseSchoolModalView.hide()}},this.registerChooseMajorModalView=function(e,t){e.InfoService$=n,o.fromTemplateUrl("temp/tool/chooseMajorModalView.html",{scope:e}).then(function(o){e.chooseMajorModalView=o}),e.majorOnChoose=function(o){t(o),e.chooseMajorModalView.hide()}},this.alertTitleAndPreModalView=function(t,n){var s=e.$new(!0);s.titleAndPreModalViewData={title:t,pre:n},o.fromTemplateUrl("temp/tool/titleAndPreModalView.html",{scope:s}).then(function(e){s.titleAndPreModalView=e,e.show()})}}]),APP.service("SearchBook$",["$rootScope","$timeout","DoubanBook$","BookInfo$",function(e,o,t,n){var s=this;this.keyword="",this.books=[],this.hasMore=function(){return s.books.length<s.totalNum},this.totalNum=0,this.loadMore=function(){s.keyword.length>0&&t.searchBooks(s.keyword,s.books.length,10,function(o){if(s.totalNum=o.total,s.totalNum>0){for(var t=o.books,n=0;n<t.length;n++)s.books.push(Model.BookInfo["new"](t[n]));e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")}else alert("没有找到你想要的图书")})};var i=null;this.searchBtnOnClick=function(){s.loadMore(),o.cancel(i)},this.searchInputOnChange=function(){s.books=[],s.totalNum=0,o.cancel(i),i=o(function(){s.loadFromBookInfo(),s.searchBtnOnClick()},1e3)},this.loadFromBookInfo=function(){n.searchBook(s.keyword).done(function(o){s.books.unshiftArray(o),e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})}}]),angular.module("APP").run(["$templateCache",function(e){e.put("temp/dOneBookAsideInfoTemplate.html",'<div class="sixteen wide center aligned column"><div class="ui buttons"><a ng-href="../person/uploadOneUsedBook.html?isbn13={{isbn13}}" class="ui button">上传旧书</a><div class="or"></div><a ng-href="../person/uploadOneNeedBook.html?isbn13={{isbn13}}" class="ui positive button">发布求书</a></div></div><div class="sixteen wide column"><div class="ui horizontal divider"><a class="ui circular button">网购新书比价</a></div><div class="ui selection list"><a class="item" ng-repeat="one in businessInfos | orderBy:\'price\'" ng-href="{{one.url}}" target="_blank"><img class="ui avatar image" ng-src="{{one.logoUrl}}"><div class="content"><h3 class="header"><em>{{one.price}}</em><i class="yen icon"></i><em>{{one.name}}</em></h3></div></a></div><div class="ui horizontal divider"><a class="ui circular button">要卖对应旧书的同学</a></div><div class="ui selection list"><div class="item" ng-repeat="one in UsedBook$.ISBN_sell.nowEqualISBNUsedBooks"><img class="ui avatar image" ng-src="{{one.attributes.owner.avatarUrlWithSize(64)}}"><div class="content"><h3 class="header"><em ng-if="one.attributes.price">{{one.attributes.price}}<i class="yen icon"></i></em> <em ng-if="one.attributes.des">{{one.attributes.des}}</em></h3><em ng-if="one.updatedAt">{{one.updatedAt | date:\'mediumDate\' }}</em></div></div></div><div class="ui message" ng-if="UsedBook$.ISBN_sell.nowEqualISBNUsedBooks.length==0">还没有对应的二手书</div><div class="ui horizontal divider"><a class="ui circular button">正需要这本书的同学</a></div><div class="ui selection list"><div class="item" ng-repeat="one in UsedBook$.ISBN_need.nowEqualISBNNeedBooks"><img class="ui avatar image" ng-src="{{one.attributes.owner.avatarUrlWithSize(64)}}"><div class="content"><h3 class="header"><em ng-if="one.attributes.price">{{one.attributes.price}}<i class="yen icon"></i></em> <em ng-if="one.attributes.des">{{one.attributes.des}}</em></h3><em ng-if="one.updatedAt">{{one.updatedAt | date:\'mediumDate\' }}</em></div></div></div><div class="ui message" ng-if="UsedBook$.ISBN_need.nowEqualISBNNeedBooks.length==0">还没有同学想要它</div><div class="ui horizontal divider"><a class="ui circular button">豆瓣书评</a></div><div class="ui selection list"><div class="item" ng-repeat="one in BookReview.reviewList"><img class="ui avatar image" ng-src="{{one.avatarUrl}}"><div class="content"><h3 class="header">{{one.title}}</h3><p class="description">{{one.context}}</p></div></div></div><div class="ui message" ng-if="BookReview.reviewList.length==0">还没有书评</div></div>'),e.put("temp/dOneUsedBookAsideInfoTemplate.html",'<div class="sixteen wide column"><div class="ui grid"><div class="ui horizontal divider"><a class="ui circular button">主人信息</a></div><div class="ui sixteen wide column"><div class="ui list"><div class="item"><img class="ui avatar image" ng-src="{{owner.avatarUrlWithSize(64)}}"><div class="content"><h3 class="header">{{owner.attributes.nickName}} <i class="icon blue man" ng-if="owner.attributes.sex==1"></i> <i class="icon red woman" ng-if="owner.attributes.sex==2"></i></h3></div></div><div class="item"><div class="content"><h4 class="header">学校</h4><p class="description">{{owner.attributes.school}}</p></div></div><div class="item"><div class="content"><h4 class="header">专业</h4><p class="description">{{owner.attributes.major}}</p></div></div></div></div><div class="ui horizontal divider" ng-if="needUsedBooks.length>0"><a class="ui circular button">主人正需要的书</a></div><div class="ui grid" ng-if="needUsedBooks.length>0"><div class="one column row"><d-one-used-book class="column" ng-repeat="needBook in needUsedBooks" used-book="needBook"></d-one-used-book></div></div><div class="ui horizontal divider" ng-if="sellUsedBooks.length>0"><a class="ui circular button">主人其它要卖旧书</a></div><div class="ui grid" ng-if="sellUsedBooks.length>0"><div class="one column row"><d-one-used-book class="column" ng-repeat="usedBook in sellUsedBooks" used-book="usedBook"></d-one-used-book></div></div></div></div>'),e.put("temp/footer.html",'<div class="center aligned sixteen wide column" style="color: #48af5a"><div><i class="wechat link icon"></i> <i class="qq link icon"></i> <i class="weibo link icon"></i></div><small>还地球一片绿色</small></div>'),e.put("temp/header.html",'<header class="ui fixed green inverted menu" ng-controller="d_topBar"><a class="item" ng-href="../book/recommend.html"><img src="../../img/pathLogo.png" class="ui mini image"></a> <span ng-if="me"><a class="item" href="../person/uploadOneUsedBook.html"><i class="home icon"></i>上传旧书</a> <a class="item" href="../person/uploadOneNeedBook.html"><i class="mail icon"></i>发布求书</a> <span class="ui dropdown item" ng-if="Status$.unreadCountSum()>0"><i class="mail icon"></i> <span class="ui red circular mini label">{{Status$.unreadCountSum()}}</span> <span class="menu"><a class="item" ng-if="Status$.NewUsedBookStatus.unreadCount>0" ng-href="../person/statusList.html">你关注的同学新上传了旧书 <span class="ui red circular mini label">{{Status$.NewUsedBookStatus.unreadCount}}</span></a> <a class="item" ng-if="Status$.NewNeedBookStatus.unreadCount>0" ng-href="../person/statusList.html">你关注的同学新发布了求书 <span class="ui red circular mini label">{{Status$.NewNeedBookStatus.unreadCount}}</span></a> <a class="item" ng-if="Status$.PrivateStatus.unreadCount>0" ng-href="../person/statusList.html">有同学给你发私信 <span class="ui red circular mini label">{{Status$.PrivateStatus.unreadCount}}</span></a> <a class="item" ng-if="Status$.ReviewUsedBookStatus.unreadCount>0" ng-href="../person/statusList.html">有同学评价你的书 <span class="ui red circular mini label">{{Status$.ReviewUsedBookStatus.unreadCount}}</span></a></span></span> <span class="ui dropdown item"><img ng-src="{{me.avatarUrlWithSize(46)}}" class="ui avatar mini image" style="display: inline"> {{me.attributes.nickName}} <i class="dropdown icon"></i> <span class="menu"><a class="item" ng-click="logOut()"><i class="sign out icon"></i>退出</a></span></span></span> <span ng-if="!me"><span class="item"><a class="ui button" href="../tool/hello.html">登入</a></span> <span class="item"><a class="ui button" href="../tool/hello.html">加入</a></span></span> <span class="right item"><span class="ui action fluid input" id="topSearchInputCon" style="width: 300px"><input type="text" placeholder="搜索图书" ng-model="SearchBook$.keyword" ng-change="SearchBook$.searchInputOnChange()"> <a class="ui inverted button" ng-click="SearchBook$.searchBtnOnClick()" ng-href="../book/searchList.html?keyword={{SearchBook$.keyword}}">搜索</a></span> <span class="ui flowing fluid popup"><span class="ui divided selection list"><span class="item" ng-repeat="bookInfo in SearchBook$.books"><img class="ui avatar image" ng-src="{{bookInfo.attributes.image}}"> <a class="content" ng-href="../book/oneBook.html?isbn13={{bookInfo.attributes.isbn13}}"><p class="header">{{bookInfo.attributes.title}}</p><p class="sub header"><em>{{bookInfo.attributes.author.toString()}}</em> <em><i class="ui yen icon"></i>{{bookInfo.attributes.price}}</em></p><p class="description"><em>{{bookInfo.attributes.publisher}}</em> <em>{{bookInfo.attributes.pubdate}}</em></p></a></span></span></span></span></header>'),e.put("temp/nearUserList.html",'<div class="sixteen wide column" ng-controller="d_partials_NearUser"><div class="ui horizontal divider"><a class="ui circular button" href="/">附近的同学</a></div><d-user-info style="margin: 2px" ng-repeat="one in users.slice(0,20)" user="one"></d-user-info></div>'),e.put("temp/usedBookCommentsTemplate.html",'<div class="ui comments"><h3 class="ui dividing header">大家都说</h3><div class="comment" ng-repeat="status in statusList"><a class="avatar"><img ng-src="{{status.attributes.source.avatarUrlWithSize(64)}}"></a><div class="content"><a ng-href="../userHome.html?userObjectId={{status.attributes.source.id}}" class="author">{{status.attributes.source.attributes.nickName}}</a><div class="metadata"><span class="date">{{status.updatedAt | date:\'mediumDate\'}}</span></div><div class="text">{{status.attributes.message}}</div><div class="actions"><a class="reply" ng-href="../tool/userHome.html?userObjectId={{status.attributes.to.id}}">{{status.attributes.to.attributes.nickName}}</a></div></div></div><div class="ui segment" ng-if="statusList.length==0">还没有评论,快来抢沙发</div><form class="ui reply form"><div class="field"><label><textarea ng-model="msg.text" placeholder="对主人说点什么~"></textarea></label></div><div class="ui blue labeled submit icon button" ng-disabled="AV.User.current()" ng-click="submitReview()"><i class="icon edit"></i>发表评论</div><div class="ui blue labeled icon button" ng-if="!AV.User.current()"><i class="icon user"></i>先登入</div></form></div>'),e.put("temp/userInfoTemplate.html",'<div class="ui card"><div class="content" ng-if="heUsedBookList.length>=2"><div class="ui two column center aligned grid"><div class="column" ng-repeat="one in heUsedBookList.slice(0,2)"><a class="ui small image" ng-href="oneUsedBook.html?usedBookObjectId={{one.id}}&role={{one.attributes.role}}"><img ng-src="{{one.attributes.image}}"></a> <small>{{one.attributes.title}}</small></div></div></div><a class="extra content" ng-href="../tool/userHome.html?userObjectId={{user.id}}"><div class="left floated meta"><em>{{user.attributes.major}}</em><br><em>{{user.attributes.school}}</em></div><div class="right floated author"><em><i class="ui icon blue man" ng-if="user.attributes.sex==1"></i> <i class="ui icon red woman" ng-if="user.attributes.sex==2"></i></em> <strong>{{user.attributes.nickName}}</strong> <img class="ui avatar image" ng-src="{{user.avatarUrlWithSize(64)}}"></div></a><div class="ui bottom attached tiny basic buttons" ng-if="!hideUsedBook"><a class="ui button" ng-href="../tool/userHome.html?userObjectId={{user.id}}">要卖<em>{{userUsedBookNumber}}</em>本书</a> <a class="ui button" ng-href="../tool/userHome.html?userObjectId={{user.id}}">需要<em>{{userNeedBookNumber}}</em>本书</a> <button class="ui button" ng-if="!isMyFollowee" ng-click="User$.followUser(user.id)">关注</button> <button class="ui button" ng-if="isMyFollowee" ng-click="User$.unfollowUser(user.id)">不关注</button></div></div>'),e.put("temp/oneBook.html",'<div class="ui blue card hasPubInfoPopupBook"><a class="image" ng-href="oneBook.html?isbn13={{bookInfo.attributes.isbn13}}"><img ng-src="{{bookInfo.attributes.bigImage}}"></a><div class="content"><h1 class="header">{{bookInfo.attributes.title}}</h1><div class="meta"><em>{{bookInfo.attributes.price}}</em> <em>{{bookInfo.attributes.publisher}}/{{bookInfo.attributes.pubdate}}</em></div></div></div><div class="ui popup"><div class="ui list"><div class="item"><div class="header">作者</div>{{bookInfo.attributes.author}}</div><div class="item"><div class="header">出版社</div>{{bookInfo.attributes.publisher}}</div><div class="item"><div class="header">出版日期</div>{{bookInfo.attributes.pubdate}}</div><div class="item"><div class="header">页数</div>{{bookInfo.attributes.page}}</div><div class="item"><div class="header">定价</div>{{bookInfo.attributes.price}}</div><div class="item"><div class="header">装帧</div>{{bookInfo.attributes.binding}}</div><div class="item"><div class="header">ISBN</div>{{bookInfo.attributes.isbn13}}</div></div></div>'),e.put("temp/oneNeedBook.html",'<div class="ui orange card hasPubInfoPopupBook"><a class="image" ng-href="../book/oneUsedBook.html?usedBookObjectId={{needBook.id}}"><img ng-src="{{needBook.attributes.info.attributes.bigImage}}"></a><div class="content"><h1 class="header">{{needBook.attributes.info.attributes.title}}</h1><div class="meta"><i class="yen icon"></i><em>{{needBook.attributes.price}}</em> <em>{{needBook.attributes.info.attributes.publisher}}/{{needBook.attributes.info.attributes.pubdate}}</em></div><div class="description">{{needBook.attributes.des}}</div></div><div class="ui bottom attached tiny basic buttons" ng-if="AV.User.current() && AV.User.current().id==needBook.attributes.owner.id"><button class="ui button" ng-click="UsedBook$.removeUsedBook(needBook)">删除</button> <button class="ui button">编辑</button></div></div><div class="ui popup"><div class="ui list"><div class="item"><div class="header">作者</div>{{needBook.attributes.info.attributes.author}}</div><div class="item"><div class="header">出版社</div>{{needBook.attributes.info.attributes.publisher}}</div><div class="item"><div class="header">出版日期</div>{{needBook.attributes.info.attributes.pubdate}}</div><div class="item"><div class="header">页数</div>{{needBook.attributes.info.attributes.page}}</div><div class="item"><div class="header">定价</div>{{needBook.attributes.info.attributes.price}}</div><div class="item"><div class="header">装帧</div>{{needBook.attributes.info.attributes.binding}}</div><div class="item"><div class="header">ISBN</div>{{needBook.attributes.info.attributes.isbn13}}</div></div></div>'),e.put("temp/oneUsedBook.html",'<div class="ui green card hasPubInfoPopupBook"><a class="image" ng-href="../book/oneUsedBook.html?usedBookObjectId={{usedBook.id}}"><img ng-src="{{usedBook.attributes.info.attributes.bigImage}}"></a><div class="content"><h1 class="header">{{usedBook.attributes.info.attributes.title}}</h1><div class="meta"><i class="yen icon"></i><em>{{usedBook.attributes.price}}</em> <em>{{usedBook.attributes.info.attributes.publisher}}/{{usedBook.attributes.info.attributes.pubdate}}</em></div><div class="description">{{usedBook.attributes.des}}</div></div><div class="ui bottom attached tiny basic buttons" ng-if="AV.User.current() && AV.User.current().id==usedBook.attributes.owner.id"><button class="ui button" ng-click="UsedBook$.removeUsedBook(usedBook)">删除</button> <button class="ui button">编辑</button></div></div><div class="ui popup"><div class="ui list"><div class="item"><div class="header">作者</div>{{usedBook.attributes.info.attributes.author}}</div><div class="item"><div class="header">出版社</div>{{usedBook.attributes.info.attributes.publisher}}</div><div class="item"><div class="header">出版日期</div>{{usedBook.attributes.info.attributes.pubdate}}</div><div class="item"><div class="header">页数</div>{{usedBook.attributes.info.attributes.page}}</div><div class="item"><div class="header">定价</div>{{usedBook.attributes.info.attributes.price}}</div><div class="item"><div class="header">装帧</div>{{usedBook.attributes.info.attributes.binding}}</div><div class="item"><div class="header">ISBN</div>{{usedBook.attributes.info.attributes.isbn13}}</div></div></div>')}]),APP.service("Status$",["$rootScope",function(e){var o=this;this.unreadCountSum=function(){return o.NewUsedBookStatus.unreadCount+o.NewNeedBookStatus.unreadCount+o.PrivateStatus.unreadCount+o.ReviewUsedBookStatus.unreadCount},this.loadUnreadStatusesCount=function(){var t=AV.User.current();t&&(AV.Status.countUnreadStatuses(t,"newUsedBook").done(function(t){o.NewUsedBookStatus.unreadCount=t.unread,e.$apply()}),AV.Status.countUnreadStatuses(t,"newNeedBook").done(function(t){o.NewNeedBookStatus.unreadCount=t.unread,e.$apply()}),AV.Status.countUnreadStatuses(t,"private").done(function(t){o.PrivateStatus.unreadCount=t.unread,e.$apply()}),AV.Status.countUnreadStatuses(t,"reviewUsedBook").done(function(t){o.ReviewUsedBookStatus.unreadCount=t.unread,e.$apply()}))},this.NewUsedBookStatus={unreadCount:0,statusList:[],load:function(){var t=AV.Status.inboxQuery(AV.User.current(),"newUsedBook");t.include("usedBook"),t.include("source"),t.limit(o.NewUsedBookStatus.unreadCount),t.find().done(function(t){o.NewUsedBookStatus.statusList.length=0;for(var n=0;n<t.length;n++){var s=t[n];s.attributes=s.data,o.NewUsedBookStatus.statusList.push(s)}o.NewUsedBookStatus.unreadCount=0,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})}},this.NewNeedBookStatus={unreadCount:0,statusList:[],load:function(){var t=AV.Status.inboxQuery(AV.User.current(),"newNeedBook");t.include("usedBook"),t.include("source"),t.limit(o.NewNeedBookStatus.unreadCount),t.find().done(function(t){o.NewNeedBookStatus.statusList.length=0;for(var n=0;n<t.length;n++){var s=t[n];s.attributes=s.data,o.NewNeedBookStatus.statusList.push(s)}o.NewNeedBookStatus.unreadCount=0,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})}},this.PrivateStatus={unreadCount:0,statusList:[],load:function(){var t=AV.Status.inboxQuery(AV.User.current(),"private");t.include("usedBook"),t.include("source"),t.limit(o.PrivateStatus.unreadCount),t.find().done(function(t){o.PrivateStatus.statusList.length=0;for(var n=0;n<t.length;n++){var s=t[n];s.attributes=s.data,o.PrivateStatus.statusList.push(s)}o.PrivateStatus.unreadCount=0,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})}},this.ReviewUsedBookStatus={unreadCount:0,statusList:[],load:function(){var t=AV.Status.inboxQuery(AV.User.current(),"reviewUsedBook");t.include("usedBook"),t.include("source"),t.limit(o.ReviewUsedBookStatus.unreadCount),t.find().done(function(t){o.ReviewUsedBookStatus.statusList.length=0;for(var n=0;n<t.length;n++){var s=t[n];s.attributes=s.data,o.ReviewUsedBookStatus.statusList.push(s)}o.ReviewUsedBookStatus.unreadCount=0,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})}},this.sendPrivateMsg=function(e,o,t,n){var s=new AV.Status(null,o);return s.set("to",AV.Object.createWithoutData("_User",e)),n&&s.set("usedBook",AV.Object.createWithoutData("UsedBook",n)),s.set("role",t),AV.Status.sendPrivateStatus(s,e)},this.reviewUsedBook=function(e,o,t,n){var s=new AV.Promise(null),i=new AV.Query(Model.UsedBook);return i.select("owner"),i.get(o).done(function(o){var a=o.get("owner");i=new AV.Query(Model.User),i.equalTo("objectId",a.id);var r=new AV.Status(null,t);r.query=i,r.inboxType="reviewUsedBook",r.set("to",AV.Object.createWithoutData("_User",e)),r.set("role",n),r.set("usedBook",o),r.send().done(function(e){e.attributes=e.data,s.resolve(e)}).fail(function(e){s.reject(e)})}).fail(function(e){s.reject(e)}),s},this.getStatusList_reviewBook=function(e){var o=new AV.Query(Model.Status),t=AV.Object.createWithoutData("UsedBook",e);return o.equalTo("inboxType","reviewUsedBook"),o.equalTo("usedBook",t),o.include("source","to"),o.find()},this.makeQueryStatusList_twoUser=function(e,o){if(e){var t=AV.User.current(),n=AV.Object.createWithoutData("_User",e),s=new AV.Query(Model.Status);s.equalTo("source",t),s.equalTo("to",n);var i=new AV.Query(Model.Status);if(i.equalTo("source",n),i.equalTo("to",t),o){var a=AV.Object.createWithoutData("UsedBook",o);s.equalTo("usedBook",a),i.equalTo("usedBook",a)}return AV.Query.or(s,i)}return new AV.Error(1,"缺少avosUserId")},this.cleanMyInbox=function(e,t,n){var s=AV.User.current(),i=AV.Status.inboxQuery(s,e);t&&i.equalTo("usedBook",AV.Object.createWithoutData("UsedBook",t)),n&&i.equalTo("source",AV.Object.createWithoutData("_User",n)),i.find().done(function(){o.loadUnreadStatusesCount()})}}]),APP.service("UsedBook$",["$rootScope",function(e){var o=this;this.isLoading=!1,this.loadUsedBookListForOwner=function(e){var o=e.relation("usedBooks").query();return o.equalTo("role","sell"),o.find()},this.loadNeedBookListForOwner=function(e){var o=e.relation("usedBooks").query();return o.equalTo("role","need"),o.find()},this.myUsedBookList=[],this.loadMyUsedBookList=function(){o.isLoading=!0;var t=AV.User.current().relation("usedBooks").query();t.equalTo("role","sell"),t.descending("updatedAt"),t.find().done(function(e){o.myUsedBookList.length=0,o.myUsedBookList.pushArray(e)}).always(function(){o.isLoading=!1,e.$apply()})},this.myNeedBookList=[],this.loadMyNeedBookList=function(){o.isLoading=!0;var t=AV.User.current().relation("usedBooks").query();t.equalTo("role","need"),
t.descending("updatedAt"),t.find().done(function(e){o.myNeedBookList.length=0,o.myNeedBookList.pushArray(e)}).always(function(){o.isLoading=!1,e.$apply()})},this.removeUsedBook=function(e){var t=e.get("role");window.confirm("你确定要删除它吗?将不可恢复")&&e.destroy().done(function(){"sell"==t?o.loadMyUsedBookList():"need"==t&&o.loadMyNeedBookList()}).fail(function(e){alert(e.message)})},this.ISBN_sell={getUsedBookNumberEqualISBN:function(e){var o=new AV.Query(Model.UsedBook);return o.equalTo("role","sell"),o.equalTo("isbn13",e),o.count()},nowISBN13:"",nowEqualISBNUsedBooks:[],loadMoreUsedBookEqualISBN:function(t){o.isLoading=!0,t!=o.ISBN_sell.nowISBN13&&(o.ISBN_sell.nowISBN13=t,o.ISBN_sell.nowEqualISBNUsedBooks=[],o.ISBN_sell.hasMoreFlag=!0);var n=new AV.Query(Model.UsedBook);n.equalTo("isbn13",o.ISBN_sell.nowISBN13),n.equalTo("role","sell"),n.descending("updatedAt"),n.skip(o.ISBN_sell.nowEqualISBNUsedBooks.length),n.limit(5),n.include("owner"),n.find().done(function(e){e.length>0?o.ISBN_sell.nowEqualISBNUsedBooks.pushArray(e):o.ISBN_sell.hasMoreFlag=!1}).always(function(){o.isLoading=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMoreFlag:!0,hasMore:function(){return o.ISBN_sell.hasMoreFlag}},this.ISBN_need={getNeedBookNumberEqualISBN:function(e){var o=new AV.Query(Model.UsedBook);return o.equalTo("role","need"),o.equalTo("isbn13",e),o.count()},nowISBN13:"",nowEqualISBNNeedBooks:[],loadMoreNeedBookEqualISBN:function(t){o.isLoading=!0,t!=o.ISBN_need.nowISBN13&&(o.ISBN_need.nowISBN13=t,o.ISBN_need.nowEqualISBNNeedBooks=[],o.ISBN_need.hasMoreFlag=!0);var n=new AV.Query(Model.UsedBook);n.equalTo("isbn13",o.ISBN_need.nowISBN13),n.equalTo("role","need"),n.descending("updatedAt"),n.skip(o.ISBN_need.nowEqualISBNNeedBooks.length),n.limit(5),n.include("owner"),n.find().done(function(e){e.length>0?o.ISBN_need.nowEqualISBNNeedBooks.pushArray(e):o.ISBN_need.hasMoreFlag=!1}).always(function(){o.isLoading=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMoreFlag:!0,hasMore:function(){return o.ISBN_need.hasMoreFlag}}}]),APP.service("User$",["$rootScope","Status$",function(e,o){var t=this;this.signUpWithJSONUser=function(e){var o=e.unionId;delete e.unionId;var t=Model.User["new"](e);return t.set("username",o),t.set("password",o),t.signUp(null)},this.followUser=function(o){var t=AV.User.current();t?t.follow(o).done(function(){e.$broadcast("FollowSomeone")}).fail(function(e){alert("关注失败:"+e.message)}):alert("请先登入")},this.unfollowUser=function(o){var t=AV.User.current();t?t.unfollow(o).done(function(){e.$broadcast("UnfollowSomeone")}).fail(function(e){alert("取消关注失败:"+e.message)}):alert("请先登入")},this.Followee={users:[],loadMore:function(){var o=AV.User.current().followeeQuery();if(o.include("followee"),o.skip(t.Followee.users.length),o.limit(10),t.Followee._majorFilter){var n=new AV.Query(Model.User);n.equalTo("major",t.Followee._majorFilter),o.matchesQuery("followee",n)}o.find().done(function(o){if(o.length>0){for(var n=0;n<o.length;n++)o[n].avatarUrlWithSize=Model.User.prototype.avatarUrlWithSize;t.Followee.users.pushArray(o)}else t.Followee.hasMoreFlag=!1;e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMoreFlag:!0,hasMore:function(){return t.Followee.hasMoreFlag},_majorFilter:null,setMajorFilter:function(e){e!=t.Followee._majorFilter&&(t.Followee.users.length=0,t.Followee.hasMoreFlag=!0,t.Followee._majorFilter=e,t.Followee.loadMore())},getMajorFilter:function(){return t.Followee._majorFilter}},this.Follower={users:[],loadMore:function(){var o=AV.User.current().followerQuery();if(o.include("follower"),o.skip(t.Follower.users.length),o.limit(10),t.Follower._majorFilter){var n=new AV.Query(Model.User);n.equalTo("major",t.Follower._majorFilter),o.matchesQuery("follower",n)}o.find().done(function(o){if(o.length>0){for(var n=0;n<o.length;n++)o[n].avatarUrlWithSize=Model.User.prototype.avatarUrlWithSize;t.Follower.users.pushArray(o)}else t.Follower.hasMoreFlag=!1;e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMoreFlag:!0,hasMore:function(){return t.Follower.hasMoreFlag},_majorFilter:null,setMajorFilter:function(e){e!=t.Follower._majorFilter&&(t.Follower.users.length=0,t.Follower.hasMoreFlag=!0,t.Follower._majorFilter=e,t.Follower.loadMore())},getMajorFilter:function(){return t.Follower._majorFilter}},this.loginWithUnionId=function(e){var t=new AV.Promise(null);return e?AV.User.logIn(e,e).done(function(e){t.resolve(e),o.loadUnreadStatusesCount()}).fail(function(e){t.reject(e)}):t.reject("unionId错误"),t},this.getOAuthUserInfo=function(e){var o=new AV.Promise(null);return e?AV.Cloud.run("getWechatOAuthUserInfo",{code:e},null).done(function(e){var t={openId:e.openid,unionId:e.unionid,nickName:e.nickname,sex:e.sex,avatarUrl:e.headimgurl};createCookie("unionId",t.unionId,365),o.resolve(t)}).fail(function(e){o.reject(e)}):o.reject("不合法的code"),o},this.updateMyInfoWithJson=function(e){var o=new AV.Promise(null),n=readCookie("unionId");return t.loginWithUnionId(n).done(function(t){for(var n in e)t.set(n,e[n]);t.save().done(function(){o.resolve(t)}).fail(function(e){o.reject(e)})}).fail(function(e){o.reject(e)}),o}}]),APP.service("WeChatJS$",["$rootScope",function(e){function o(e){var o={title:"书循",desc:"让你的课本重复利用",link:window.location.href,imgUrl:"http://"+window.location.host+"/wechat/img/logo-R.png"};return o=angular.extend(o,e)}var t=this;this.config=function(){AV.Cloud.run("getWechatJsConfig",{url:location.href.split("#")[0]},null).done(function(e){wx.config(e)})},wx.ready(function(){wx.onMenuShareTimeline(o()),wx.onMenuShareAppMessage(o()),wx.onMenuShareQQ(o()),wx.onMenuShareWeibo(o()),wx.getLocation({success:function(e){AV.Cloud.run("updateMyLocation",{latitude:e.latitude,longitude:e.longitude},null)},fail:function(){AV.Cloud.run("updateMyLocation",null,null)},cancel:function(){AV.Cloud.run("updateMyLocation",null,null)}})}),wx.error(function(){t.config()}),this.scanQRCode=function(o){wx.scanQRCode({needResult:1,scanType:["barCode"],success:function(t){o(t.resultStr.split(",")[1]),e.$apply()}})},this.previewOneImage=function(e){wx.previewImage({current:e,urls:[e]})},this.getOAuthURL=function(){var e=location.href.split("#")[0]+"#/tab/signUp";return"https://open.weixin.qq.com/connect/oauth2/authorize?appid="+WECHAT.AppID+"&redirect_uri="+encodeURIComponent(e)+"&response_type=code&scope=snsapi_base&state=#wechat_redirect"},this.openMap=function(e,o){jsonp("http://apis.map.qq.com/ws/coord/v1/translate?type=1&key=R3DBZ-HEYRF-ZSZJ3-JAJJN-2ZWFF-SLBJV&output=jsonp&locations="+e+","+o,function(e){if(0==e.status){var o=e.locations[0];wx.openLocation({latitude:o.lat,longitude:o.lng,name:"该同学位置"})}})}}]),APP.controller("d_book_recommend",["$scope","BookRecommend$","BookInfo$",function(e,o,t){e.BookRecommend$=o,e.BookInfo$=t,t.LatestBook.loadMore(),o.NearUsedBook.loadMore(),o.NearNeedBook.loadMore(),o.MajorBook.loadMore()}]),APP.controller("d_book_searchList",["$scope","SearchBook$",function(e,o){e.SearchBook$=o;var t=getQueryParameterByName("keyword");t&&(o.keyword=t,o.searchBtnOnClick())}]),APP.controller("d_partials_NearUser",["$scope","BookRecommend$",function(e,o){o.NearUser.loadMore(),e.users=o.NearUser.users}]),APP.controller("d_person_needBookList",["$scope","UsedBook$",function(e,o){e.UsedBook$=o,o.loadMyNeedBookList()}]),APP.controller("d_person_statusList",["Status$",function(e){e.loadUnreadStatusesCount(),e.NewUsedBookStatus.load(),e.NewNeedBookStatus.load(),e.PrivateStatus.load(),e.ReviewUsedBookStatus.load()}]),APP.controller("d_person_uploadOneUsedBook",["$scope","$location","DoubanBook$","InfoService$",function(e,o,t,n){function s(){t.getBookByISBD_simple(e.usedBookInfo.isbn13,function(o){o?(e.bookInfo=Model.BookInfo["new"](o),e.usedBookInfo.isbn13=o.isbn13,e.usedBookInfo.image=o.image.replace("mpic","lpic"),e.usedBookInfo.title=o.title,e.$apply()):alert("没有找到图书信息,再去搜搜看~")})}e.AV=AV;var i=getQueryParameterByName("isbn13");e.step=i?"info":"search",e.usedBookInfo={owner:AV.User.current(),isbn13:i,price:null,des:"",image:"",title:""},e.usedBookInfo.isbn13&&s(),e.submitOnClick=function(){e.usedBookInfo.role=e.role;var o=Model.UsedBook["new"](e.usedBookInfo);o.save(null).done(function(){e.step="ok"}).fail(function(e){alert(e.message)}).always(function(){e.$apply()})},e.InfoService$=n}]),APP.controller("d_person_usedBookList",["$scope","UsedBook$",function(e,o){e.UsedBook$=o,o.loadMyUsedBookList()}]),APP.controller("d_tool_hello",["$scope","User$","Status$",function(e,o,t){o.loginWithUnionId(readCookie("unionId")).done(function(){t.loadUnreadStatusesCount(),window.location.href="userHome.html?userObjectId="+AV.User.current().id})}]),APP.controller("d_tool_signUp",["$scope","$location","User$","Status$","InfoService$",function(e,o,t,n,s){e.startSchoolYearOptions=s.startSchoolYearOptions,e.majors=s.majors,s.School.loadMore(),e.schools=s.School.schools;var i=o.search().code;e.step="subscribe",t.getOAuthUserInfo(i).done(function(o){e.userInfo=o,t.loginWithUnionId(o.unionId).done(function(){n.loadUnreadStatusesCount(),t.updateMyInfoWithJson(o),e.step="ok"})}).fail(function(){alert("要先关注书循微信号哦"),e.step="subscribe"}).always(function(){e.$apply()}),e.submitOnClick=function(){t.signUpWithJSONUser(e.userInfo).done(function(){e.step="ok",e.$apply()}).fail(function(e){alert(e.message)})}}]),APP.controller("d_tool_userHome",["$scope","UsedBook$",function(e,o){var t=getQueryParameterByName("userObjectId");e.UsedBook$=o;var n=new AV.Query(Model.User);n.get(t).done(function(t){e.owner=t,o.loadUsedBookListForOwner(t).done(function(o){e.usedBooks=o,e.$apply()}),o.loadNeedBookListForOwner(t).done(function(o){e.needBooks=o,e.$apply()})})}]),APP.controller("d_topBar",["$scope","SearchBook$","Status$",function(e,o,t){e.Status$=t,e.SearchBook$=o,e.me=AV.User.current(),e.logOut=function(){AV.User.logOut(),eraseCookie("unionId"),window.location.reload()}}]),APP.directive("dIncludeReplace",function(){return{require:"ngInclude",restrict:"A",link:function(e,o){o.replaceWith(o.children())}}}),APP.directive("dOneBook",function(){return{restrict:"E",scope:{bookInfo:"="},templateUrl:"../hbsPartial/oneBook.html"}}),APP.directive("dOneBookAsideInfo",["BusinessSite$","UsedBook$","User$","DoubanBook$",function(e,o,t,n){function s(s){s.User$=t,s.BookReview=n.BookReview;var i=String(s.isbn13),a=String(s.doubanId);n.BookReview.nowBookId=a,e.getBusinessInfoByISBN(i).done(function(e){s.businessInfos=e,s.$apply()}),s.UsedBook$=o;var r=setInterval(function(){function e(){o.ISBN_sell.hasMore()||o.ISBN_need.hasMore()||clearInterval(r)}o.ISBN_sell.hasMore()?o.ISBN_sell.loadMoreUsedBookEqualISBN(i):e(),o.ISBN_need.hasMore()?o.ISBN_need.loadMoreNeedBookEqualISBN(i):e(),a&&s.BookReview.hasMore()?s.BookReview.loadMore():e()},500)}return{restrict:"E",scope:{isbn13:"=",doubanId:"="},templateUrl:"../temp/dOneBookAsideInfoTemplate.html",link:s}}]),APP.directive("dOneNeedBook",function(){function e(e,o){e.AV=AV,e.UsedBook$=o;var t=e.needBook.attributes.info;e.needBook.attributes.info&&!t.attributes.isbn13&&t.fetch().done(function(){e.$apply()})}return{restrict:"E",scope:{needBook:"="},templateUrl:"../hbsPartial/oneNeedBook.html",link:e}}),APP.directive("dOneUsedBook",function(){function e(e,o){e.AV=AV,e.UsedBook$=o;var t=e.usedBook.attributes.info;e.usedBook.attributes.info&&!t.attributes.isbn13&&t.fetch().done(function(){e.$apply()})}return{restrict:"E",scope:{usedBook:"="},templateUrl:"../hbsPartial/oneUsedBook.html",link:e}}),APP.directive("dOneUsedBookAsideInfo",function(){function e(e){var o=new AV.Query(Model.UsedBook);o.include("owner"),o.get(e.usedBookObjectId).done(function(o){e.usedBook=o,e.owner=o.get("owner"),e.$apply();var t=o.get("owner").relation("usedBooks").query();t.find().done(function(o){e.sellUsedBooks=[],e.needUsedBooks=[];for(var t=0;t<o.length;t++){var n=o[t],s=n.get("role");n.id!=e.usedBookObjectId&&("sell"==s?e.sellUsedBooks.push(n):"need"==s&&e.needUsedBooks.push(n))}e.$apply()})})}return{restrict:"E",scope:{usedBookObjectId:"="},templateUrl:"../temp/dOneUsedBookAsideInfoTemplate.html",link:e}}),APP.directive("dUsedBookComments",["Status$",function(e){function o(o){o.AV=AV,o.Status$=e,e.getStatusList_reviewBook(o.usedBookObjectId).done(function(e){o.statusList=e,o.$apply()}),o.msg={text:""},o.submitReview=function(){e.reviewUsedBook(o.ownerObjectId,o.usedBookObjectId,o.msg.text,"buy").done(function(e){o.statusList.push(e),o.msg.text="",o.$apply()}).fail(function(e){alert("发布评论失败:"+e.message)})}}return{restrict:"E",scope:{usedBookObjectId:"=",ownerObjectId:"="},templateUrl:"../temp/usedBookCommentsTemplate.html",link:o}}]),APP.directive("dUserInfo",["User$",function(e){function o(o){function t(){if(o.user){o.userUsedBookNumber=0;var e=AV.Object.createWithoutData("_User",o.user.id),t=e.relation("usedBooks").query();t.equalTo("role","sell"),t.count().done(function(e){o.userUsedBookNumber=e,o.$apply()})}}function n(){if(o.user){o.userNeedBookNumber=0;var e=AV.Object.createWithoutData("_User",o.user.id),t=e.relation("usedBooks").query();t.equalTo("role","need"),t.count().done(function(e){o.userNeedBookNumber=e,o.$apply()})}}function s(){if(o.user&&AV.User.current()){var e=AV.User.current().followeeQuery();e.equalTo("followee",AV.Object.createWithoutData("_User",o.user.id)),e.count().done(function(e){o.isMyFollowee=1==e,o.$apply()})}}function i(){if(o.user){var e=AV.Object.createWithoutData("_User",o.user.id),t=e.relation("usedBooks").query();t.limit(2),t.find().done(function(e){o.heUsedBookList=e,o.$apply()})}}o.User$=e,o.isMyFollowee=!1,o.heUsedBookList=[],o.$watch(function(){return o.user?o.user.attributes:null},function(){s(),(null==o.hideUsedBook||0==o.hideUsedBook)&&(t(),n(),!o.hideUsedBook&&i())}),o.$on("FollowSomeone",function(){s()}),o.$on("UnfollowSomeone",function(){s()})}return{restrict:"E",scope:{user:"=",hideUsedBook:"=?",usedBookObjectId:"=?"},templateUrl:"../temp/userInfoTemplate.html",link:o}}]);