"use strict";function jsonp(o,e){var n=document.createElement("script");n.type="text/javascript";var t=Date.now();n.src=o+(o.indexOf("?")>0?"&":"?")+"callback=CB"+t,n.onload=function(){n.parentNode.removeChild(n)},window["CB"+t]=function(o){e(o)},document.head.appendChild(n)}AV.initialize("kusn9e3cp5znt5lic9fufqfmsvsibsoaejpah089x6v2n7e0","nt5l8v4n4m08zxttpt7upqxwgt6oy47lzb3f8c4juf34otfm");var WECHAT={AppID:"wx2940a8d3ddcad5e9"},APP=angular.module("APP",["ionic"],null).config(["$stateProvider","$urlRouterProvider",function(o,e){ionic.Platform.setPlatform("ios"),o.state("tab",{url:"/tab","abstract":!0,templateUrl:"temp/tabs.html"}).state("tab.book_recommend",{url:"/book/recommend",views:{"tab-book":{templateUrl:"temp/book/recommend.html"}}}).state("tab.book_searchList",{url:"/book/searchList",views:{"tab-book":{templateUrl:"temp/book/searchList.html"}}}).state("tab.book_bookList",{url:"/book/bookList?cmd&title&tag",views:{"tab-book":{templateUrl:"temp/book/bookList.html"}}}).state("tab.book_usedBookList",{url:"/book/usedBookList?cmd&isbn13",views:{"tab-book":{templateUrl:"temp/book/usedBookList.html"}}}).state("tab.book_userList",{url:"/book/userList?cmd&title",views:{"tab-book":{templateUrl:"temp/book/userList.html"}}}).state("tab.book_oneBook",{url:"/book/oneBook/{isbn13}",views:{"tab-book":{templateUrl:"temp/book/oneBook.html"}}}).state("tab.book_usedBookListByOwner",{url:"/book/usedBookListByOwner/{ownerId}",views:{"tab-book":{templateUrl:"temp/book/usedBookListByOwner.html"}}}).state("tab.book_businessSite",{url:"/book/businessSite/{url}",views:{"tab-book":{templateUrl:"temp/book/businessSite.html"}}}).state("tab.book_oneUsedBook",{url:"/book/oneUsedBook/{usedBookAvosObjectId}",views:{"tab-book":{templateUrl:"temp/book/oneUsedBook.html"}}}).state("tab.person_editOneUsedBook",{url:"/person/editOneUsedBook/{indexInMyAvosUsedBook_notSell}",views:{"tab-person":{templateUrl:"temp/person/editOneUsedBook.html"}}}).state("tab.person_uploadOneUsedBook",{url:"/person/uploadOneUsedBook/{isbn13}",views:{"tab-person":{templateUrl:"temp/person/uploadOneUsedBook.html"}}}).state("tab.person_usedBooksList",{url:"/person/usedBookList",views:{"tab-person":{templateUrl:"temp/person/usedBookList.html"}}}).state("tab.person_signUp",{url:"/person/signUp?code",views:{"tab-person":{templateUrl:"temp/person/signUp.html"}}}).state("tab.person_editPersonInfo",{url:"/person/editPersonInfo",views:{"tab-person":{templateUrl:"temp/person/editPersonInfo.html"}}}).state("tab.person_my",{url:"/person/my",views:{"tab-person":{templateUrl:"temp/person/my.html"}}}),e.otherwise("/tab/book/recommend")}]);APP.service("DoubanBook$",function(){var o="http://api.douban.com/v2/book";this.getBookByISBD=function(e,n){var t=o+"/isbn/"+e;t+="?fields=rating,author,pubdate,image,binding,translator,catalog,pages,publisher,isbn13,title,author_intro,summary,price",jsonp(t,n)},this.getBookByISBD_simple=function(e,n){var t=o+"/isbn/"+e;t+="?fields=author,pubdate,image,publisher,title,price,isbn13",jsonp(t,n)},this.searchBooks=function(e,n,t,s){var r=o+"/search";return e&&e.length<1?[]:(r+="?q="+e,n&&(r+="&start="+n),t&&(r+="&count="+t),r+="&fields=isbn13,title,image,author,publisher,pubdate,price",void jsonp(r,function(o){s(o)}))},this.getBooksByTag=function(e,n,t,s){var r=o+"/search";return!e||e.length<1?[]:(r+="?tag="+e,n&&(r+="&start="+n),t&&(r+="&count="+t),r+="&fields=isbn13,title,image,author,publisher,pubdate,price",void jsonp(r,function(o){s(o)}))}}).service("SearchBook$",["$rootScope","DoubanBook$","$timeout",function(o,e,n){var t=this;this.keyword="",this.books=[],this.hasMore=function(){return t.books.length<t.totalNum},this.totalNum=0,this.loadMore=function(){t.keyword.length>0&&e.searchBooks(t.keyword,t.books.length,10,function(e){t.totalNum=e.total;for(var n=e.books,s=0;s<n.length;s++)t.books.push(n[s]);o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})};var s=null;this.searchBtnOnClick=function(){t.loadMore(),n.cancel(s)},this.searchInputOnChange=function(){t.books=[],t.totalNum=0,n.cancel(s),s=n(function(){t.searchBtnOnClick()},1e3)}}]).service("BookRecommend$",["$rootScope","DoubanBook$","User$","UsedBook$",function(o,e,n,t){var s=this;this.BookTag={tag:null,load:function(){jsonp("/info/getAllBookTags",function(e){s.BookTag.tag=e,o.$apply()})},getTagAttrNames:function(){return s.BookTag.tag?Object.keys(s.BookTag.tag):[]}},this.BookTag.load(),this.TagBook={nowTag:"",totalNum:0,setTag:function(o){o!=s.TagBook.nowTag&&(s.TagBook.books=[],s.TagBook.nowTag=o)},books:[],loadMore:function(){e.getBooksByTag(s.TagBook.nowTag,s.TagBook.books.length,5,function(e){s.TagBook.totalNum=e.total;for(var n=e.books,t=0;t<n.length;t++)s.TagBook.books.push(n[t]);o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return s.TagBook.books.length<s.TagBook.totalNum}},this.MajorBook={major:n.getCurrentJsonUser()?n.getCurrentJsonUser().major:"",books:[],loadMore:function(){e.getBooksByTag(s.MajorBook.major,s.MajorBook.books.length,5,function(e){s.MajorBook.totalNum=e.total;for(var n=e.books,t=0;t<n.length;t++)s.MajorBook.books.push(n[t]);o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return s.MajorBook.books.length<s.MajorBook.totalNum}},this.NeedBook={books:[],loadMore:function(){},hasMore:function(){}},this.NearBook={jsonBooks:[],hasMore:!0,loadMore:function(){var e=n.getCurrentUserLocation(),r=new AV.Query("UsedBook");e&&r.near("location",e),r.skip(s.NearBook.jsonBooks.length),r.limit(5),r.find().done(function(e){if(e.length>0)for(var n=0;n<e.length;n++)s.NearBook.jsonBooks.push(t.avosUsedBookToJson(e[n]));else s.NearBook.hasMore=!1;o.$apply()})}},this.NearUser={jsonUsers:[],loadMore:function(){var e=n.getCurrentUserLocation(),t=new AV.Query(AV.User);e&&t.near("location",e),t.skip(s.NearUser.jsonUsers.length),t.limit(5),t.find().done(function(e){if(e.length>0)for(var t=0;t<e.length;t++)s.NearUser.jsonUsers.push(n.avosUserToJson(e[t]));else s.NearUser.hasMore=!1;o.$apply()})},hasMore:!0},this.NearUser.loadMore()}]).service("BusinessSite$",function(){this.getBusinessInfoByISBN=function(o,e){e()}}).service("WeChatJS$",["$rootScope",function(o){function e(o){var e={title:document.title,desc:"关于书循的介绍",link:window.location.href,imgUrl:"http://"+window.location.host+"/img/logo-R.png"};return e=angular.extend(e,o)}var n=this;jsonp("/wechat/getJsConfig",function(o){wx.config(o)}),wx.getLocation({success:function(o){n.location=o}}),wx.onMenuShareTimeline(e()),wx.onMenuShareAppMessage(e()),wx.onMenuShareQQ(e()),wx.onMenuShareWeibo(e()),this.scanQRCode=function(e){wx.scanQRCode({needResult:1,success:function(n){e(n.resultStr.split(",")[1]),o.$apply()}})},this.chooseImage=function(e){wx.chooseImage({success:function(n){e(n.localIds[0]),o.$apply()}})},this.uploadImage=function(o,e){wx.uploadImage({localId:o,success:function(o){var n=o.serverId;e(n)}})},this.previewOneImage=function(o){wx.previewImage({current:o,urls:[o]})},this.getOAuthURL=function(){var o=location.href.split("#")[0]+"#tab/person/signUp";return"https://open.weixin.qq.com/connect/oauth2/authorize?appid="+WECHAT.AppID+"&redirect_uri="+encodeURIComponent(o)+"&response_type=code&scope=snsapi_userinfo&state=0#wechat_redirect"},this.getOAuthUserInfo=function(o,e){jsonp("/wechat/getOAuthUserInfo/"+o,function(o){var n={openId:o.openid,nickName:o.nickname,sex:o.sex,avatarUrl:o.headimgurl};e(n)})},this.openMap=function(o,e){wx.openLocation({latitude:o,longitude:e,name:"主人位置"})}}]).service("InfoService$",["$rootScope","$http","User$",function(o,e,n){var t=this;this.majors=[],e.jsonp("/info/getAllMajor?callback=JSON_CALLBACK").success(function(o){t.majors=o}),this.searchMajorKeyword="",this.filter_majorByKeyword=function(o){return o.name.indexOf(t.searchMajorKeyword)>-1},this.School={schools:[],loadMore:function(){var e=n.getCurrentUserLocation(),s=new AV.Query("School");e&&s.near("location",e),s.skip(t.School.schools.length),s.limit(5),s.find().done(function(e){if(e.length>0)for(var n=0;n<e.length;n++)t.School.schools.push(e[n].get("name"));else t.School.hasMore=!1;o.$apply()})},hasMore:!0,searchSchoolKeyword:"",filter_schoolByKeyword:function(o){return o.indexOf(t.School.searchSchoolKeyword)>=0}},this.startSchoolYearOptions=[];for(var s=(new Date).getFullYear(),r=s-6;s>=r;r++)t.startSchoolYearOptions.push(r.toString())}]).service("IonicModalView$",["$rootScope","$ionicModal","InfoService$","WeChatJS$","User$",function(o,e,n,t,s){this.registerChooseSchoolModalView=function(o,t){o.InfoService$=n,e.fromTemplateUrl("temp/tool/chooseSchoolModalView.html",{scope:o}).then(function(e){o.chooseSchoolModalView=e}),o.schoolOnChoose=function(e){t(e),o.chooseSchoolModalView.hide()}},this.registerChooseMajorModalView=function(o,t){o.InfoService$=n,e.fromTemplateUrl("temp/tool/chooseMajorModalView.html",{scope:o}).then(function(e){o.chooseMajorModalView=e}),o.majorOnChoose=function(e){t(e),o.chooseMajorModalView.hide()}},this.alertTitleAndPreModalView=function(n,t){var s=o.$new(!0);s.titleAndPreModalViewData={title:n,pre:t},e.fromTemplateUrl("temp/tool/titleAndPreModalView.html",{scope:s}).then(function(o){s.titleAndPreModalView=o,o.show()})},this.alertUserLoginModalView=function(n,r){var a=o.$new(!0);a.WeChatJS$=t,e.fromTemplateUrl("temp/tool/userLoginModalView.html",{scope:a}).then(function(o){a.userLoginModalView=o,a.userLoginModalView.show()}),a.title=n,a.loginInfo={email:null==s.getCurrentAvosUser()?"":s.getCurrentJsonUser().email,password:""},a.submitOnClick=function(){AV.User.logIn(a.loginInfo.email,a.loginInfo.password,{success:function(o){a.userLoginModalView.hide(),r(o)},error:function(o,e){alert("登入失败:"+e.message)}})}}}]).service("User$",function(){var o=this,e=["email","username","password","openId","unionId","nickName","avatarUrl","sex","school","major","startSchoolYear"];this.signUpWithJSONUser=function(e){var n=o.jsonToAvosUser(e);return n.set("username",e.email),n.signUp(null)},this.getCurrentUserLocation=function(){var e=o.getCurrentAvosUser();return e?e.get("location"):null},this.getCurrentAvosUser=function(){return AV.User.current()},this.getCurrentJsonUser=function(){var e=o.getCurrentAvosUser();return e?o.avosUserToJson(e):null},this.avosUserToJson=function(o){for(var n={},t=0;t<e.length;t++){var s=e[t];n[s]=o.get(s)}return n.objectId=o.id,n.location=o.get("location"),n},this.jsonToAvosUser=function(o){for(var n=new AV.User,t=0;t<e.length;t++){var s=e[t];n.set(s,o[s])}return n}}).service("UsedBook$",["$rootScope","HasSellUsedBook$",function(o,e){var n=this,t=["owner","isbn13","avosImageFile","price","des"];this.isLoading=!1,this.getUsedBookNumberForOwner=function(o){var e=new AV.Query("UsedBook"),n=new AV.User;return n.id=o,e.equalTo("owner",n),e.descending("updatedAt"),e.count()},this.loadUsedBookListForOwner=function(o){var e=new AV.Query("UsedBook");return e.equalTo("owner",o),e.descending("updatedAt"),e.find()},this.myAvosUsedBookList=[],this.loadMyAvosUsedBookList=function(){n.isLoading=!0;var e=new AV.Query("UsedBook");e.equalTo("owner",AV.User.current()),e.descending("updatedAt"),e.find().done(function(o){n.myAvosUsedBookList=o}).always(function(){n.isLoading=!1,o.$apply()})},this.removeUsedBook=function(o){window.confirm("你确定要删除它吗?")&&o.destroy().done(function(){n.loadMyAvosUsedBookList()}).fail(function(o){alert(o.message)})},this.usedBookHasSell=function(o){window.confirm("你确定它已经卖出了吗?")&&AV.Cloud.run("usedBookHasSell",{id:o.id},null).done(function(){n.loadMyAvosUsedBookList(),e.loadMyAvosUsedBookList()}).fail(function(o){alert(o.message)})},this.avosUsedBookToJson=function(o){for(var e={},n=0;n<t.length;n++){var s=t[n];e[s]=o.get(s)}return e.objectId=o.id,e.updatedAt=o.updatedAt,e},this.jsonUsedBookToAvos=function(o){for(var e=new AV.Object.extend("UsedBook"),n=new e,s=0;s<t.length;s++){var r=t[s];n.set(r,o[r])}return n},this.getJsonUsedBookByAvosObjectId=function(o,e){var t=new AV.Query("UsedBook");t.get(o).done(function(o){e(n.avosUsedBookToJson(o))})},this.getUsedBookNumberEqualISBN=function(o){var e=new AV.Query("UsedBook");return e.equalTo("isbn13",o),e.count()},this.ISBN={nowISBN13:"",nowEqualISBNJsonUsedBookList:[],loadMoreUsedBookEqualISBN:function(e){n.isLoading=!0,e!=n.ISBN.nowISBN13&&(n.ISBN.nowISBN13=e,n.ISBN.nowEqualISBNJsonUsedBookList=[]);var t=new AV.Query("UsedBook");t.equalTo("isbn13",n.ISBN.nowISBN13),t.descending("updatedAt"),t.skip(n.ISBN.nowEqualISBNJsonUsedBookList.length),t.limit(5),t.find().done(function(o){if(o.length>0)for(var e=0;e<o.length;e++)n.ISBN.nowEqualISBNJsonUsedBookList.push(n.avosUsedBookToJson(o[e]));else n.ISBN.hasMore=!1}).always(function(){n.isLoading=!1,o.$apply()})},hasMore:!0}}]).service("HasSellUsedBook$",["$rootScope",function(o){var e=this;this.myAvosUsedBookList=[],this.loadMyAvosUsedBookList=function(){var n=new AV.Query("HasSellUsedBook");n.equalTo("owner",AV.User.current()),n.find().done(function(o){e.myAvosUsedBookList=o}).always(function(){o.$apply()})},this.removeUsedBook=function(o){window.confirm("你确定要删除它吗?")&&o.destroy().done(function(){e.loadMyAvosUsedBookList()}).fail(function(o){alert(o.message)})}}]),APP.controller("book_recommend",["$scope","$ionicModal","BookRecommend$",function(o,e,n){o.BookRecommend$=n,n.MajorBook.loadMore(),n.NeedBook.loadMore(),n.NearBook.loadMore(),e.fromTemplateUrl("template/bookTags.html",{scope:o}).then(function(e){o.bookTagsModalView=e})}]).controller("book_searchList",["$scope","$timeout","$state","SearchBook$","WeChatJS$",function(o,e,n,t,s){o.SearchBook$=t,o.scanQRBtnOnClick=function(){s.scanQRCode(function(o){o&&o.length>=10&&o.length<=13?n.go("tab.book_oneBook",{isbn13:o}):alert("不合法的ISBN号")})}}]).controller("book_bookList",["$scope","$stateParams","BookRecommend$",function(o,e,n){o.title=e.title;var t=e.cmd;if("tag"==t){var s=e.tag;n.TagBook.setTag(s),n.TagBook.loadMore(),o.title=s,o.books=n.TagBook.books,o.loadMore=n.TagBook.loadMore,o.hasMore=n.TagBook.hasMore}else"new"==t?(o.books=n.NewBook.books,o.loadMore=n.NewBook.loadMore):"need"==t?(o.books=n.NeedBook.books,o.loadMore=n.NeedBook.loadMore):"major"==t?(o.books=n.MajorBook.books,o.loadMore=n.MajorBook.loadMore,o.title=n.MajorBook.major):"nearBook"==t&&(o.title="你附近的旧书")}]).controller("book_usedBookList",["$scope","$stateParams","UsedBook$","BookRecommend$",function(o,e,n,t){var s=e.cmd;if("near"==s)o.title="你附近的二手书",o.jsonUsedBooks=t.NearBook.jsonBooks,o.loadMore=t.NearBook.loadMore,o.hasMore=function(){return t.NearBook.hasMore};else if("isbn"==s){o.title="对应的二手书";var r=e.isbn13;n.ISBN.loadMoreUsedBookEqualISBN(r),o.jsonUsedBooks=n.ISBN.nowEqualISBNJsonUsedBookList,o.loadMore=n.ISBN.loadMoreUsedBookEqualISBN(r),o.hasMore=function(){return n.ISBN.hasMore}}}]).controller("book_userList",["$scope","$stateParams","UsedBook$","BookRecommend$",function(o,e,n,t){var s=e.cmd;if("near"==s){o.title="你附近的同学",o.jsonUsers=t.NearUser.jsonUsers;for(var r=0;r<o.jsonUsers.length;r++){var a=o.jsonUsers[r];n.getUsedBookNumberForOwner(a.objectId).done(function(e){a.usedBookNumber=e,o.$apply()})}o.loadMore=t.NearUser.loadMore,o.hasMore=function(){return t.NearUser.hasMore}}}]).controller("book_oneBook",["$scope","$stateParams","$ionicModal","DoubanBook$","WeChatJS$","InfoService$","UsedBook$","IonicModalView$","BusinessSite$",function(o,e,n,t,s,r,a,i,l){o.isbn13=e.isbn13,o.book=null,o.isLoading=!0,t.getBookByISBD(o.isbn13,function(e){e.image=e.image.replace("mpic","lpic"),o.book=e,o.isLoading=!1,o.$apply()}),o.showAuthorIntro=function(){var e=o.book.author.toString(),n=o.book.author_intro;i.alertTitleAndPreModalView(e,n)},o.showPubInfo=function(){var e="出版信息",n=o.book,t="作者:"+n.author.toString()+"\n出版社:"+n.publisher+"\n出版年:"+n.pubdate+"\n页数:"+n.pages+"\n定价:"+n.price+"\n装帧:"+n.binding+"\nISBN:"+n.isbn13+"\n目录:\n"+n.catalog;i.alertTitleAndPreModalView(e,t)},o.showSummary=function(){var e="图书简介",n=o.book.summary;i.alertTitleAndPreModalView(e,n)},l.getBusinessInfoByISBN(o.isbn13,function(e){o.businessInfos=e}),o.UsedBook$=a,a.getUsedBookNumberEqualISBN(o.isbn13).done(function(e){o.usedBookNumber=e}),a.ISBN.loadMoreUsedBookEqualISBN(o.isbn13),o.WeChatJS$=s}]).controller("book_BusinessSite",["$scope","$stateParams",function(o,e){o.url=e.url}]).controller("book_usedBookListByOwner",["$scope","$stateParams","UsedBook$","User$",function(o,e,n,t){o.UsedBook$=n;var s=e.ownerId,r=new AV.Query(AV.User);r.get(s).done(function(e){o.jsonOwnerInfo=t.avosUserToJson(e),n.loadUsedBookListForOwner(e).done(function(e){o.avosUsedBookList=e,o.$apply()})})}]).controller("book_oneUsedBook",["$scope","$stateParams","UsedBook$","User$","WeChatJS$",function(o,e,n,t,s){o.WeChatJS$=s;var r=e.usedBookAvosObjectId;n.getJsonUsedBookByAvosObjectId(r,function(e){o.jsonUsedBook=e;var s=o.jsonUsedBook.owner;s.fetch().done(function(e){o.ownerInfo=t.avosUserToJson(e),o.$apply()}),n.getUsedBookNumberForOwner(s.id).done(function(e){o.ownerUsedBookNumber=e,o.$apply()})})}]).controller("person_uploadOneUsedBook",["$scope","$state","$stateParams","$ionicHistory","$ionicModal","DoubanBook$","WeChatJS$","UsedBook$","User$","IonicModalView$",function(o,e,n,t,s,r,a,i,l,u){function c(){o.isLoading=!0,r.getBookByISBD_simple(o.usedBookInfo.isbn13,function(e){o.doubanBookInfo=e,o.isLoading=!1,o.$apply()})}o.isLoading=!1,o.WeChatJS$=a,o.usedBookInfo={isbn13:n.isbn13,price:null,des:null,avosImageFile:null},l.getCurrentAvosUser()?o.usedBookInfo.owner=l.getCurrentAvosUser():u.alertUserLoginModalView("你需要先登入",function(e){o.usedBookInfo.owner=e}),s.fromTemplateUrl("template/noBarCodeModalView.html",{scope:o}).then(function(e){o.noBarCodeModalView=e}),o.usedBookInfo.isbn13&&c(),o.scanQRBtnOnClick=function(){a.scanQRCode(function(e){o.usedBookInfo.isbn13=e,c()})};var d="";o.uploadPicOnClick=function(){a.chooseImage(function(e){o.localId=e,o.$apply(),a.uploadImage(o.localId,function(o){d=o})})},o.submitOnClick=function(){o.isLoading=!0;var n=i.jsonUsedBookToAvos(o.usedBookInfo);n.save(null).done(function(o){d&&AV.Cloud.run("saveWechatImageToUsedBook",{serverId:d,objectId:o.id},null),e.go("tab.person_usedBooksList"),t.clearHistory()}).fail(function(o){alert(o.message)}).always(function(){o.isLoading=!1})}}]).controller("person_signUp",["$scope","$timeout","$state","$stateParams","$ionicHistory","$ionicModal","WeChatJS$","InfoService$","User$","IonicModalView$",function(o,e,n,t,s,r,a,i,l,u){o.isLoading=!0;var c=t.code;a.getOAuthUserInfo(c,function(e){o.isLoading=!1,o.userInfo=e}),u.registerChooseSchoolModalView(o,function(e){o.userInfo.school=e}),u.registerChooseMajorModalView(o,function(e){o.userInfo.major=e}),o.startSchoolYearOptions=i.startSchoolYearOptions,o.submitOnClick=function(){o.isLoading=!0,l.signUpWithJSONUser(o.userInfo).done(function(){n.go("tab.person_my"),s.clearHistory()}).fail(function(o){alert(o.message)}).always(function(){o.isLoading=!1,o.$apply()})}}]).controller("person_editPersonInfo",["$scope","InfoService$","User$","IonicModalView$",function(o,e,n,t){o.attrHasChange=!1,n.getCurrentAvosUser()?o.userInfo=n.getCurrentJsonUser():t.alertUserLoginModalView("你还没有登入",function(){o.userInfo=n.getCurrentJsonUser()}),t.registerChooseSchoolModalView(o,function(e){o.attrHasChange=!0,o.userInfo.school=e}),t.registerChooseMajorModalView(o,function(e){o.attrHasChange=!0,o.userInfo.major=e}),o.startSchoolYearOptions=e.startSchoolYearOptions,o.submitOnClick=function(){t.alertUserLoginModalView("修改前需要验证身份",function(e){e.save({school:o.userInfo.school,major:o.userInfo.major,startSchoolYear:o.userInfo.startSchoolYear},function(){alert("修改成功")},function(o){alert("修改失败:"+o.message)})})}}]).controller("person_my",["$scope","$state","User$","UsedBook$","IonicModalView$",function(o,e,n,t,s){function r(){o.userInfo=n.getCurrentJsonUser(),t.getUsedBookNumberForOwner(n.getCurrentAvosUser().id).done(function(e){o.myUsedBookNumber=e,o.$apply()})}n.getCurrentJsonUser()?r():s.alertUserLoginModalView("你还没有登录",function(){r()}),o.logOut=function(){AV.User.logOut(),e.go("tab.book_recommend")}}]).controller("person_usedBookList",["$scope","UsedBook$","HasSellUsedBook$","User$","IonicModalView$",function(o,e,n,t,s){t.getCurrentAvosUser()||s.alertUserLoginModalView("你还没有登录",function(){e.loadMyAvosUsedBookList(),n.loadMyAvosUsedBookList()}),o.UsedBook$=e,e.loadMyAvosUsedBookList(),o.HasSellUsedBook$=n,n.loadMyAvosUsedBookList()}]).controller("person_editOneUsedBook",["$scope","$state","$stateParams","UsedBook$",function(o,e,n,t){var s=n.indexInMyAvosUsedBook_notSell;o.avosUsedBook=t.myAvosUsedBookList[s],o.valueHasChange=!1,o.jsonUsedBookChangeInfo=t.avosUsedBookToJson(o.avosUsedBook),o.submitOnClick=function(){o.avosUsedBook.set("des",o.jsonUsedBookChangeInfo.des),o.avosUsedBook.set("price",o.jsonUsedBookChangeInfo.price),o.avosUsedBook.save(null).done(function(){e.go("tab.person_usedBooksList")}).fail(function(o){alert(o.message)})}}]),APP.directive("reviewStar",function(){function o(o,e){var n=o.numStars,t=o.score,s=o.numRaters,r='<i class="icon ion-ios-star energized"></i>',a='<i class="icon ion-ios-star-outline"></i>';e.append("<i>"+t+"分&nbsp</i>"),e.append("<i>"+s+"人参与&nbsp</i>");for(var i=1;5>=i;i++){var l;l=n>=i?angular.element(r).clone():angular.element(a).clone(),e.append(l)}}return{restrict:"E",scope:{numStars:"@",score:"@",numRaters:"@"},link:o}}).directive("userInfo",["WeChatJS$",function(o){function e(e){e.WeChatJS$=o}return{restrict:"E",scope:{jsonUserInfo:"=",userUsedBookNumber:"="},templateUrl:"temp/tool/userInfoTemplate.html",link:e}}]).directive("doubanBookOneLine",function(){return{restrict:"E",scope:{jsonBooksInfo:"="},templateUrl:"temp/tool/doubanBookOneLineTemplate.html",link:function(o){o.showNumber=Math.floor(document.body.clientWidth/80)}}}).directive("usedBookOneLine",function(){return{restrict:"E",scope:{jsonBooksInfo:"="},templateUrl:"temp/tool/usedBookOneLineTemplate.html",link:function(o){o.showNumber=Math.floor(document.body.clientWidth/80)}}});