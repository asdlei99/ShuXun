"use strict";function jsonp(o,e,t){var n=document.createElement("script");n.type="text/javascript";var s=Date.now()+String(Math.floor(100*Math.random()));n.src=o+(o.indexOf("?")>0?"&":"?")+"callback=CB"+s,n.onload=function(){n.parentNode.removeChild(n)},n.onerror=function(o){t&&t(o)},window["CB"+s]=function(o){e(o)},document.head.appendChild(n)}function createCookie(o,e,t){var n="";if(t){var s=new Date;s.setTime(s.getTime()+24*t*60*60*1e3),n="; expires="+s.toUTCString()}document.cookie=o+"="+e+n+"; path=/"}function readCookie(o){for(var e=o+"=",t=document.cookie.split(";"),n=0;n<t.length;n++){for(var s=t[n];" "==s.charAt(0);)s=s.substring(1,s.length);if(0==s.indexOf(e))return s.substring(e.length,s.length)}return null}function eraseCookie(o){createCookie(o,"",-1)}function avosUserToJson(o){if(null==o)return null;for(var e={},t=0;t<UserAttrNames.length;t++){var n=UserAttrNames[t];e[n]=o.get(n)}return e.objectId=o.id,e.location=o.get("location"),e}function jsonToAvosUser(o){for(var e=new AV.User,t=0;t<UserAttrNames.length;t++){var n=UserAttrNames[t];o[n]&&e.set(n,o[n])}return e}AV.initialize("kusn9e3cp5znt5lic9fufqfmsvsibsoaejpah089x6v2n7e0","nt5l8v4n4m08zxttpt7upqxwgt6oy47lzb3f8c4juf34otfm"),window.location.host.indexOf("ishuxun.cn")<0&&AV.setProduction(!1);var WECHAT={AppID:"wx2940a8d3ddcad5e9"},LoadCount=Math.floor(document.body.clientWidth/80),RandomStart=(new Date).getDay()*Math.floor(10*Math.random()),UserAttrNames=["openId","nickName","avatarUrl","sex","school","major","startSchoolYear","wechatAlert"],APP=angular.module("APP",["ionic"],null).config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider",function(o,e,t){t.tabs.style("standard"),t.tabs.position("bottom"),o.state("tab",{url:"/tab","abstract":!0,templateUrl:"temp/tabs.html"}).state("tab.book_recommend",{url:"/book/recommend",views:{"tab-book":{templateUrl:"temp/book/recommend.html"}}}).state("tab.book_searchList",{url:"/book/searchList/:keyword",views:{"tab-book":{templateUrl:"temp/book/searchList.html"}}}).state("tab.book_bookList",{url:"/book/bookList?cmd&title&tag",views:{"tab-book":{templateUrl:"temp/book/bookList.html"}}}).state("tab.book_usedBookList",{url:"/book/usedBookList?cmd&isbn13",views:{"tab-book":{templateUrl:"temp/book/usedBookList.html"}}}).state("tab.book_oneBook",{url:"/book/oneBook/:isbn13",views:{"tab-book":{templateUrl:"temp/book/oneBook.html"}}}).state("tab.book_oneUsedBook",{url:"/book/oneUsedBook/:usedBookAvosObjectId",views:{"tab-book":{templateUrl:"temp/book/oneUsedBook.html"}}}).state("tab.book_oneNeedBook",{url:"/book/oneNeedBook/:usedBookAvosObjectId",views:{"tab-book":{templateUrl:"temp/book/oneNeedBook.html"}}}).state("tab.book_bookReview",{url:"/book/oneUsedBook?doubanBookId&bookTitle",views:{"tab-book":{templateUrl:"temp/book/bookReview.html"}}}).state("tab.person_editOneUsedBook",{url:"/person/editOneUsedBook/:usedBookId",views:{"tab-person":{templateUrl:"temp/person/editOneUsedBook.html"}}}).state("tab.person_uploadOneUsedBook",{url:"/person/uploadOneUsedBook/:isbn13",views:{"tab-person":{templateUrl:"temp/person/uploadOneUsedBook.html"}}}).state("tab.person_uploadOneNeedBook",{url:"/person/uploadOneNeedBook/:isbn13",views:{"tab-person":{templateUrl:"temp/person/uploadOneNeedBook.html"}}}).state("tab.person_usedBooksList",{url:"/person/usedBookList",views:{"tab-person":{templateUrl:"temp/person/usedBookList.html"}}}).state("tab.person_needBooksList",{url:"/person/needBookList",views:{"tab-person":{templateUrl:"temp/person/needBookList.html"}}}).state("tab.person_statusList",{url:"/person/statusList?cmd",views:{"tab-person":{templateUrl:"temp/person/statusList.html"}}}).state("tab.person_editPersonInfo",{url:"/person/editPersonInfo",views:{"tab-person":{templateUrl:"temp/person/editPersonInfo.html"}}}).state("tab.person_my",{url:"/person/my",views:{"tab-person":{templateUrl:"temp/person/my.html"}}}).state("tab.person_sendMsgToUser",{url:"/person/sendMsgToUser?receiverObjectId&usedBookObjectId&role&inboxType",views:{"tab-person":{templateUrl:"temp/person/sendMsgToUser.html"}}}).state("tab.hello",{url:"/hello",views:{"tab-person":{templateUrl:"temp/tool/hello.html"}}}).state("tab.signUp",{url:"/signUp?code&state",views:{"tab-person":{templateUrl:"temp/tool/signUp.html"}}}).state("tab.userList",{url:"/userList?cmd&title",views:{"tab-book":{templateUrl:"temp/tool/userList.html"}}}).state("tab.userHome",{url:"/userHome/:ownerId",views:{"tab-book":{templateUrl:"temp/tool/userHome.html"}}}),e.otherwise("/tab/book/recommend")}]);APP.run(["$rootScope","$state","User$","WeChatJS$",function(o,e,t,n){n.config(),t.loginWithUnionId(readCookie("unionId")),o.$on("$stateChangeStart",function(o,n){var s=n.name;s.indexOf("tab.person_")>=0&&(t.getCurrentAvosUser()||(o.preventDefault(),e.go("tab.hello")))})}]),APP.service("BookInfo$",["$rootScope",function(o){var e=this,t=["doubanId","isbn13","title","image","author","translator","publisher","pubdate","price","pages","summary","binding","catalog","author_intro"];this.avosBookInfoToJson=function(o){for(var e={},n=0;n<t.length;n++){var s=t[n];e[s]=o.get(s)}return e.objectId=o.id,e.updatedAt=o.get("updatedAt"),e},this.getJsonBookByISBN13=function(o){return AV.Cloud.run("getJsonBookByISBN13",{isbn13:o})},this.LatestBook={jsonBooks:[],hasMoreFlag:!0,loadMore:function(){var t=new AV.Query("BookInfo");t.select(["doubanId","isbn13","title","image","pubdate","author","publisher","pubdate","price"]),t.descending("pubdate"),t.skip(e.LatestBook.jsonBooks.length+RandomStart),t.limit(LoadCount),t.find().done(function(t){if(t.length>0)for(var n=0;n<t.length;n++)e.LatestBook.jsonBooks.push(e.avosBookInfoToJson(t[n]));else e.LatestBook.hasMoreFlag=!1;o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return e.LatestBook.hasMoreFlag}}}]),APP.service("BookRecommend$",["$rootScope","DoubanBook$","User$","UsedBook$",function(o,e,t,n){var s=this;this.BookTag={tag:null,load:function(){AV.Cloud.run("getAllBookTags",null,null).done(function(e){s.BookTag.tag=e,o.$apply()})},getTagAttrNames:function(){return s.BookTag.tag?Object.keys(s.BookTag.tag):[]}},this.BookTag.load(),this.TagBook={nowTag:"",setTag:function(o){o!=s.TagBook.nowTag&&(s.TagBook.books=[],s.TagBook.nowTag=o)},books:[],hasMoreFlag:!0,loadMore:function(){e.getBooksByTag(s.TagBook.nowTag,s.TagBook.books.length,LoadCount,function(e){var t=e.books;if(t.length>0)for(var n=0;n<t.length;n++)s.TagBook.books.push(t[n]);else s.TagBook.hasMoreTag=!1;o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return s.TagBook.hasMoreFlag}},this.MajorBook={major:t.getCurrentJsonUser()?t.getCurrentJsonUser().major:"",books:[],hasMoreFlag:!0,loadMore:function(){e.getBooksByTag(s.MajorBook.major,s.MajorBook.books.length+RandomStart,LoadCount,function(e){s.MajorBook.totalNum=e.total;var t=e.books;if(t.length>0)for(var n=0;n<t.length;n++)s.MajorBook.books.push(t[n]);else s.MajorBook.hasMoreFlag=!1;o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return s.MajorBook.hasMoreFlag}},this.NearNeedBook={jsonBooks:[],hasMoreFlag:!0,loadMore:function(){var e=t.getCurrentUserLocation(),i=new AV.Query("UsedBook");if(i.notEqualTo("owner",AV.User.current()),i.equalTo("role","need"),e&&i.near("location",e),s.NearNeedBook._majorFilter){var a=new AV.Query("_User");a.equalTo("major",s.NearNeedBook._majorFilter),i.matchesQuery("owner",a)}i.skip(s.NearNeedBook.jsonBooks.length+RandomStart),i.limit(LoadCount),i.find().done(function(e){if(e.length>0)for(var t=0;t<e.length;t++)s.NearNeedBook.jsonBooks.push(n.avosUsedBookToJson(e[t]));else s.NearNeedBook.hasMoreFlag=!1;o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return s.NearNeedBook.hasMoreFlag},_majorFilter:null,setMajorFilter:function(o){o!=s.NearNeedBook._majorFilter&&(s.NearNeedBook.jsonBooks.length=0,s.NearNeedBook.hasMoreFlag=!0,s.NearNeedBook._majorFilter=o,s.NearNeedBook.loadMore())},getMajorFilter:function(){return s.NearNeedBook._majorFilter}},this.NearUsedBook={jsonBooks:[],hasMoreFlag:!0,loadMore:function(){var e=t.getCurrentUserLocation(),i=new AV.Query("UsedBook");if(i.notEqualTo("owner",AV.User.current()),i.equalTo("role","sell"),e&&i.near("location",e),s.NearUsedBook._majorFilter){var a=new AV.Query("_User");a.equalTo("major",s.NearUsedBook._majorFilter),i.matchesQuery("owner",a)}i.skip(s.NearUsedBook.jsonBooks.length),i.limit(LoadCount),i.find().done(function(e){if(e.length>0)for(var t=0;t<e.length;t++)s.NearUsedBook.jsonBooks.push(n.avosUsedBookToJson(e[t]));else s.NearUsedBook.hasMoreFlag=!1;o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return s.NearUsedBook.hasMoreFlag},_majorFilter:null,setMajorFilter:function(o){o!=s.NearUsedBook._majorFilter&&(s.NearUsedBook.jsonBooks.length=0,s.NearUsedBook.hasMoreFlag=!0,s.NearUsedBook._majorFilter=o,s.NearUsedBook.loadMore())},getMajorFilter:function(){return s.NearUsedBook._majorFilter}},this.NearUser={jsonUsers:[],hasMoreFlag:!0,loadMore:function(){var e=t.getCurrentUserLocation(),n=new AV.Query(AV.User);AV.User.current()&&n.notEqualTo("objectId",AV.User.current().id),e&&n.near("location",e),s.NearUser._majorFilter&&n.equalTo("major",s.NearUser._majorFilter),n.skip(s.NearUser.jsonUsers.length),n.limit(Math.floor(document.body.clientWidth/50)),n.find().done(function(e){if(e.length>0)for(var t=0;t<e.length;t++)s.NearUser.jsonUsers.push(avosUserToJson(e[t]));else s.NearUser.hasMoreFlag=!1;o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return s.NearUser.hasMoreFlag},_majorFilter:null,setMajorFilter:function(o){o!=s.NearUser._majorFilter&&(s.NearUser.jsonUsers.length=0,s.NearUser.hasMoreFlag=!0,s.NearUser._majorFilter=o,s.NearUser.loadMore())},getMajorFilter:function(){return s.NearUser._majorFilter}},this.NearUser.loadMore()}]),APP.service("BusinessSite$",function(){this.getBusinessInfoByISBN=function(o){return AV.Cloud.run("getBusinessInfo",{id:o},null)}}),APP.service("DoubanBook$",["$rootScope","$ionicHistory","BookInfo$",function(o,e,t){function n(o){for(var e=o.substring(3,12),t=0,n=0;9>n;n++){var s=parseInt(e.charAt(n));t+=s*(10-n)}var i=t%11,a=11-i,r=String(a);return 10==a?r="X":11==a&&(r="0"),String(e+r)}var s=this,i="http://api.douban.com/v2/book";this.getBookByISBD=function(o,e,s){function a(o){var e=i+"/isbn/"+o;return null==s&&(s="id,rating,author,pubdate,image,binding,translator,catalog,pages,publisher,isbn13,title,author_intro,summary,price"),e+="?fields="+s}jsonp(a(o),function(o){e(o)},function(){13==o.length&&jsonp(a(n(o)),function(o){e(o)},function(){t.getJsonBookByISBN13(o).done(function(o){e(o)}).fail(function(){e(null)})})})},this.getBookByISBD_simple=function(o,e){s.getBookByISBD(o,e,"author,pubdate,image,publisher,title,price,isbn13")},this.searchBooks=function(o,e,t,n){var s=i+"/search";return o&&o.length<1?[]:(s+="?q="+o,e&&(s+="&start="+e),t&&(s+="&count="+t),s+="&fields=isbn13,title,image,author,publisher,pubdate,price",void jsonp(s,function(o){n(o)}))},this.getBooksByTag=function(o,e,t,n){var s=i+"/search";return!o||o.length<1?[]:(s+="?tag="+o,e&&(s+="&start="+e),t&&(s+="&count="+t),s+="&fields=isbn13,title,image,author,publisher,pubdate,price",void jsonp(s,function(o){n(o)}))},this.BookReview={reviewList:[],nowBookId:null,hasMoreFlag:!0,loadMore:function(){AV.Cloud.run("getDoubanBookReview",{id:s.BookReview.nowBookId,start:s.BookReview.reviewList.length},null).done(function(t){if(t.length>0)for(var n=0;n<t.length;n++)s.BookReview.reviewList.push(t[n]);else s.BookReview.hasMoreFlag=!1,0==s.BookReview.reviewList.length&&(alert("还没有对应的书评~"),e.goBack());o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return s.BookReview.hasMoreFlag},clear:function(){s.BookReview.reviewList=[],s.BookReview.hasMoreFlag=!0,o.$broadcast("scroll.infiniteScrollComplete")}}}]),APP.service("InfoService$",["$rootScope","$http","User$",function(o,e,t){var n=this;this.majors=[],AV.Cloud.run("getAllMajor",null,null).done(function(o){n.majors=o}),this.searchMajorKeyword="",this.filter_majorByKeyword=function(o){return o.name.indexOf(n.searchMajorKeyword)>-1},this.School={schools:[],loadMore:function(){var e=t.getCurrentUserLocation(),s=new AV.Query("School");e&&s.near("location",e),n.School.searchSchoolKeyword.length>0?s.startsWith("name",n.School.searchSchoolKeyword):(s.skip(n.School.schools.length),s.limit(10)),s.find().done(function(e){if(e.length>0)for(var t=0;t<e.length;t++)n.School.schools.push(e[t].get("name"));o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},searchSchoolKeyword:"",filter_schoolByKeyword:function(o){return o.indexOf(n.School.searchSchoolKeyword)>=0}},this.startSchoolYearOptions=[];for(var s=(new Date).getFullYear(),i=s-6;s>=i;i++)n.startSchoolYearOptions.push(i.toString())}]),APP.service("IonicModalView$",["$rootScope","$ionicModal","$ionicHistory","InfoService$",function(o,e,t,n){this.registerChooseSchoolModalView=function(o,t){o.InfoService$=n,e.fromTemplateUrl("temp/tool/chooseSchoolModalView.html",{scope:o}).then(function(e){o.chooseSchoolModalView=e}),o.schoolOnChoose=function(e){t(e),o.chooseSchoolModalView.hide()}},this.registerChooseMajorModalView=function(o,t){o.InfoService$=n,e.fromTemplateUrl("temp/tool/chooseMajorModalView.html",{scope:o}).then(function(e){o.chooseMajorModalView=e}),o.majorOnChoose=function(e){t(e),o.chooseMajorModalView.hide()}},this.alertTitleAndPreModalView=function(t,n){var s=o.$new(!0);s.titleAndPreModalViewData={title:t,pre:n},e.fromTemplateUrl("temp/tool/titleAndPreModalView.html",{scope:s}).then(function(o){s.titleAndPreModalView=o,o.show()})}}]),APP.service("SearchBook$",["$rootScope","DoubanBook$","$timeout",function(o,e,t){var n=this;this.keyword="",this.books=[],this.hasMore=function(){return n.books.length<n.totalNum},this.totalNum=0,this.loadMore=function(){n.keyword.length>0&&e.searchBooks(n.keyword,n.books.length,10,function(e){if(n.totalNum=e.total,n.totalNum>0){for(var t=e.books,s=0;s<t.length;s++)n.books.push(t[s]);o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")}else alert("没有找到你想要的图书")})};var s=null;this.searchBtnOnClick=function(){n.loadMore(),t.cancel(s)},this.searchInputOnChange=function(){n.books=[],n.totalNum=0,t.cancel(s),s=t(function(){n.searchBtnOnClick()},1e3)}}]),APP.service("Status$",["$rootScope","UsedBook$",function(o,e){var t=this,n=["inboxType","message","source","to","usedBook"];this.loadUnreadStatusesCount=function(){var e=AV.User.current();e&&(AV.Status.countUnreadStatuses(e,"newUsedBook").done(function(e){t.NewUsedBookStatus.unreadCount=e.unread,o.$apply()}),AV.Status.countUnreadStatuses(e,"newNeedBook").done(function(e){t.NewNeedBookStatus.unreadCount=e.unread,o.$apply()}),AV.Status.countUnreadStatuses(e,"private").done(function(e){t.PrivateStatus.unreadCount=e.unread,o.$apply()}),AV.Status.countUnreadStatuses(e,"reviewUsedBook").done(function(e){t.ReviewUsedBookStatus.unreadCount=e.unread,o.$apply()}))},this.NewUsedBookStatus={unreadCount:0,avosStatusList:[],load:function(){var n=AV.Status.inboxQuery(AV.User.current(),"newUsedBook");n.include("usedBook"),n.include("source"),n.limit(t.NewUsedBookStatus.unreadCount),n.find().done(function(n){for(var s=0;s<n.length;s++){var i=n[s];i.jsonUserInfo=avosUserToJson(i.get("source")),i.jsonUsedBook=e.avosUsedBookToJson(i.get("usedBook")),t.NewUsedBookStatus.avosStatusList.push(i)}t.NewUsedBookStatus.unreadCount=0,o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})}},this.NewNeedBookStatus={unreadCount:0,avosStatusList:[],load:function(){var n=AV.Status.inboxQuery(AV.User.current(),"newNeedBook");n.include("usedBook"),n.include("source"),n.limit(t.NewNeedBookStatus.unreadCount),n.find().done(function(n){for(var s=0;s<n.length;s++){var i=n[s];i.jsonUserInfo=avosUserToJson(i.get("source")),i.jsonUsedBook=e.avosUsedBookToJson(i.get("usedBook")),t.NewNeedBookStatus.avosStatusList.push(i)}t.NewNeedBookStatus.unreadCount=0,o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})}},this.PrivateStatus={unreadCount:0,avosStatusList:[],load:function(){var n=AV.Status.inboxQuery(AV.User.current(),"private");n.include("usedBook"),n.include("source"),n.limit(t.PrivateStatus.unreadCount),n.find().done(function(n){for(var s=0;s<n.length;s++){var i=n[s];i.jsonUserInfo=avosUserToJson(i.get("source")),i.jsonUsedBook=e.avosUsedBookToJson(i.get("usedBook")),t.PrivateStatus.avosStatusList.push(i)}t.PrivateStatus.unreadCount=0,o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})}},this.ReviewUsedBookStatus={unreadCount:0,avosStatusList:[],load:function(){var n=AV.Status.inboxQuery(AV.User.current(),"reviewUsedBook");n.include("usedBook"),n.include("source"),n.limit(t.ReviewUsedBookStatus.unreadCount),n.find().done(function(n){for(var s=0;s<n.length;s++){var i=n[s];i.jsonUserInfo=avosUserToJson(i.get("source")),i.jsonUsedBook=e.avosUsedBookToJson(i.get("usedBook")),t.ReviewUsedBookStatus.avosStatusList.push(i)}t.ReviewUsedBookStatus.unreadCount=0,o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})}},this.avosStatusToJson=function(o){for(var e={},t=0;t<n.length;t++)e[n[t]]=o.get(n[t]);return e.updatedAt=o.get("updatedAt"),e.objectId=o.id,e},this.sendPrivateMsg=function(o,e,t,n){var s=new AV.Status(null,e);return s.set("to",AV.Object.createWithoutData("_User",o)),n&&s.set("usedBook",AV.Object.createWithoutData("UsedBook",n)),s.set("role",t),AV.Status.sendPrivateStatus(s,o)},this.reviewUsedBook=function(o,e,t,n){var s=new AV.Promise(null),i=new AV.Query("UsedBook");return i.select("owner"),i.get(e).done(function(e){var a=e.get("owner");i=new AV.Query(AV.User),i.equalTo("objectId",a.id);var r=new AV.Status(null,t);r.query=i,r.inboxType="reviewUsedBook",r.set("to",AV.Object.createWithoutData("_User",o)),r.set("role",n),r.set("usedBook",e),r.send().done(function(o){s.resolve(o)}).fail(function(o){s.reject(o)})}).fail(function(o){s.reject(o)}),s},this.getStatusList_reviewBook=function(o){var e=new AV.Query("_Status"),t=AV.Object.createWithoutData("UsedBook",o);return e.equalTo("inboxType","reviewUsedBook"),e.equalTo("usedBook",t),e.find()},this.makeQueryStatusList_twoUser=function(o,e){if(o){var t=AV.User.current(),n=AV.Object.createWithoutData("_User",o),s=new AV.Query("_Status");s.equalTo("source",t),s.equalTo("to",n);var i=new AV.Query("_Status");if(i.equalTo("source",n),i.equalTo("to",t),e){var a=AV.Object.createWithoutData("UsedBook",e);s.equalTo("usedBook",a),i.equalTo("usedBook",a)}return AV.Query.or(s,i)}return new AV.Error(1,"缺少avosUserId")}}]),APP.service("UsedBook$",["$rootScope",function(o){var e=this,t=["owner","isbn13","price","des","image","title","role"];this.isLoading=!1,this.loadUsedBookListForOwner=function(o){var e=o.relation("usedBooks").query();return e.equalTo("role","sell"),e.find()},this.loadNeedBookListForOwner=function(o){var e=o.relation("usedBooks").query();return e.equalTo("role","need"),e.find()},this.myAvosUsedBookList=[],this.loadMyAvosUsedBookList=function(){e.isLoading=!0;var t=AV.User.current().relation("usedBooks").query();t.equalTo("role","sell"),t.descending("updatedAt"),t.find().done(function(o){e.myAvosUsedBookList=o}).always(function(){e.isLoading=!1,o.$apply()})},this.myAvosNeedBookList=[],this.loadMyAvosNeedBookList=function(){e.isLoading=!0;var t=AV.User.current().relation("usedBooks").query();t.equalTo("role","need"),t.descending("updatedAt"),t.find().done(function(o){e.myAvosNeedBookList=o}).always(function(){e.isLoading=!1,o.$apply()})},this.removeUsedBook=function(o){var t=o.get("role");window.confirm("你确定要删除它吗?将不可恢复")&&o.destroy().done(function(){"sell"==t?e.loadMyAvosUsedBookList():"need"==t&&e.loadMyAvosNeedBookList()}).fail(function(o){alert(o.message)})},this.avosUsedBookToJson=function(o){if(null==o)return null;for(var e={},n=0;n<t.length;n++){var s=t[n];e[s]=o.get(s)}return e.objectId=o.id,e.updatedAt=o.updatedAt,e},this.jsonUsedBookToAvos=function(o){for(var e=AV.Object.extend("UsedBook"),n=new e,s=0;s<t.length;s++){var i=t[s];n.set(i,o[i])}return n},this.getJsonUsedBookByAvosObjectId=function(o,t){var n=new AV.Query("UsedBook");n.get(o).done(function(o){t(e.avosUsedBookToJson(o))})},this.ISBN_sell={getUsedBookNumberEqualISBN:function(o){var e=new AV.Query("UsedBook");return e.equalTo("role","sell"),e.equalTo("isbn13",o),e.count()},nowISBN13:"",nowEqualISBNJsonUsedBookList:[],loadMoreUsedBookEqualISBN:function(t){e.isLoading=!0,t!=e.ISBN_sell.nowISBN13&&(e.ISBN_sell.nowISBN13=t,e.ISBN_sell.nowEqualISBNJsonUsedBookList=[],e.ISBN_sell.hasMoreFlag=!0);var n=new AV.Query("UsedBook");n.equalTo("isbn13",e.ISBN_sell.nowISBN13),n.equalTo("role","sell"),n.descending("updatedAt"),n.skip(e.ISBN_sell.nowEqualISBNJsonUsedBookList.length),n.limit(5),n.include("owner"),n.find().done(function(o){if(o.length>0)for(var t=0;t<o.length;t++)e.ISBN_sell.nowEqualISBNJsonUsedBookList.push(e.avosUsedBookToJson(o[t]));else e.ISBN_sell.hasMoreFlag=!1}).always(function(){e.isLoading=!1,o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMoreFlag:!0,hasMore:function(){return e.ISBN_sell.hasMoreFlag}},this.ISBN_need={getNeedBookNumberEqualISBN:function(o){var e=new AV.Query("UsedBook");return e.equalTo("role","need"),e.equalTo("isbn13",o),e.count()},nowISBN13:"",nowEqualISBNJsonNeedBookList:[],loadMoreNeedBookEqualISBN:function(t){e.isLoading=!0,t!=e.ISBN_need.nowISBN13&&(e.ISBN_need.nowISBN13=t,e.ISBN_need.nowEqualISBNJsonNeedBookList=[],e.ISBN_need.hasMoreFlag=!0);var n=new AV.Query("UsedBook");n.equalTo("isbn13",e.ISBN_need.nowISBN13),n.equalTo("role","need"),n.descending("updatedAt"),n.skip(e.ISBN_need.nowEqualISBNJsonNeedBookList.length),n.limit(5),n.include("owner"),n.find().done(function(o){if(o.length>0)for(var t=0;t<o.length;t++)e.ISBN_need.nowEqualISBNJsonNeedBookList.push(e.avosUsedBookToJson(o[t]));else e.ISBN_need.hasMoreFlag=!1}).always(function(){e.isLoading=!1,o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMoreFlag:!0,hasMore:function(){return e.ISBN_need.hasMoreFlag}}}]),APP.service("User$",["$rootScope","Status$",function(o,e){var t=this;this.signUpWithJSONUser=function(o){var e=jsonToAvosUser(o);return e.set("username",o.unionId),e.set("password",o.unionId),e.signUp(null)},this.getCurrentUserLocation=function(){var o=t.getCurrentAvosUser();return o?o.get("location"):null},this.getCurrentAvosUser=function(){return AV.User.current()},this.getCurrentJsonUser=function(){var o=t.getCurrentAvosUser();return o?avosUserToJson(o):null},this.followUser=function(e){var n=t.getCurrentAvosUser();n?n.follow(e).done(function(){o.$broadcast("FollowSomeone")}).fail(function(o){alert("关注失败:"+o.message)}):alert("请先登入")},this.unfollowUser=function(e){var n=t.getCurrentAvosUser();n?n.unfollow(e).done(function(){o.$broadcast("UnfollowSomeone")}).fail(function(o){alert("取消关注失败:"+o.message)}):alert("请先登入")},this.Followee={jsonUserList:[],loadMore:function(){var e=AV.User.current().followeeQuery();if(e.include("followee"),e.skip(t.Followee.jsonUserList.length),e.limit(10),t.Followee._majorFilter){var n=new AV.Query("_User");n.equalTo("major",t.Followee._majorFilter),e.matchesQuery("followee",n)}e.find().done(function(e){if(e.length>0)for(var n=0;n<e.length;n++)t.Followee.jsonUserList.push(avosUserToJson(e[n]));else t.Followee.hasMoreFlag=!1;o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMoreFlag:!0,hasMore:function(){return t.Followee.hasMoreFlag},_majorFilter:null,setMajorFilter:function(o){o!=t.Followee._majorFilter&&(t.Followee.jsonUserList.length=0,t.Followee.hasMoreFlag=!0,t.Followee._majorFilter=o,t.Followee.loadMore())},getMajorFilter:function(){return t.Followee._majorFilter}},this.Follower={jsonUserList:[],loadMore:function(){var e=AV.User.current().followerQuery();if(e.include("follower"),e.skip(t.Follower.jsonUserList.length),e.limit(10),t.Follower._majorFilter){var n=new AV.Query("_User");n.equalTo("major",t.Follower._majorFilter),e.matchesQuery("follower",n)}e.find().done(function(e){if(e.length>0)for(var n=0;n<e.length;n++)t.Follower.jsonUserList.push(avosUserToJson(e[n]));else t.Follower.hasMoreFlag=!1;o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMoreFlag:!0,hasMore:function(){return t.Follower.hasMoreFlag},_majorFilter:null,setMajorFilter:function(o){o!=t.Follower._majorFilter&&(t.Follower.jsonUserList.length=0,t.Follower.hasMoreFlag=!0,t.Follower._majorFilter=o,t.Follower.loadMore())},getMajorFilter:function(){return t.Follower._majorFilter}},this.changeWechatAvatarSize=function(o,e){return o?o.substring(0,o.length-1)+e:null},this.loginWithUnionId=function(o){var t=new AV.Promise(null);return o?AV.User.logIn(o,o).done(function(o){t.resolve(o),e.loadUnreadStatusesCount()}).fail(function(o){t.reject(o)}):t.reject("unionId错误"),t}}]),APP.service("WeChatJS$",["$rootScope",function(o){function e(o){var e={title:"书循",desc:"让你的课本重复利用",link:window.location.href,imgUrl:"http://"+window.location.host+"/wechat/img/logo-R.png"};return e=angular.extend(e,o)}var t=this;this.config=function(){AV.Cloud.run("getWechatJsConfig",{url:location.href.split("#")[0]},null).done(function(o){wx.config(o)})},wx.ready(function(){wx.onMenuShareTimeline(e()),wx.onMenuShareAppMessage(e()),wx.onMenuShareQQ(e()),wx.onMenuShareWeibo(e()),wx.getLocation({success:function(o){AV.Cloud.run("updateMyLocation",{latitude:o.latitude,longitude:o.longitude},null)},fail:function(){AV.Cloud.run("updateMyLocation",null,null)},cancel:function(){AV.Cloud.run("updateMyLocation",null,null)}})}),wx.error(function(){t.config()}),this.scanQRCode=function(e){wx.scanQRCode({needResult:1,scanType:["barCode"],success:function(t){e(t.resultStr.split(",")[1]),o.$apply()}})},this.previewOneImage=function(o){wx.previewImage({current:o,urls:[o]})},this.getOAuthURL=function(){var o=location.href.split("#")[0]+"#/tab/signUp";return"https://open.weixin.qq.com/connect/oauth2/authorize?appid="+WECHAT.AppID+"&redirect_uri="+encodeURIComponent(o)+"&response_type=code&scope=snsapi_base&state=#wechat_redirect"},this.getOAuthUserInfo=function(o,e,t){AV.Cloud.run("getWechatOAuthUserInfo",{code:o},null).done(function(o){var t={openId:o.openid,unionId:o.unionid,nickName:o.nickname,sex:o.sex,avatarUrl:o.headimgurl};createCookie("unionId",t.unionId,365),e(t)}).fail(function(o){t&&t(o)})},this.openMap=function(o,e){jsonp("http://apis.map.qq.com/ws/coord/v1/translate?type=1&key=R3DBZ-HEYRF-ZSZJ3-JAJJN-2ZWFF-SLBJV&output=jsonp&locations="+o+","+e,function(o){if(0==o.status){var e=o.locations[0];wx.openLocation({latitude:e.lat,longitude:e.lng,name:"该同学位置"})}})}}]),APP.controller("book_bookList",["$scope","$stateParams","BookRecommend$","BookInfo$",function(o,e,t,n){o.title=e.title;var s=e.cmd;if("tag"==s){var i=e.tag;t.TagBook.setTag(i),t.TagBook.loadMore(),o.title=i,o.books=t.TagBook.books,o.loadMore=t.TagBook.loadMore,o.hasMore=t.TagBook.hasMore}else"need"==s?(o.books=t.NearNeedBook.books,o.loadMore=t.NearNeedBook.loadMore,o.hasMore=t.NearNeedBook.hasMore):"major"==s?(o.books=t.MajorBook.books,o.loadMore=t.MajorBook.loadMore,o.title=t.MajorBook.major,o.hasMore=t.MajorBook.hasMore):"new"==s&&(o.books=n.LatestBook.jsonBooks,o.loadMore=n.LatestBook.loadMore,o.title="新书速递",o.hasMore=n.LatestBook.hasMore)}]),APP.controller("book_bookReview",["$scope","$stateParams","DoubanBook$",function(o,e,t){o.BookReview=t.BookReview,o.BookReview.nowBookId=e.doubanBookId,o.title=e.bookTitle+" 书评",o.$on("$ionicView.afterLeave",function(){o.BookReview.clear()})}]),APP.controller("book_oneBook",["$scope","$state","$stateParams","$ionicModal","DoubanBook$","WeChatJS$","InfoService$","UsedBook$","IonicModalView$","BusinessSite$","User$",function(o,e,t,n,s,i,a,r,l,u,d){o.User$=d,o.isbn13=t.isbn13,o.book=null,o.isLoading=!0,s.getBookByISBD(o.isbn13,function(t){t?(t.image=t.image.replace("mpic","lpic"),o.book=t,o.isbn13=t.isbn13,o.isLoading=!1,o.$apply(),u.getBusinessInfoByISBN(t.id).done(function(e){o.businessInfos=e})):(alert("没有找到图书信息,再去搜搜看~"),e.go("tab.book_searchList"))}),o.showAuthorIntro=function(){var e=o.book.author.toString(),t=o.book.author_intro;l.alertTitleAndPreModalView(e,t)},o.showPubInfo=function(){var e="出版信息",t=o.book,n="作者:"+t.author.toString()+"\n出版社:"+t.publisher+"\n出版年:"+t.pubdate+"\n页数:"+t.pages+"\n定价:"+t.price+"\n装帧:"+t.binding+"\nISBN:"+t.isbn13+"\n目录:\n"+t.catalog;l.alertTitleAndPreModalView(e,n)},o.showSummary=function(){var e="图书简介",t=o.book.summary;l.alertTitleAndPreModalView(e,t)},o.UsedBook$=r,r.ISBN_sell.getUsedBookNumberEqualISBN(o.isbn13).done(function(e){o.usedBookNumber=e}),r.ISBN_sell.loadMoreUsedBookEqualISBN(o.isbn13),r.ISBN_need.getNeedBookNumberEqualISBN(o.isbn13).done(function(e){o.needBookNumber=e}),r.ISBN_need.loadMoreNeedBookEqualISBN(o.isbn13),o.WeChatJS$=i}]),APP.controller("book_oneUsedBook",["$scope","$stateParams","UsedBook$","User$","WeChatJS$","Status$",function(o,e,t,n,s,i){o.User$=n,o.WeChatJS$=s,o.usedBookObjectId=e.usedBookAvosObjectId,t.getJsonUsedBookByAvosObjectId(o.usedBookObjectId,function(e){e.image=e.image?e.image.replace("mpic","lpic"):"",o.jsonUsedBook=e,o.$apply();var t=o.jsonUsedBook.owner;t.fetch().done(function(e){o.ownerInfo=avosUserToJson(e),o.$apply()})}),i.getStatusList_reviewBook(o.usedBookObjectId).done(function(e){o.jsonStatusList=[];for(var t=0;t<e.length;t++){var n=i.avosStatusToJson(e[t]);n.source.fetch().done(function(){o.$apply()}),n.to.fetch().done(function(){o.$apply()}),o.jsonStatusList.push(n)}o.$apply()})}]),APP.controller("book_recommend",["$scope","$ionicModal","BookRecommend$","User$","BookInfo$",function(o,e,t,n,s){o.User$=n,o.BookRecommend$=t,o.LatestBook=s.LatestBook,o.LatestBook.loadMore(),t.MajorBook.loadMore(),t.NearUsedBook.loadMore(),t.NearNeedBook.loadMore(),e.fromTemplateUrl("template/bookTags.html",{scope:o}).then(function(e){o.bookTagsModalView=e})}]),APP.controller("book_searchList",["$scope","$timeout","$state","$stateParams","SearchBook$","WeChatJS$",function(o,e,t,n,s,i){o.SearchBook$=s;var a=n.keyword;a&&(s.keyword=a,s.searchBtnOnClick()),o.scanQRBtnOnClick=function(){i.scanQRCode(function(o){o&&o.length>=10&&o.length<=13?t.go("tab.book_oneBook",{isbn13:o}):alert("不合法的ISBN号")})}}]),APP.controller("book_usedBookList",["$scope","$stateParams","UsedBook$","BookRecommend$","IonicModalView$",function(o,e,t,n,s){o.cmd=e.cmd,o.sortWay="","nearUsed"==o.cmd?(o.title="你附近的二手书",o.jsonUsedBooks=n.NearUsedBook.jsonBooks,o.loadMore=n.NearUsedBook.loadMore,o.hasMore=n.NearUsedBook.hasMore,o.setMajorFilter=n.NearUsedBook.setMajorFilter,o.getMajorFilter=n.NearUsedBook.getMajorFilter):"nearNeed"==o.cmd?(o.title="你附近的求书",o.jsonUsedBooks=n.NearNeedBook.jsonBooks,o.loadMore=n.NearNeedBook.loadMore,o.hasMore=n.NearNeedBook.hasMore,o.setMajorFilter=n.NearNeedBook.setMajorFilter,o.getMajorFilter=n.NearNeedBook.getMajorFilter):"isbnUsed"==o.cmd?(o.title="对应要卖的旧书",o.isbn13=e.isbn13,o.jsonUsedBooks=t.ISBN_sell.nowEqualISBNJsonUsedBookList,o.loadMore=t.ISBN_sell.loadMoreUsedBookEqualISBN,o.hasMore=t.ISBN_sell.hasMore):"isbnNeed"==o.cmd&&(o.title="需要这本书的同学",o.isbn13=e.isbn13,o.jsonUsedBooks=t.ISBN_need.nowEqualISBNJsonNeedBookList,o.loadMore=t.ISBN_need.loadMoreNeedBookEqualISBN,o.hasMore=t.ISBN_need.hasMore),s.registerChooseMajorModalView(o,function(e){o.setMajorFilter&&o.setMajorFilter(e)})}]),APP.controller("hello",["$scope","$state","$stateParams","$ionicHistory","WeChatJS$","User$",function(o,e,t,n,s,i){i.loginWithUnionId(readCookie("unionId")).done(function(){e.go("tab.person_my"),n.clearHistory()}),o.OAuthURL=s.getOAuthURL()}]),APP.controller("person_editOneUsedBook",["$scope","$state","$ionicHistory","$stateParams","UsedBook$",function(o,e,t,n,s){var i=n.usedBookId;o.avosUsedBook=AV.Object.createWithoutData("UsedBook",i),o.avosUsedBook.fetch().done(function(){o.jsonUsedBookChangeInfo=s.avosUsedBookToJson(o.avosUsedBook),o.$apply()}),o.valueHasChange=!1,o.submitOnClick=function(){o.avosUsedBook.set("des",o.jsonUsedBookChangeInfo.des),o.avosUsedBook.set("price",o.jsonUsedBookChangeInfo.price),o.avosUsedBook.save(null).done(function(){"sell"==o.avosUsedBook.get("role")?(s.loadMyAvosUsedBookList(),e.go("tab.person_usedBooksList")):"need"==o.avosUsedBook.get("role")&&(s.loadMyAvosNeedBookList(),
e.go("tab.person_needBooksList")),t.clearHistory()}).fail(function(o){alert(o.message)})}}]),APP.controller("person_editPersonInfo",["$scope","$state","$ionicHistory","InfoService$","User$","IonicModalView$",function(o,e,t,n,s,i){o.attrHasChange=!1,o.userInfo=s.getCurrentJsonUser(),i.registerChooseSchoolModalView(o,function(e){o.attrHasChange=!0,o.userInfo.school=e}),i.registerChooseMajorModalView(o,function(e){o.attrHasChange=!0,o.userInfo.major=e}),o.startSchoolYearOptions=n.startSchoolYearOptions,o.confirmWechatAlert=function(){0==o.userInfo.wechatAlert&&(o.userInfo.wechatAlert=!window.confirm("关闭后有同学给你发消息时你将收不到通知,确定关闭吗?"))},o.submitOnClick=function(){var n=readCookie("unionId");s.loginWithUnionId(n).done(function(n){n.fetchWhenSave(!0),n.save({school:o.userInfo.school,major:o.userInfo.major,startSchoolYear:o.userInfo.startSchoolYear,wechatAlert:o.userInfo.wechatAlert}).done(function(){alert("修改成功")}).fail(function(o){alert("修改失败:"+o.message)}).always(function(){e.go("tab.person_my"),t.clearHistory()})})}}]),APP.controller("person_my",["$scope","$state","$stateParams","User$","Status$",function(o,e,t,n,s){function i(){o.userInfo=n.getCurrentJsonUser();var e=n.getCurrentAvosUser().relation("usedBooks"),t=e.query();t.equalTo("role","sell"),t.count().done(function(e){o.myUsedBookNumber=e,o.$apply()}),t=e.query(),t.equalTo("role","need"),t.count().done(function(e){o.myNeedBookNumber=e,o.$apply()}),t=AV.User.current().followeeQuery(),t.count().done(function(e){o.followeeNumber=e,o.$apply()}),t=AV.User.current().followerQuery(),t.count().done(function(e){o.followerNumber=e,o.$apply()}),s.loadUnreadStatusesCount()}o.Status$=s,o.$on("$ionicView.afterEnter",i),o.logOut=function(){AV.User.logOut(),eraseCookie("unionId"),wx.closeWindow()}}]),APP.controller("person_needBookList",["$scope","$ionicScrollDelegate","UsedBook$",function(o,e,t){o.UsedBook$=t,t.loadMyAvosNeedBookList(),o.$on("$ionicView.afterEnter",function(){e.scrollTop(!0)})}]),APP.controller("person_sendMsgToUser",["$scope","$state","$stateParams","$ionicHistory","$ionicScrollDelegate","User$","UsedBook$","Status$",function(o,e,t,n,s,i,a,r){function l(){var e=r.makeQueryStatusList_twoUser(u,o.msg.usedBookObjectId);e.skip(o.jsonStatusList.length),e.find().done(function(e){for(var t=0;t<e.length;t++)o.jsonStatusList.push(r.avosStatusToJson(e[t]));s.scrollBottom(!0),o.$apply()})}var u=t.receiverObjectId;o.isLoading=!1,o.msg={inboxType:t.inboxType,role:t.role,sendMsg:"",usedBookObjectId:t.usedBookObjectId},o.nowModel=function(){if("private"==o.msg.inboxType){if("sell"==o.msg.role)return"回应卖家的私信";if("buy"==o.msg.role)return"给图书主人发私信"}else if("reviewUsedBook"==o.msg.inboxType){if("sell"==o.msg.role)return"回复买家对旧书的评论";if("buy"==o.msg.role)return"对主人的旧书发表评论"}},AV.Object.createWithoutData("_User",u).fetch().done(function(e){o.jsonUser=avosUserToJson(e),o.$apply()}),o.jsonStatusList=[],o.commonReplayWords=[],o.commonReplayWords="sell"==o.msg.role?["求微信号","成交","不能再便宜了","这本书已经卖出去了"]:["求微信号","成交","可以再便宜点吗?","你在什么地方?","书有破损吗?"],o.msg.usedBookObjectId&&a.getJsonUsedBookByAvosObjectId(o.msg.usedBookObjectId,function(e){o.jsonUsedBook=e,o.$apply()}),o.sendOnClick=function(){o.isLoading=!0;var e;"private"==o.msg.inboxType?e=r.sendPrivateMsg(u,o.msg.sendMsg,o.msg.role,o.msg.usedBookObjectId):"reviewUsedBook"==o.msg.inboxType&&(e=r.reviewUsedBook(u,o.msg.usedBookObjectId,o.msg.sendMsg,o.msg.role)),e.done(function(){o.jsonStatusList.push({message:o.msg.sendMsg}),s.scrollBottom(!0)}).fail(function(o){alert("发送失败:"+JSON.stringify(o))}).always(function(){o.isLoading=!1,o.msg.sendMsg="",o.$apply()})};var d;o.$on("$ionicView.afterEnter",function(){d=setInterval(function(){r.makeQueryStatusList_twoUser(u,o.msg.usedBookObjectId).count().done(function(e){e>o.jsonStatusList.length&&l()}),r.loadUnreadStatusesCount()},1e3)}),o.$on("$ionicView.afterLeave",function(){clearInterval(d)})}]),APP.controller("person_statusList",["$scope","$stateParams","Status$",function(o,e,t){o.cmd=e.cmd,"newUsedBook"==o.cmd?(o.title="同学新上传的旧书",o.avosStatusList=t.NewUsedBookStatus.avosStatusList,t.NewUsedBookStatus.load()):"newNeedBook"==o.cmd?(o.title="同学新发布的求书",o.avosStatusList=t.NewNeedBookStatus.avosStatusList,t.NewNeedBookStatus.load()):"private"==o.cmd?(o.title="你收到的私信",o.avosStatusList=t.PrivateStatus.avosStatusList,t.PrivateStatus.load()):"reviewUsedBook"==o.cmd&&(o.title="同学对你的书的评论",o.avosStatusList=t.ReviewUsedBookStatus.avosStatusList,t.ReviewUsedBookStatus.load())}]),APP.controller("person_uploadOneUsedBook",["$scope","$state","$stateParams","$ionicHistory","$ionicScrollDelegate","$ionicModal","DoubanBook$","WeChatJS$","UsedBook$","User$",function(o,e,t,n,s,i,a,r,l,u){function d(){o.isLoading=!0,a.getBookByISBD_simple(o.usedBookInfo.isbn13,function(t){t?(o.doubanBookInfo=t,o.usedBookInfo.isbn13=t.isbn13,o.isLoading=!1,o.usedBookInfo.image=t.image.replace("mpic","lpic"),o.usedBookInfo.title=t.title,o.$apply()):(alert("没有找到图书信息,再去搜搜看~"),e.go("tab.book_searchList"))})}o.isLoading=!1,o.WeChatJS$=r,o.$on("$ionicView.afterEnter",function(){o.usedBookInfo={isbn13:t.isbn13,price:null,des:"",image:"",title:""},s.scrollTop(),o.usedBookInfo.isbn13&&d(),o.usedBookInfo.owner=u.getCurrentAvosUser()}),i.fromTemplateUrl("template/helpModalView.html",{scope:o}).then(function(e){o.noBarCodeModalView=e}),o.scanQRBtnOnClick=function(){r.scanQRCode(function(e){o.usedBookInfo.isbn13=e,d()})},o.submitOnClick=function(t){o.usedBookInfo.role=t,o.isLoading=!0;var s=l.jsonUsedBookToAvos(o.usedBookInfo);s.save(null).done(function(){"sell"==t?(l.loadMyAvosUsedBookList(),e.go("tab.person_usedBooksList")):"need"==t&&(l.loadMyAvosNeedBookList(),e.go("tab.person_needBooksList")),n.clearHistory()}).fail(function(o){alert(o.message)}).always(function(){o.isLoading=!1,o.$apply()})},o.commonWords=["正版","新书","送笔记","可议价","不议价","配光盘","妹子白送"]}]),APP.controller("person_usedBookList",["$scope","$ionicScrollDelegate","UsedBook$",function(o,e,t){o.UsedBook$=t,t.loadMyAvosUsedBookList(),o.$on("$ionicView.afterEnter",function(){e.scrollTop(!0)})}]),APP.controller("signUp",["$scope","$timeout","$state","$stateParams","$ionicHistory","$ionicModal","WeChatJS$","InfoService$","User$","Status$","IonicModalView$",function(o,e,t,n,s,i,a,r,l,u,d){o.isLoading=!0;var c=n.code,b="tab.person_my";a.getOAuthUserInfo(c,function(e){o.isLoading=!1,o.userInfo=e,l.loginWithUnionId(e.unionId).done(function(o){u.loadUnreadStatusesCount(),t.go(b),s.clearHistory(),o.set("avatarUrl",e.avatarUrl),o.set("nickName",e.nickName),o.set("sex",e.sex),o.save()}),o.$apply()},function(){alert("要先关注书循微信号哦"),window.location.href="http://mp.weixin.qq.com/s?__biz=MzAwMDQwMjMxNg==&mid=205566574&idx=1&sn=5784b3b5f4d870ca4715c2dd56d8f01e#rd"}),d.registerChooseSchoolModalView(o,function(e){o.userInfo.school=e}),d.registerChooseMajorModalView(o,function(e){o.userInfo.major=e}),o.startSchoolYearOptions=r.startSchoolYearOptions,o.submitOnClick=function(){o.isLoading=!0,l.signUpWithJSONUser(o.userInfo).done(function(){t.go(b),s.clearHistory()}).fail(function(o){alert(o.message)}).always(function(){o.isLoading=!1,o.$apply()})}}]),angular.module("APP").run(["$templateCache",function(o){o.put("temp/tabs.html",'<ion-tabs ng-controller="tabs" class="tabs-icon-top"><ion-tab title="图书" icon-on="ion-ios-book balanced" icon-off="ion-ios-book-outline" ui-sref="tab.book_recommend"><ion-nav-view name="tab-book"></ion-nav-view></ion-tab><ion-tab title="个人" icon-on="ion-ios-person balanced" icon-off="ion-ios-person-outline" ui-sref="tab.person_my" badge="Status$.NewUsedBookStatus.unreadCount>0 || Status$.NewNeedBookStatus.unreadCount>0 || Status$.PrivateStatus.unreadCount>0 || Status$.ReviewUsedBookStatus.unreadCount>0 ? \'.\' : null" badge-style="badge-assertive"><ion-nav-view name="tab-person"></ion-nav-view></ion-tab></ion-tabs>'),o.put("temp/book/bookList.html",'<ion-view ng-controller="book_bookList" view-title="{{title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><ion-list><ion-item class="item-thumbnail-left" collection-repeat="book in books" ui-sref="tab.book_oneBook({isbn13:book.isbn13})"><img ng-src="{{book.image}}"><h2>{{book.title}}</h2><p ng-if="book[\'publisher\']">{{book[\'publisher\']}}/{{book[\'pubdate\']}}</p><p ng-if="book[\'author\']">{{book[\'author\'].toString()}}</p><p ng-if="book.price">{{book.price}}</p></ion-item></ion-list><ion-infinite-scroll ng-if="hasMore()" on-infinite="loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-view>'),o.put("temp/book/bookReview.html",'<ion-view ng-controller="book_bookReview" view-title="{{title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><ion-item ng-repeat="one in BookReview.reviewList" class="item-avatar"><img ng-src="{{one.avatarUrl}}"><h3>{{one.title}}</h3><p style="white-space: pre-wrap">{{one.context}}</p></ion-item><ion-infinite-scroll ng-if="BookReview.hasMore()" on-infinite="BookReview.loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-view>'),o.put("temp/book/oneBook.html",'<ion-view ng-controller="book_oneBook" view-title="{{book.title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><div style="text-align: center;padding-top: 10px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><div class="list card"><ion-item style="text-align: center"><img ng-src="{{book.image}}" style="height: 180px" ng-click="WeChatJS$.previewOneImage(book.image)"></ion-item><ion-item ng-if="book.summary" class="item-button-right"><h3>简介</h3><p style="white-space: pre-wrap">{{book.summary.substr(0,30)}}...</p><button class="button button-clear button-balanced" ng-click="showSummary()">详情</button></ion-item><ion-item ng-if="book[\'author\'].length>0" class="item-button-right">{{book[\'author\'].toString()}} 著 <button class="button button-small button-clear button-balanced" ng-if="book[\'author_intro\']" ng-click="showAuthorIntro()">作者简介</button></ion-item><ion-item class="item-button-right"><i ng-if="book.price">定价:{{book.price}}</i> <i>&nbsp;</i> <i ng-if="book[\'publisher\']">{{book[\'publisher\']}}/{{book[\'pubdate\']}}</i> <button class="button button-small button-clear button-balanced" ng-click="showPubInfo()">出版</button></ion-item><ion-item ng-if="book[\'rating\']" class="item-button-right"><review-star num-stars="{{book[\'rating\'][\'average\']/2}}" score="{{book[\'rating\'][\'average\']}}" num-raters="{{book[\'rating\'][\'numRaters\']}}"></review-star><button class="button button-small button-clear button-balanced" ui-sref="tab.book_bookReview({doubanBookId:book.id,bookTitle:book.title})">书评</button></ion-item></div><div class="list card" ng-if="businessInfos.length>0"><ion-item class="item-divider">购买新书</ion-item><ion-item style="white-space:normal"><a class="button button-small button-outline button-balanced" style="margin: 5px" ng-repeat="info in businessInfos | orderBy:\'price\'" ng-href="{{info.url}}">{{info.name}}/{{info.price}}</a></ion-item></div><div class="list card"><ion-item class="item-divider item-button-right">要卖对应旧书的同学 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneUsedBook({isbn13:book.isbn13})">上传旧书</button></ion-item><ion-item ng-if="usedBookNumber==0" style="text-align: center">还没有对应的二手书</ion-item><ion-item ng-if="UsedBook$.ISBN_sell.nowEqualISBNJsonUsedBookList.length>0" ng-repeat="oneJsonUsedBook in UsedBook$.ISBN_sell.nowEqualISBNJsonUsedBookList" class="item-avatar"><img ng-src="{{User$.changeWechatAvatarSize(oneJsonUsedBook.owner.get(\'avatarUrl\'),64)}}" ui-sref="tab.userHome({ownerId:oneJsonUsedBook.owner.id})"><div ui-sref="tab.book_oneUsedBook({usedBookAvosObjectId:oneJsonUsedBook.objectId})"><h3 style="white-space: pre-wrap">{{oneJsonUsedBook.price}}元 {{oneJsonUsedBook.des}}</h3><p>上传于:{{oneJsonUsedBook.updatedAt | date:\'mediumDate\' }}</p></div></ion-item><ion-item ng-if="UsedBook$.ISBN_sell.nowEqualISBNJsonUsedBookList.length>0" style="padding: 0;text-align: center"><a class="button button-small button-clear button-balanced" ui-sref="tab.book_usedBookList({cmd:\'isbnUsed\',isbn13:isbn13})">共{{usedBookNumber}}本旧书,查看全部</a></ion-item></div><div class="list card"><ion-item class="item-divider item-button-right">正需要它的同学 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneNeedBook({isbn13:book.isbn13})">发布求书</button></ion-item><ion-item ng-if="needBookNumber==0" style="text-align: center">还没有同学想要它</ion-item><ion-item ng-if="UsedBook$.ISBN_need.nowEqualISBNJsonNeedBookList.length>0" ng-repeat="oneJsonUsedBook in UsedBook$.ISBN_need.nowEqualISBNJsonNeedBookList" class="item-avatar"><img ng-src="{{User$.changeWechatAvatarSize(oneJsonUsedBook.owner.get(\'avatarUrl\'),64)}}" ui-sref="tab.userHome({ownerId:oneJsonUsedBook.owner.id})"><div ui-sref="tab.book_oneNeedBook({usedBookAvosObjectId:oneJsonUsedBook.objectId})"><p ng-if="oneJsonUsedBook.price">最高承受{{oneJsonUsedBook.price}}元</p><p ng-if="oneJsonUsedBook.des">{{oneJsonUsedBook.des}}</p><p>发布于:{{oneJsonUsedBook.updatedAt | date:\'mediumDate\' }}</p></div></ion-item><ion-item ng-if="UsedBook$.ISBN_need.nowEqualISBNJsonNeedBookList.length>0" style="padding: 0;text-align: center"><a class="button button-small button-clear button-balanced" ui-sref="tab.book_usedBookList({cmd:\'isbnNeed\',isbn13:isbn13})">共{{needBookNumber}}位同学想要这本书,查看全部</a></ion-item></div></ion-content></ion-view>'),o.put("temp/book/oneNeedBook.html",'<ion-view ng-controller="book_oneUsedBook" view-title="求书 {{jsonUsedBook.title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><div class="list card"><ion-item ng-if="jsonUsedBook.image" style="text-align: center"><img ng-src="{{jsonUsedBook.image}}" style="height: 180px" ng-click="WeChatJS$.previewOneImage(jsonUsedBook.image)"></ion-item><ion-item ui-sref="tab.book_oneBook({isbn13:jsonUsedBook.isbn13})"><h3>书名:{{jsonUsedBook.title}}</h3><p>最高承受价:{{jsonUsedBook.price}}</p><p>发布时间:{{jsonUsedBook.updatedAt | date:\'mediumDate\' }}</p><p ng-if="jsonUsedBook.des" style="white-space: pre-wrap">附加描述:{{jsonUsedBook.des}}</p></ion-item></div><div class="list card"><ion-item class="item-divider item-button-right">求书同学信息 <a class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_sendMsgToUser({receiverObjectId:ownerInfo.objectId,usedBookObjectId:usedBookObjectId,role:\'buy\',inboxType:\'private\'})">私信主人</a></ion-item><user-info json-user-info="ownerInfo" used-book-object-id="jsonUsedBook.objectId"></user-info></div><div class="list card"><ion-item class="item-divider item-button-right">大家都说 <a class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_sendMsgToUser({receiverObjectId:ownerInfo.objectId,usedBookObjectId:usedBookObjectId,role:\'buy\',inboxType:\'reviewUsedBook\'})">我也要说</a></ion-item><ion-item ng-if="jsonStatusList.length==0">还没有同学评论,快来抢沙发~</ion-item><ion-item class="item-avatar" ng-repeat="jsonStatus in jsonStatusList"><img ng-src="{{User$.changeWechatAvatarSize(jsonStatus.source.get(\'avatarUrl\'),64)}}" ui-sref="tab.userHome({ownerId:jsonStatus.source.id})"><h2 style="white-space: pre-wrap">{{jsonStatus.message}}</h2><p>{{jsonStatus.updatedAt | date:\'mediumDate\'}}</p><img style="width: 40px;height: 40px;position: absolute;top: 16px;right: 16px;border-radius: 50%" ui-sref="tab.userHome({ownerId:jsonStatus.to.id})" ng-src="{{User$.changeWechatAvatarSize(jsonStatus.to.get(\'avatarUrl\'),64)}}"></ion-item></div></ion-content></ion-view>'),o.put("temp/book/oneUsedBook.html",'<ion-view ng-controller="book_oneUsedBook" view-title="二手 {{jsonUsedBook.title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><div class="list card"><ion-item ng-if="jsonUsedBook.image" style="text-align: center"><img ng-src="{{jsonUsedBook.image}}" style="height: 180px" ng-click="WeChatJS$.previewOneImage(jsonUsedBook.image)"></ion-item><ion-item ui-sref="tab.book_oneBook({isbn13:jsonUsedBook.isbn13})"><h3>书名:{{jsonUsedBook.title}}</h3><p>要价:{{jsonUsedBook.price}}</p><p>上传时间:{{jsonUsedBook.updatedAt | date:\'mediumDate\' }}</p><p ng-if="jsonUsedBook.des" style="white-space: pre-wrap">主人描述:{{jsonUsedBook.des}}</p></ion-item></div><div class="list card"><ion-item class="item-divider item-button-right">旧书主人信息 <a class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_sendMsgToUser({receiverObjectId:ownerInfo.objectId,usedBookObjectId:usedBookObjectId,role:\'buy\',inboxType:\'private\'})">私信主人</a></ion-item><user-info json-user-info="ownerInfo" used-book-object-id="jsonUsedBook.objectId"></user-info></div><div class="list card"><ion-item class="item-divider item-button-right">大家都说 <a class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_sendMsgToUser({receiverObjectId:ownerInfo.objectId,usedBookObjectId:usedBookObjectId,role:\'buy\',inboxType:\'reviewUsedBook\'})">发表评论</a></ion-item><ion-item ng-if="jsonStatusList.length==0">还没有同学评论,快来抢沙发~</ion-item><ion-item class="item-avatar" ng-repeat="jsonStatus in jsonStatusList"><img ng-src="{{User$.changeWechatAvatarSize(jsonStatus.source.get(\'avatarUrl\'),64)}}" ui-sref="tab.userHome({ownerId:jsonStatus.source.id})"><h2 style="white-space: pre-wrap">{{jsonStatus.message}}</h2><p>{{jsonStatus.updatedAt | date:\'mediumDate\'}}</p><img style="width: 40px;height: 40px;position: absolute;top: 16px;right: 16px;border-radius: 50%" ui-sref="tab.userHome({ownerId:jsonStatus.to.id})" ng-src="{{User$.changeWechatAvatarSize(jsonStatus.to.get(\'avatarUrl\'),64)}}"></ion-item></div></ion-content></ion-view>'),o.put("temp/book/recommend.html",'<ion-view ng-controller="book_recommend" view-title="书循"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><div ng-if="BookRecommend$[\'BookTag\'][\'tag\']"><ion-item class="item-divider item-button-right">图书分类 <button class="button button-small button-clear button-balanced" style="top: 0" ng-click="bookTagsModalView.show()">更多</button></ion-item><ion-item style="white-space:normal"><button class="button button-small button-outline button-balanced" style="margin: 5px" ui-sref="tab.book_bookList({cmd:\'tag\',tag:tag})" ng-repeat="tag in BookRecommend$[\'BookTag\'].getTagAttrNames()">{{tag}}</button></ion-item></div><div ng-if="LatestBook.jsonBooks.length>0"><ion-item class="item-divider item-button-right">新书速递 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.book_bookList({cmd:\'new\'})">更多</button></ion-item><douban-book-one-line json-books-info="LatestBook.jsonBooks"></douban-book-one-line></div><div ng-if="BookRecommend$.NearUsedBook.jsonBooks.length>0"><ion-item class="item-divider item-button-right">附近卖书 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.book_usedBookList({cmd:\'nearUsed\'})">更多</button></ion-item><used-book-one-line json-books-info="BookRecommend$.NearUsedBook.jsonBooks"></used-book-one-line></div><div ng-if="BookRecommend$.NearUser.jsonUsers.length>0"><ion-item class="item-divider item-button-right">附近同学 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.userList({cmd:\'near\'})">更多</button></ion-item><ion-item style="padding: 0;text-align: center"><img ng-repeat="one in BookRecommend$.NearUser.jsonUsers" ng-if="one.avatarUrl" ng-src="{{User$.changeWechatAvatarSize(one.avatarUrl,64)}}" ui-sref="tab.userHome({ownerId:one.objectId})" style="width: 40px;height: 40px;border-radius: 50%;overflow: hidden;margin: 5px"></ion-item></div><div ng-if="BookRecommend$.NearNeedBook.jsonBooks.length>0"><ion-item class="item-divider item-button-right">附近求书 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.book_usedBookList({cmd:\'nearNeed\'})">更多</button></ion-item><used-book-one-line json-books-info="BookRecommend$.NearNeedBook.jsonBooks"></used-book-one-line></div><div ng-if="BookRecommend$.MajorBook.books.length>0"><ion-item class="item-divider item-button-right">{{BookRecommend$.MajorBook.major}} <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.book_bookList({cmd:\'major\'})">更多</button></ion-item><douban-book-one-line json-books-info="BookRecommend$.MajorBook.books"></douban-book-one-line></div></ion-content><script type="text/ng-template" id="template/bookTags.html"><ion-modal-view>\n            <ion-header-bar class="item-input-inset">\n                <h1 class="title">图书热门分类</h1>\n                <button class="button button-clear button-balanced"\n                        ng-click="bookTagsModalView.hide()">返回\n                </button>\n            </ion-header-bar>\n            <ion-content class="has-header">\n                <ion-list>\n                    <div ng-repeat="bigTag in BookRecommend$[\'BookTag\'].getTagAttrNames()">\n                        <ion-item class="item-divider item-button-right">{{bigTag}}</ion-item>\n                        <ion-item style="white-space:normal">\n                            <button class="button button-small button-outline button-balanced" style="margin: 5px"\n                                    ui-sref="tab.book_bookList({cmd:\'tag\',tag:tag})"\n                                    ng-click="bookTagsModalView.hide()"\n                                    ng-repeat="tag in BookRecommend$[\'BookTag\'][\'tag\'][bigTag]">\n                                {{tag}}\n                            </button>\n                        </ion-item>\n                    </div>\n                </ion-list>\n            </ion-content>\n        </ion-modal-view></script></ion-view>'),o.put("temp/book/searchList.html",'<ion-view view-title="图书搜索"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content ng-controller="book_searchList"><ion-list><ion-item class="item-input-inset"><button class="button button-small button-clear" ng-click="scanQRBtnOnClick()">扫码</button><label class="item-input-wrapper"><i class="icon ion-search placeholder-icon"></i> <input type="search" placeholder="书名 作者 ISBN" ng-model="SearchBook$.keyword" ng-change="SearchBook$.searchInputOnChange()"></label><button class="button button-small button-clear" ng-click="SearchBook$.searchBtnOnClick()">搜索</button></ion-item><ion-item class="item-thumbnail-left" collection-repeat="book in SearchBook$.books" ui-sref="tab.book_oneBook({isbn13:book.isbn13})"><img ng-src="{{book.image}}"><h2>{{book.title}}</h2><p ng-if="book[\'publisher\']">{{book[\'publisher\']}}/{{book[\'pubdate\']}}</p><p ng-if="book[\'author\']">{{book[\'author\'].toString()}}</p><p ng-if="book.price">{{book.price}}</p></ion-item></ion-list><ion-infinite-scroll ng-if="SearchBook$.hasMore()" on-infinite="SearchBook$.loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-view>'),o.put("temp/book/usedBookList.html",'<ion-view ng-controller="book_usedBookList" view-title="{{title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><div class="button-bar padding"><a class="button button-small" ng-click="sortWay=\'price\'" ng-class="{\'button-balanced\':sortWay==\'price\'}">图书价格</a> <a class="button button-small" ng-click="sortWay=\'location\'" ng-class="{\'button-balanced\':sortWay==\'location\'}">离你距离</a> <a class="button button-small" ng-click="chooseMajorModalView.show()">{{getMajorFilter() ? getMajorFilter() :\'主人专业\'}}</a></div><ion-list><one-used-book ng-if="cmd==\'nearUsed\' || cmd ==\'isbnUsed\'" ng-repeat="jsonUsedBook in jsonUsedBooks | orderBy:sortWay" json-used-book="jsonUsedBook"></one-used-book><one-need-book ng-if="cmd==\'nearNeed\' || cmd == \'isbnNeed\'" ng-repeat="jsonNeedBook in jsonUsedBooks | orderBy:sortWay" json-need-book="jsonNeedBook"></one-need-book></ion-list><ion-infinite-scroll ng-if="hasMore()" on-infinite="loadMore(isbn13)" distance="1%"></ion-infinite-scroll></ion-content></ion-view>'),o.put("temp/person/editOneUsedBook.html",'<ion-view ng-controller="person_editOneUsedBook" view-title="编辑你的{{avosUsedBook.get(\'title\')}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content class="padding"><div class="list card"><ion-item style="text-align: center"><img ng-src="{{avosUsedBook.get(\'image\')}}" style="height: 180px"></ion-item></div><div class="list card"><label class="item item-input item-stacked-label"><span class="input-label">价格</span> <input type="number" placeholder="人民币 只输入数值" ng-model="jsonUsedBookChangeInfo.price" ng-change="valueHasChange=true"></label><label class="item item-input item-stacked-label"><span class="input-label">描述</span> <input type="text" placeholder="这书有什么特别之处" ng-model="jsonUsedBookChangeInfo.des" ng-change="valueHasChange=true"></label></div><button class="button button-block button-outline button-balanced" ng-click="submitOnClick()" ng-disabled="!valueHasChange">提交修改</button></ion-content></ion-view>'),o.put("temp/person/editPersonInfo.html",'<ion-view ng-controller="person_editPersonInfo" view-title="修改你的信息"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content class="padding"><user-info json-user-info="userInfo"></user-info><div class="list list-inset"><ion-item class="item-icon-right" ng-click="chooseSchoolModalView.show()">在读学校 <span class="item-note" ng-if="userInfo.school">{{userInfo.school}}</span> <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item class="item-icon-right" ng-click="chooseMajorModalView.show()">所学专业 <span class="item-note" ng-if="userInfo.major">{{userInfo.major}}</span> <i class="icon ion-ios-arrow-right balanced"></i></ion-item><label class="item item-input item-select"><span class="input-label">大学入学时间</span><select ng-model="userInfo.startSchoolYear" ng-change="attrHasChange=true" ng-options="one as one for one in startSchoolYearOptions"></select></label><ion-toggle ng-model="userInfo.wechatAlert" ng-change="attrHasChange=true;confirmWechatAlert()">消息提醒</ion-toggle></div><button class="button button-block button-outline button-balanced" ng-click="submitOnClick()" ng-disabled="!attrHasChange">提交修改</button></ion-content></ion-view>'),o.put("temp/person/my.html",'<ion-view ng-controller="person_my" view-title="我的书循"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ng-click="logOut()">退出</button></ion-nav-buttons><ion-content><ion-item ng-if="Status$.NewUsedBookStatus.unreadCount>0" ui-sref="tab.person_statusList({cmd:\'newUsedBook\'})">你关注的同学新上传了旧书<span class="badge badge-assertive">{{Status$.NewUsedBookStatus.unreadCount}}</span></ion-item><ion-item ng-if="Status$.NewNeedBookStatus.unreadCount>0" ui-sref="tab.person_statusList({cmd:\'newNeedBook\'})">你关注的同学新发布了求书<span class="badge badge-assertive">{{Status$.NewNeedBookStatus.unreadCount}}</span></ion-item><ion-item ng-if="Status$.PrivateStatus.unreadCount>0" ui-sref="tab.person_statusList({cmd:\'private\'})">有同学给你发私信<span class="badge badge-assertive">{{Status$.PrivateStatus.unreadCount}}</span></ion-item><ion-item ng-if="Status$.ReviewUsedBookStatus.unreadCount>0" ui-sref="tab.person_statusList({cmd:\'reviewUsedBook\'})">有同学评价你的书<span class="badge badge-assertive">{{Status$.ReviewUsedBookStatus.unreadCount}}</span></ion-item><ion-item class="item-divider item-button-right">我的信息 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_editPersonInfo">修改信息</button></ion-item><user-info ng-if="userInfo" json-user-info="userInfo" hide-used-book="true"></user-info><ion-item class="item-divider item-button-right">我发布的求书 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneNeedBook">发布求书</button></ion-item><ion-item ng-if="myNeedBookNumber>0" ui-sref="tab.person_needBooksList" class="item-icon-right">已发布{{myNeedBookNumber}}个求书 <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item class="item-divider item-button-right">我上传的旧书 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneUsedBook">上传旧书</button></ion-item><ion-item ng-if="myUsedBookNumber>0" ui-sref="tab.person_usedBooksList" class="item-icon-right">已上传{{myUsedBookNumber}}本旧书 <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item class="item-divider item-button-right">我关注的同学 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.userList({cmd:\'near\'})">附近同学</button></ion-item><ion-item ng-if="followeeNumber>0" ui-sref="tab.userList({cmd:\'followee\'})" class="item-icon-right">已关注{{followeeNumber}}位同学 <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item ng-if="followeeNumber==0" ui-sref="tab.userList({cmd:\'near\'})">你还没有关注的同学,去逛逛</ion-item><ion-item class="item-divider">我的粉丝</ion-item><ion-item ng-if="followerNumber>0" ui-sref="tab.userList({cmd:\'follower\'})" class="item-icon-right">有{{followerNumber}}位同学关注我 <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item ng-if="followerNumber==0" ui-sref="tab.userList({cmd:\'follower\'})" class="item-icon-right">还没有粉丝,去发点什么吧</ion-item></ion-content></ion-view>'),o.put("temp/person/needBookList.html",'<ion-view ng-controller="person_needBookList" view-title="管理我发布的求书"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content><ion-list><div style="text-align: center;margin: 10px" ng-if="UsedBook$.isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><ion-item class="item-divider item-button-right">正在求书 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneNeedBook">发布求书</button></ion-item><ion-item ng-repeat="oneAvosUsedBook in UsedBook$.myAvosNeedBookList" class="item-thumbnail-left"><img ng-if="oneAvosUsedBook.get(\'image\')" ng-src="{{oneAvosUsedBook.get(\'image\')}}" ui-sref="tab.book_oneBook({isbn13:oneAvosUsedBook.get(\'isbn13\')})"><p ng-if="oneAvosUsedBook.get(\'price\')">最高承受价格:{{oneAvosUsedBook.get(\'price\')}}</p><p ng-if="oneAvosUsedBook.get(\'title\')">书名:{{oneAvosUsedBook.get(\'title\')}}</p><p ng-if="oneAvosUsedBook.get(\'des\')">描述:{{oneAvosUsedBook.get(\'des\')}}</p><button class="button button-small button-outline button-assertive" ng-click="UsedBook$.removeUsedBook(oneAvosUsedBook)">已买删除</button> <button class="button button-small button-outline button-balanced" ui-sref="tab.person_editOneUsedBook({usedBookId:oneAvosUsedBook.id})">修改信息</button></ion-item><ion-item ng-if="UsedBook$.myAvosNeedBookList.length==0">你还没有发布过,点击发布求书</ion-item><ion-item ui-sref="tab.person_uploadOneNeedBook" style="text-align: center">继续发布求书</ion-item></ion-list></ion-content></ion-view>'),o.put("temp/person/sendMsgToUser.html",'<ion-view ng-controller="person_sendMsgToUser" view-title="回复{{jsonUser.nickName}}"><style>.message {\n            display: block;\n            clear: both;\n            border-radius: 10px;\n            padding: 5px;\n            margin: 5px;\n            max-width: 80%;\n            white-space: normal;\n        }</style><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content><user-info ng-if="jsonUser" json-user-info="jsonUser"></user-info><one-used-book ng-if="jsonUsedBook" json-used-book="jsonUsedBook"></one-used-book><ion-item style="margin: 0;padding: 0;border-right: none;border-left: none"><ol ng-if="jsonStatusList.length>0" style="margin: 5px;padding: 0;list-style-type:none"><li ng-repeat="jsonStatus in jsonStatusList" class="message" ng-style="{float:jsonStatus.source.id==jsonUser.objectId ? \'left\':\'right\',backgroundColor:jsonStatus.source.id==jsonUser.objectId ? \'#30bf4c\':\'#e6e5eb\'}">{{jsonStatus.message}}</li></ol></ion-item><ion-item class="item-divider" style="text-align: center" ng-if="nowModel()">{{nowModel()}}</ion-item><label class="item item-input"><input type="text" ng-model="msg.sendMsg" placeholder="输入回复内容"></label><button ng-disabled="!msg.sendMsg || isLoading" class="button button-block button-outline button-balanced" ng-click="sendOnClick()">发送</button><div style="text-align: center;padding-top: 10px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><ion-list ng-if="commonReplayWords.length>0"><ion-item class="item-divider item-button-right">快速回复内容</ion-item><ion-item style="white-space:normal;padding: 5px"><button class="button button-small button-outline button-balanced" style="margin: 5px" ng-disabled="isLoading" ng-repeat="word in commonReplayWords" ng-click="msg.sendMsg=word">{{word}}</button></ion-item></ion-list></ion-content></ion-view>'),
o.put("temp/person/statusList.html",'<ion-view ng-controller="person_statusList" view-title="{{title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content class="padding"><div class="card" ng-if="cmd==\'newUsedBook\'" ng-repeat="oneAvosStatus in avosStatusList"><one-used-book json-used-book="oneAvosStatus.jsonUsedBook"></one-used-book><user-info json-user-info="oneAvosStatus.jsonUserInfo"></user-info></div><div class="card" ng-if="cmd==\'newNeedBook\'" ng-repeat="oneAvosStatus in avosStatusList"><one-need-book json-need-book="oneAvosStatus.jsonUsedBook"></one-need-book><user-info json-user-info="oneAvosStatus.jsonUserInfo"></user-info></div><div class="card" ng-if="cmd==\'private\'" ng-repeat="oneAvosStatus in avosStatusList"><ion-item><p style="white-space: pre-wrap">{{oneAvosStatus.get(\'message\')}}</p><button style="float:right" class="button button-clear button-balanced button-small" ui-sref="tab.person_sendMsgToUser({receiverObjectId:oneAvosStatus.jsonUserInfo.objectId,role:oneAvosStatus.get(\'role\')==\'buy\' ? \'sell\' : \'buy\',inboxType:\'private\',usedBookObjectId:oneAvosStatus.jsonUsedBook.objectId})">回复私信</button></ion-item><one-used-book ng-if="oneAvosStatus.jsonUsedBook && oneAvosStatus.jsonUsedBook.role==\'sell\'" json-used-book="oneAvosStatus.jsonUsedBook"></one-used-book><one-need-book ng-if="oneAvosStatus.jsonUsedBook && oneAvosStatus.jsonUsedBook.role==\'need\'" json-need-book="oneAvosStatus.jsonUsedBook"></one-need-book><user-info json-user-info="oneAvosStatus.jsonUserInfo"></user-info></div><div class="card" ng-if="cmd==\'reviewUsedBook\'" ng-repeat="oneAvosStatus in avosStatusList"><ion-item><p style="white-space: pre-wrap">{{oneAvosStatus.get(\'message\')}}</p><button style="float:right" class="button button-clear button-balanced button-small" ui-sref="tab.person_sendMsgToUser({receiverObjectId:oneAvosStatus.jsonUserInfo.objectId,role:oneAvosStatus.get(\'role\')==\'buy\' ? \'sell\' : \'buy\',inboxType:\'reviewUsedBook\',usedBookObjectId:oneAvosStatus.jsonUsedBook.objectId})">回复评论</button></ion-item><one-used-book ng-if="oneAvosStatus.jsonUsedBook && oneAvosStatus.jsonUsedBook.role==\'sell\'" json-used-book="oneAvosStatus.jsonUsedBook"></one-used-book><one-need-book ng-if="oneAvosStatus.jsonUsedBook && oneAvosStatus.jsonUsedBook.role==\'need\'" json-need-book="oneAvosStatus.jsonUsedBook"></one-need-book><user-info json-user-info="oneAvosStatus.jsonUserInfo"></user-info></div><div class="card" ng-if="avosStatusList.length==0"><ion-item style="text-align: center">没有未读消息</ion-item></div></ion-content></ion-view>'),o.put("temp/person/uploadOneNeedBook.html",'<ion-view ng-controller="person_uploadOneUsedBook" view-title="发布求书"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content style="text-align: center" class="padding"><div style="text-align: center;padding-top: 10px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><div ng-if="!usedBookInfo.isbn13"><h5>获得你需要的图书信息</h5><button class="button button-outline button-balanced" ng-click="noBarCodeModalView.show()">开始获取</button><br><button class="button button-clear button-small button-balanced" ng-click="scanQRBtnOnClick()">扫码获得</button></div><div class="list card" ng-if="usedBookInfo.isbn13"><ion-item style="text-align: center"><img ng-src="{{doubanBookInfo.image}}" style="height: 180px" ng-click="WeChatJS$.previewOneImage(doubanBookInfo.image)"></ion-item><ion-item><p>{{doubanBookInfo.title}} <span ng-if="doubanBookInfo.price">{{doubanBookInfo.price}}</span></p><p ng-if="doubanBookInfo[\'author\'].length>0">{{doubanBookInfo[\'author\'].toString()}} 著</p><p ng-if="doubanBookInfo[\'publisher\']">{{doubanBookInfo[\'publisher\']}} {{doubanBookInfo[\'pubdate\']}}</p></ion-item></div><hr style="margin: 10px"><div class="list list-inset"><label class="item item-input"><input type="number" ng-model="usedBookInfo.price" placeholder="输入你最高承受价(数字,人民币元)"></label><label class="item item-input"><input type="text" ng-model="usedBookInfo.des" placeholder="对这本书你还有什么想说的吗?"></label></div><button ng-disabled="!(!isLoading && usedBookInfo.isbn13)" class="button button-block button-outline button-balanced" ng-click="submitOnClick(\'need\')">发布求书</button><ion-list ng-if="commonWords.length>0"><ion-item class="item-divider item-button-right">常用描述内容</ion-item><ion-item style="white-space:normal;padding: 5px"><button class="button button-small button-outline button-balanced" style="margin: 5px" ng-disabled="isLoading" ng-repeat="word in commonWords" ng-click="usedBookInfo.des=usedBookInfo.des+\' \'+word">{{word}}</button></ion-item></ion-list></ion-content><script type="text/ng-template" id="template/helpModalView.html"><ion-modal-view>\n            <ion-header-bar>\n                <h2 class="title">发布求书方法</h2>\n                <button class="button button-clear button-balanced"\n                        ng-click="noBarCodeModalView.hide()">返回\n                </button>\n            </ion-header-bar>\n            <ion-content class="padding" style="text-align: center">\n                <button class="button button-block button-outline button-balanced" ui-sref="tab.book_searchList"\n                        ng-click="noBarCodeModalView.hide()">\n                    开始获取\n                </button>\n                <img style="max-width: 98%" ng-src="img/uploadHelp.png">\n            </ion-content>\n        </ion-modal-view></script></ion-view>'),o.put("temp/person/uploadOneUsedBook.html",'<ion-view ng-controller="person_uploadOneUsedBook" view-title="上传二手书"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content style="text-align: center" class="padding"><div style="text-align: center;padding-top: 10px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><div ng-if="!usedBookInfo.isbn13"><h5>扫码书后面的条形码获得图书信息</h5><button class="button button-outline button-balanced" ng-click="scanQRBtnOnClick()">扫条形码</button><br><button class="button button-clear button-small button-balanced" ng-click="noBarCodeModalView.show()">没条码?</button></div><div class="list card" ng-if="usedBookInfo.isbn13"><ion-item style="text-align: center"><img ng-src="{{doubanBookInfo.image}}" style="height: 180px" ng-click="WeChatJS$.previewOneImage(doubanBookInfo.image)"></ion-item><ion-item><p>{{doubanBookInfo.title}} <span ng-if="doubanBookInfo.price">{{doubanBookInfo.price}}</span></p><p ng-if="doubanBookInfo[\'author\'].length>0">{{doubanBookInfo[\'author\'].toString()}} 著</p><p ng-if="doubanBookInfo[\'publisher\']">{{doubanBookInfo[\'publisher\']}} {{doubanBookInfo[\'pubdate\']}}</p></ion-item></div><hr style="margin: 10px"><div class="list list-inset"><label class="item item-input"><input type="number" ng-model="usedBookInfo.price" placeholder="输入要价(数字,人民币元)"></label><label class="item item-input"><input type="text" ng-model="usedBookInfo.des" placeholder="对这本书你还有什么想说的吗?"></label></div><button ng-disabled="!(!isLoading && usedBookInfo.isbn13 && usedBookInfo.price)" class="button button-block button-outline button-balanced" ng-click="submitOnClick(\'sell\')">提交二手书</button><ion-list ng-if="commonWords.length>0"><ion-item class="item-divider item-button-right">常用描述内容</ion-item><ion-item style="white-space:normal;padding: 5px"><button class="button button-small button-outline button-balanced" style="margin: 5px" ng-disabled="isLoading" ng-repeat="word in commonWords" ng-click="usedBookInfo.des=usedBookInfo.des+\' \'+word">{{word}}</button></ion-item></ion-list></ion-content><script type="text/ng-template" id="template/helpModalView.html"><ion-modal-view>\n            <ion-header-bar>\n                <h2 class="title">书没条码时上传方法</h2>\n                <button class="button button-clear button-balanced"\n                        ng-click="noBarCodeModalView.hide()">返回\n                </button>\n            </ion-header-bar>\n            <ion-content class="padding" style="text-align: center">\n                <button class="button button-block button-outline button-balanced" ui-sref="tab.book_searchList"\n                        ng-click="noBarCodeModalView.hide()">\n                    开始上传\n                </button>\n                <img style="max-width: 98%" ng-src="img/uploadHelp.png">\n            </ion-content>\n        </ion-modal-view></script></ion-view>'),o.put("temp/person/usedBookList.html",'<ion-view ng-controller="person_usedBookList" view-title="管理我上传的旧书"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content><div style="text-align: center;margin: 10px" ng-if="UsedBook$.isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><ion-list><ion-item class="item-divider item-button-right">正在架上 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneUsedBook">上传旧书</button></ion-item><ion-item ng-repeat="oneAvosUsedBook in UsedBook$.myAvosUsedBookList" class="item-thumbnail-left"><img ng-if="oneAvosUsedBook.get(\'image\')" ng-src="{{oneAvosUsedBook.get(\'image\')}}" ui-sref="tab.book_oneBook({isbn13:oneAvosUsedBook.get(\'isbn13\')})"><p ng-if="oneAvosUsedBook.get(\'price\')">要价:{{oneAvosUsedBook.get(\'price\')}}</p><p ng-if="oneAvosUsedBook.get(\'title\')">书名:{{oneAvosUsedBook.get(\'title\')}}</p><p ng-if="oneAvosUsedBook.get(\'des\')">描述:{{oneAvosUsedBook.get(\'des\')}}</p><button class="button button-small button-outline button-assertive" ng-click="UsedBook$.removeUsedBook(oneAvosUsedBook)">已卖删除</button> <button class="button button-small button-outline button-balanced" ui-sref="tab.person_editOneUsedBook({usedBookId:oneAvosUsedBook.id})">修改信息</button></ion-item><ion-item ng-if="UsedBook$.myAvosUsedBookList.length==0">你还没有上传过书,点击 上传旧书</ion-item><ion-item ui-sref="tab.person_uploadOneUsedBook" style="text-align: center">继续上传旧书</ion-item></ion-list></ion-content></ion-view>'),o.put("temp/tool/chooseMajorModalView.html",'<ion-modal-view><ion-header-bar class="item-input-inset"><label class="item-input-wrapper"><i class="icon ion-ios-search placeholder-icon balanced"></i> <input type="search" placeholder="输入专业名称搜索" ng-model="InfoService$.searchMajorKeyword"></label><button class="button button-clear button-balanced" ng-click="chooseMajorModalView.hide()">返回</button></ion-header-bar><ion-content class="has-header"><ul class="list"><ion-item item-height="55px" item-width="100%" collection-repeat="oneMajor in InfoService$.majors | filter:InfoService$.filter_majorByKeyword" ng-click="majorOnChoose(oneMajor[\'name\'])">{{oneMajor[\'name\']}}</ion-item></ul></ion-content></ion-modal-view>'),o.put("temp/tool/chooseSchoolModalView.html",'<ion-modal-view><ion-header-bar class="item-input-inset"><button class="button button-clear button-balanced" ng-click="InfoService$.School.loadMore()">搜索</button><label class="item-input-wrapper"><i class="icon ion-ios-search placeholder-icon balanced"></i> <input type="search" placeholder="输入名称搜索" ng-model="InfoService$.School.searchSchoolKeyword"></label><button class="button button-clear button-balanced" ng-click="chooseSchoolModalView.hide()">返回</button></ion-header-bar><ion-content class="has-header"><ul class="list"><ion-item item-height="55px" item-width="100%" collection-repeat="school in InfoService$.School.schools | filter:InfoService$.School.filter_schoolByKeyword" ng-click="schoolOnChoose(school)">{{school}}</ion-item></ul><ion-infinite-scroll on-infinite="InfoService$.School.loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-modal-view>'),o.put("temp/tool/doubanBookOneLineTemplate.html",'<ion-item style="text-align: center;padding: 0"><div ng-repeat="jsonBook in jsonBooksInfo.slice(0,showNumber)" ui-sref="tab.book_oneBook({isbn13:jsonBook.isbn13})" style="display: inline-block;padding: 5px;width: 80px;height: 120px"><img ng-if="jsonBook.image" ng-src="{{jsonBook.image}}" style="width: 70px;height: 100px"><h5 ng-if="jsonBook.title" class="title">{{jsonBook.title}}</h5></div></ion-item>'),o.put("temp/tool/hello.html",'<ion-view ng-controller="hello" view-title="需要验证你的身份"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content style="text-align: center"><hr style="margin: 30px"><a class="button button-outline button-balanced" ng-href="{{OAuthURL}}">进入书循</a></ion-content></ion-view>'),o.put("temp/tool/oneNeedBookTemplate.html",'<ion-item class="item-thumbnail-left" ui-sref="tab.book_oneNeedBook({usedBookAvosObjectId:jsonNeedBook.objectId})"><img ng-if="jsonNeedBook.image" ng-src="{{jsonNeedBook.image}}"><h3 ng-if="jsonNeedBook.price">最高承受价:{{jsonNeedBook.price}}</h3><p>时间:{{jsonNeedBook.updatedAt | date:\'mediumDate\' }}</p><p ng-if="jsonNeedBook.title">书名:{{jsonNeedBook.title}}</p><p ng-if="jsonNeedBook.des">描述:{{jsonNeedBook.des}}</p></ion-item>'),o.put("temp/tool/oneUsedBookTemplate.html",'<ion-item class="item-thumbnail-left" ui-sref="tab.book_oneUsedBook({usedBookAvosObjectId:jsonUsedBook.objectId})"><img ng-if="jsonUsedBook.image" ng-src="{{jsonUsedBook.image}}"><h3>要价:{{jsonUsedBook.price}}</h3><p>时间:{{jsonUsedBook.updatedAt | date:\'mediumDate\' }}</p><p ng-if="jsonUsedBook.title">书名:{{jsonUsedBook.title}}</p><p ng-if="jsonUsedBook.des">描述:{{jsonUsedBook.des}}</p></ion-item>'),o.put("temp/tool/signUp.html",'<ion-view ng-controller="signUp" view-title="加入书循"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content class="padding"><div style="text-align: center;margin: 5px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><div class="item item-avatar" ng-if="userInfo.openId"><img ng-src="{{userInfo.avatarUrl}}"><h2>{{userInfo.nickName}} <i class="icon ion-male" style="color: #5eb1ed" ng-if="userInfo.sex==1"></i> <i class="icon ion-female" style="color: #ff6d9e" ng-if="userInfo.sex==2"></i></h2></div><div class="list list-inset"><ion-item class="item-icon-right" ng-click="chooseSchoolModalView.show()">你在读的学校 <span class="item-note" ng-if="userInfo.school">{{userInfo.school}}</span> <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item class="item-icon-right" ng-click="chooseMajorModalView.show()">你所学的专业 <span class="item-note" ng-if="userInfo.major">{{userInfo.major}}</span> <i class="icon ion-ios-arrow-right balanced"></i></ion-item><label class="item item-input item-select"><span class="input-label">大学入学时间</span><select ng-model="userInfo.startSchoolYear"><option ng-repeat="one in startSchoolYearOptions" value="{{one}}">{{one}}</option></select></label></div><button class="button button-block button-outline button-balanced" ng-click="submitOnClick()" ng-disabled="isLoading || !(userInfo.school && userInfo.major && userInfo.startSchoolYear)">立即加入</button></ion-content></ion-view>'),o.put("temp/tool/titleAndPreModalView.html",'<ion-modal-view><ion-header-bar><h2 class="title">{{titleAndPreModalViewData.title}}</h2><button class="button button-clear button-balanced" ng-click="titleAndPreModalView.hide()">返回</button></ion-header-bar><ion-content class="padding"><pre>{{titleAndPreModalViewData.pre}}</pre></ion-content></ion-modal-view>'),o.put("temp/tool/usedBookOneLineTemplate.html",'<ion-item style="text-align: center;padding: 0"><div ng-repeat="jsonBook in jsonBooksInfo.slice(0,showNumber)" ui-sref="tab.book_oneBook({isbn13:jsonBook.isbn13})" style="display: inline-block;padding: 5px;width: 80px;height: 134px"><h5 class="title">{{jsonBook.des}}</h5><img ng-if="jsonBook.image" ng-src="{{jsonBook.image}}" style="width: 70px;height: 100px"><h5 class="title">{{jsonBook.title}}</h5></div></ion-item>'),o.put("temp/tool/userHome.html",'<ion-view ng-controller="userHome" view-title="主人的二手书"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content><ion-list><user-info json-user-info="jsonOwnerInfo" hide-used-book="true"></user-info><ion-item class="item-divider item-button-right">主人上传的二手书列表</ion-item><one-used-book ng-if="jsonUsedBookList.length>0" ng-repeat="oneJsonUsedBook in jsonUsedBookList" json-used-book="oneJsonUsedBook"></one-used-book><ion-item ng-if="jsonUsedBookList.length==0" ui-sref="tab.book_recommend">主人还没旧书要卖,再去逛逛</ion-item><ion-item class="item-divider item-button-right">主人发布的求书列表</ion-item><one-need-book ng-if="jsonNeedBookList.length>0" ng-repeat="oneJsonNeedBook in jsonNeedBookList" json-need-book="oneJsonNeedBook"></one-need-book><ion-item ng-if="jsonNeedBookList.length==0" ui-sref="tab.book_recommend">主人还没发布过求书,再去逛逛</ion-item></ion-list></ion-content></ion-view>'),o.put("temp/tool/userInfoTemplate.html",'<div class="item item-avatar" ng-if="jsonUserInfo"><img ng-src="{{User$.changeWechatAvatarSize(jsonUserInfo.avatarUrl,64)}}"><h2>{{jsonUserInfo.nickName}} <i class="icon ion-male" style="color: #5eb1ed" ng-if="jsonUserInfo.sex==1"></i> <i class="icon ion-female" style="color: #ff6d9e" ng-if="jsonUserInfo.sex==2"></i> <i>{{jsonUserInfo.startSchoolYear}}级</i></h2><p style="white-space: pre-wrap">{{jsonUserInfo.major}}/{{jsonUserInfo.school}}</p><button ng-if="User$.getCurrentAvosUser && jsonUserInfo.objectId!=User$.getCurrentAvosUser().id" class="button button-small button-clear button-balanced" style="float: right" ui-sref="tab.person_sendMsgToUser({receiverObjectId:jsonUserInfo.objectId,role:\'buy\',inboxType:\'private\',usedBookObjectId:usedBookObjectId})">发私信</button> <button ng-if="jsonUserInfo.location" class="button button-small button-clear button-balanced" style="float: right" ng-click="WeChatJS$.openMap(jsonUserInfo.location.latitude,jsonUserInfo.location.longitude)">地图</button> <button ng-if="User$.getCurrentAvosUser && jsonUserInfo.objectId!=User$.getCurrentAvosUser().id && !jsonUserInfo.isMyFollowee" class="button button-small button-clear button-balanced" style="float: right" ng-click="User$.followUser(jsonUserInfo.objectId)">关注Ta</button> <button ng-if="jsonUserInfo.isMyFollowee" class="button button-small button-clear button-energized" style="float: right" ng-click="User$.unfollowUser(jsonUserInfo.objectId)">取消关注</button></div><ion-item ng-if="!hideUsedBook" style="padding: 0;text-align: center"><a class="button button-small button-clear button-balanced" ui-sref="tab.userHome({ownerId:jsonUserInfo.objectId})">主人有{{jsonUserInfo.userUsedBookNumber}}本旧书要卖,发布了{{jsonUserInfo.userNeedBookNumber}}个求书</a></ion-item>'),o.put("temp/tool/userList.html",'<ion-view ng-controller="userList" view-title="{{title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content class="padding"><div class="button-bar"><a class="button button-small" ng-click="sortWay=\'userUsedBookNumber\'" ng-class="{\'button-balanced\':sortWay==\'userUsedBookNumber\'}">数量</a> <a class="button button-small" ng-click="sortWay=\'location\'" ng-class="{\'button-balanced\':sortWay==\'location\'}">距离</a> <a class="button button-small" ng-click="sortWay=\'isMyFollowee\'" ng-class="{\'button-balanced\':sortWay==\'isMyFollowee\'}">关注</a> <a class="button button-small" ng-click="chooseMajorModalView.show()">{{getMajorFilter() ? getMajorFilter() :\'专业\'}}</a></div><div class="card" ng-repeat="one in jsonUsers | orderBy:sortWay:true"><user-info json-user-info="one"></user-info></div><ion-infinite-scroll ng-if="hasMore()" on-infinite="loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-view>')}]),APP.controller("tabs",["$scope","Status$",function(o,e){o.Status$=e}]),APP.controller("userHome",["$scope","$stateParams","UsedBook$",function(o,e,t){o.UsedBook$=t;var n=e.ownerId,s=new AV.Query(AV.User);o.jsonUsedBookList=[],o.jsonNeedBookList=[],s.get(n).done(function(e){o.jsonOwnerInfo=avosUserToJson(e),t.loadUsedBookListForOwner(e).done(function(e){for(var n=0;n<e.length;n++)o.jsonUsedBookList.push(t.avosUsedBookToJson(e[n]));o.$apply()}),t.loadNeedBookListForOwner(e).done(function(e){for(var n=0;n<e.length;n++)o.jsonNeedBookList.push(t.avosUsedBookToJson(e[n]));o.$apply()})})}]),APP.controller("userList",["$scope","$stateParams","UsedBook$","BookRecommend$","User$","IonicModalView$",function(o,e,t,n,s,i){var a=e.cmd;o.sortWay="","near"==a?(o.title="你附近的同学",o.jsonUsers=n.NearUser.jsonUsers,o.loadMore=n.NearUser.loadMore,o.hasMore=n.NearUser.hasMore,o.setMajorFilter=n.NearUser.setMajorFilter,o.getMajorFilter=n.NearUser.getMajorFilter):"followee"==a?(o.title="我关注的同学",o.jsonUsers=s.Followee.jsonUserList,o.loadMore=s.Followee.loadMore,o.hasMore=s.Followee.hasMore,o.setMajorFilter=s.Followee.setMajorFilter,o.getMajorFilter=s.Followee.getMajorFilter):"follower"==a&&(o.title="我的粉丝",o.jsonUsers=s.Follower.jsonUserList,o.loadMore=s.Follower.loadMore,o.hasMore=s.Follower.hasMore,o.setMajorFilter=s.Follower.setMajorFilter,o.getMajorFilter=s.Follower.getMajorFilter),i.registerChooseMajorModalView(o,function(e){o.setMajorFilter(e)})}]),APP.directive("reviewStar",function(){function o(o,e){var t=o.numStars,n=o.score,s=o.numRaters,i='<i class="icon ion-ios-star energized"></i>',a='<i class="icon ion-ios-star-outline"></i>';e.append("<i>"+n+"分&nbsp</i>"),e.append("<i>"+s+"人参与&nbsp</i>");for(var r=1;5>=r;r++){var l;l=t>=r?angular.element(i).clone():angular.element(a).clone(),e.append(l)}}return{restrict:"E",scope:{numStars:"@",score:"@",numRaters:"@"},link:o}}).directive("userInfo",["WeChatJS$","User$",function(o,e){function t(t){function n(){if(t.jsonUserInfo){t.jsonUserInfo.userUsedBookNumber=0;var o=AV.Object.createWithoutData("_User",t.jsonUserInfo.objectId),e=o.relation("usedBooks").query();e.equalTo("role","sell"),e.count().done(function(o){t.jsonUserInfo.userUsedBookNumber=o,t.$apply()})}}function s(){if(t.jsonUserInfo){t.jsonUserInfo.userNeedBookNumber=0;var o=AV.Object.createWithoutData("_User",t.jsonUserInfo.objectId),e=o.relation("usedBooks").query();e.equalTo("role","need"),e.count().done(function(o){t.jsonUserInfo.userNeedBookNumber=o,t.$apply()})}}function i(){if(t.jsonUserInfo&&AV.User.current()){var o=AV.User.current().followeeQuery();o.equalTo("followee",AV.Object.createWithoutData("_User",t.jsonUserInfo.objectId)),o.count().done(function(o){t.jsonUserInfo.isMyFollowee=1==o,t.$apply()})}}t.WeChatJS$=o,t.User$=e,t.isMyFollowee=!1,t.$watch(function(){return t.jsonUserInfo},function(){i(),(null==t.hideUsedBook||0==t.hideUsedBook)&&(n(),s())}),t.$on("FollowSomeone",function(){i()}),t.$on("UnfollowSomeone",function(){i()})}return{restrict:"E",scope:{jsonUserInfo:"=",hideUsedBook:"=?",usedBookObjectId:"=?"},templateUrl:"temp/tool/userInfoTemplate.html",link:t}}]).directive("doubanBookOneLine",function(){return{restrict:"E",scope:{jsonBooksInfo:"="},templateUrl:"temp/tool/doubanBookOneLineTemplate.html",link:function(o){o.showNumber=Math.floor(document.body.clientWidth/80)}}}).directive("usedBookOneLine",function(){return{restrict:"E",scope:{jsonBooksInfo:"="},templateUrl:"temp/tool/usedBookOneLineTemplate.html",link:function(o){o.showNumber=Math.floor(document.body.clientWidth/80)}}}).directive("oneUsedBook",function(){return{restrict:"E",scope:{jsonUsedBook:"="},templateUrl:"temp/tool/oneUsedBookTemplate.html"}}).directive("oneNeedBook",function(){return{restrict:"E",scope:{jsonNeedBook:"="},templateUrl:"temp/tool/oneNeedBookTemplate.html"}});