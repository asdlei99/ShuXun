"use strict";function jsonp(o,e){var n=document.createElement("script");n.type="text/javascript";var t=Date.now();n.src=o+(o.indexOf("?")>0?"&":"?")+"callback=CB"+t,n.onload=function(){n.parentNode.removeChild(n)},window["CB"+t]=function(o){e(o)},document.head.appendChild(n)}function createCookie(o,e,n){var t="";if(n){var i=new Date;i.setTime(i.getTime()+24*n*60*60*1e3),t="; expires="+i.toGMTString()}document.cookie=o+"="+e+t+"; path=/"}function readCookie(o){for(var e=o+"=",n=document.cookie.split(";"),t=0;t<n.length;t++){for(var i=n[t];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(e))return i.substring(e.length,i.length)}return null}function eraseCookie(o){createCookie(o,"",-1)}function loginWithUnionId(o){return o?AV.User.logIn(o,o):AV.Promise.error("unionId错误")}AV.initialize("kusn9e3cp5znt5lic9fufqfmsvsibsoaejpah089x6v2n7e0","nt5l8v4n4m08zxttpt7upqxwgt6oy47lzb3f8c4juf34otfm");var WECHAT={AppID:"wx2940a8d3ddcad5e9"};loginWithUnionId(readCookie("unionId"));var APP=angular.module("APP",["ionic"],null).config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider",function(o,e,n){n.tabs.style("standard"),n.tabs.position("bottom"),o.state("tab",{url:"/tab","abstract":!0,templateUrl:"temp/tabs.html"}).state("tab.book_recommend",{url:"/book/recommend",views:{"tab-book":{templateUrl:"temp/book/recommend.html"}}}).state("tab.book_searchList",{url:"/book/searchList",views:{"tab-book":{templateUrl:"temp/book/searchList.html"}}}).state("tab.book_bookList",{url:"/book/bookList?cmd&title&tag",views:{"tab-book":{templateUrl:"temp/book/bookList.html"}}}).state("tab.book_usedBookList",{url:"/book/usedBookList?cmd&isbn13",views:{"tab-book":{templateUrl:"temp/book/usedBookList.html"}}}).state("tab.book_userList",{url:"/book/userList?cmd&title",views:{"tab-book":{templateUrl:"temp/book/userList.html"}}}).state("tab.book_oneBook",{url:"/book/oneBook/{isbn13}",views:{"tab-book":{templateUrl:"temp/book/oneBook.html"}}}).state("tab.book_usedBookListByOwner",{url:"/book/usedBookListByOwner/{ownerId}",views:{"tab-book":{templateUrl:"temp/book/usedBookListByOwner.html"}}}).state("tab.book_oneUsedBook",{url:"/book/oneUsedBook/{usedBookAvosObjectId}",views:{"tab-book":{templateUrl:"temp/book/oneUsedBook.html"}}}).state("tab.person_editOneUsedBook",{url:"/person/editOneUsedBook/{indexInMyAvosUsedBook_notSell}",views:{"tab-person":{templateUrl:"temp/person/editOneUsedBook.html"}}}).state("tab.person_uploadOneUsedBook",{url:"/person/uploadOneUsedBook/{isbn13}",views:{"tab-person":{templateUrl:"temp/person/uploadOneUsedBook.html"}}}).state("tab.person_usedBooksList",{url:"/person/usedBookList",views:{"tab-person":{templateUrl:"temp/person/usedBookList.html"}}}).state("tab.person_editPersonInfo",{url:"/person/editPersonInfo",views:{"tab-person":{templateUrl:"temp/person/editPersonInfo.html"}}}).state("tab.person_my",{url:"/person/my",views:{"tab-person":{templateUrl:"temp/person/my.html"}}}).state("tab.person_sendMsgToUser",{url:"/person/sendMsgToUser?openId&msg&usedBookAvosObjectId&role",views:{"tab-person":{templateUrl:"temp/person/sendMsgToUser.html"}}}).state("tab.hello",{url:"/hello?state",views:{"tab-person":{templateUrl:"temp/tool/hello.html"}}}).state("tab.signUp",{url:"/signUp?code&state",views:{"tab-person":{templateUrl:"temp/tool/signUp.html"}}}),e.otherwise("/tab/book/recommend")}]);APP.run(["$rootScope","$state","User$",function(o,e,n){o.$on("$stateChangeStart",function(o,t){var i=t.name;i.indexOf("tab.person_")>=0&&(n.getCurrentAvosUser()||(o.preventDefault(),e.go("tab.hello",{state:i})))})}]),APP.service("DoubanBook$",function(){var o=this,e="http://api.douban.com/v2/book";this.getBookByISBD=function(o,n,t){var i=e+"/isbn/"+o;null==t&&(t="id,rating,author,pubdate,image,binding,translator,catalog,pages,publisher,isbn13,title,author_intro,summary,price"),i+="?fields="+t,jsonp(i,function(o){n(o.code?null:o)})},this.getBookByISBD_simple=function(e,n){o.getBookByISBD(e,n,"author,pubdate,image,publisher,title,price,isbn13")},this.searchBooks=function(o,n,t,i){var s=e+"/search";return o&&o.length<1?[]:(s+="?q="+o,n&&(s+="&start="+n),t&&(s+="&count="+t),s+="&fields=isbn13,title,image,author,publisher,pubdate,price",void jsonp(s,function(o){i(o)}))},this.getBooksByTag=function(o,n,t,i){var s=e+"/search";return!o||o.length<1?[]:(s+="?tag="+o,n&&(s+="&start="+n),t&&(s+="&count="+t),s+="&fields=isbn13,title,image,author,publisher,pubdate,price",void jsonp(s,function(o){i(o)}))}}).service("SearchBook$",["$rootScope","DoubanBook$","$timeout",function(o,e,n){var t=this;this.keyword="",this.books=[],this.hasMore=function(){return t.books.length<t.totalNum},this.totalNum=0,this.loadMore=function(){t.keyword.length>0&&e.searchBooks(t.keyword,t.books.length,10,function(e){t.totalNum=e.total;for(var n=e.books,i=0;i<n.length;i++)t.books.push(n[i]);o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})};var i=null;this.searchBtnOnClick=function(){t.loadMore(),n.cancel(i)},this.searchInputOnChange=function(){t.books=[],t.totalNum=0,n.cancel(i),i=n(function(){t.searchBtnOnClick()},1e3)}}]).service("BookRecommend$",["$rootScope","DoubanBook$","User$","UsedBook$",function(o,e,n,t){var i=this;this.BookTag={tag:null,load:function(){jsonp("/info/getAllBookTags",function(e){i.BookTag.tag=e,o.$apply()})},getTagAttrNames:function(){return i.BookTag.tag?Object.keys(i.BookTag.tag):[]}},this.BookTag.load(),this.TagBook={nowTag:"",totalNum:0,setTag:function(o){o!=i.TagBook.nowTag&&(i.TagBook.books=[],i.TagBook.nowTag=o)},books:[],loadMore:function(){e.getBooksByTag(i.TagBook.nowTag,i.TagBook.books.length,5,function(e){i.TagBook.totalNum=e.total;for(var n=e.books,t=0;t<n.length;t++)i.TagBook.books.push(n[t]);o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return i.TagBook.books.length<i.TagBook.totalNum}},this.MajorBook={major:n.getCurrentJsonUser()?n.getCurrentJsonUser().major:"",books:[],loadMore:function(){e.getBooksByTag(i.MajorBook.major,i.MajorBook.books.length,5,function(e){i.MajorBook.totalNum=e.total;for(var n=e.books,t=0;t<n.length;t++)i.MajorBook.books.push(n[t]);o.$apply(),o.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return i.MajorBook.books.length<i.MajorBook.totalNum}},this.NeedBook={books:[],loadMore:function(){}},this.NearBook={jsonBooks:[],loadMore:function(){var e=n.getCurrentUserLocation(),s=new AV.Query("UsedBook");e&&s.near("location",e),s.skip(i.NearBook.jsonBooks.length),s.limit(5),s.find().done(function(e){if(e.length>0)for(var n=0;n<e.length;n++)i.NearBook.jsonBooks.push(t.avosUsedBookToJson(e[n]));o.$apply()})}},this.NearUser={jsonUsers:[],loadMore:function(){var e=n.getCurrentUserLocation(),t=new AV.Query(AV.User);e&&t.near("location",e),t.skip(i.NearUser.jsonUsers.length),t.limit(5),t.find().done(function(e){if(e.length>0)for(var t=0;t<e.length;t++)i.NearUser.jsonUsers.push(n.avosUserToJson(e[t]));o.$apply()})}},this.NearUser.loadMore()}]).service("BusinessSite$",["$http",function(o){this.getBusinessInfoByISBN=function(e,n){o.jsonp("/business/"+e+"?callback=JSON_CALLBACK").success(function(o){n(o)})}}]).service("WeChatJS$",["$rootScope",function(o){function e(o){var e={title:"书循",desc:"让你的课本重复利用",link:window.location.href,imgUrl:"http://"+window.location.host+"/wechat/img/logo-R.png"};return e=angular.extend(e,o)}jsonp("/wechat/getJsConfig",function(o){wx.config(o)}),wx.ready(function(){wx.onMenuShareTimeline(e()),wx.onMenuShareAppMessage(e()),wx.onMenuShareQQ(e()),wx.onMenuShareWeibo(e()),wx.getLocation({success:function(o){AV.Cloud.run("updateMyLocation",{latitude:o.latitude,longitude:o.longitude})},fail:function(){AV.Cloud.run("updateMyLocation")},cancel:function(){AV.Cloud.run("updateMyLocation")}})}),this.scanQRCode=function(e){wx.scanQRCode({needResult:1,success:function(n){e(n.resultStr.split(",")[1]),o.$apply()}})},this.previewOneImage=function(o){wx.previewImage({current:o,urls:[o]})},this.getOAuthURL=function(o){var e=location.href.split("#")[0]+"#tab/signUp";return"https://open.weixin.qq.com/connect/oauth2/authorize?appid="+WECHAT.AppID+"&redirect_uri="+encodeURIComponent(e)+"&response_type=code&scope=snsapi_userinfo&state="+o+"#wechat_redirect"},this.getOAuthUserInfo=function(o,e){jsonp("/wechat/getOAuthUserInfo/"+o,function(o){var n={openId:o.openid,unionId:o.unionid,nickName:o.nickname,sex:o.sex,avatarUrl:o.headimgurl};createCookie("unionId",n.unionId,365),e(n)})},this.openMap=function(o,e){jsonp("http://apis.map.qq.com/ws/coord/v1/translate?type=1&key=R3DBZ-HEYRF-ZSZJ3-JAJJN-2ZWFF-SLBJV&output=jsonp&locations="+o+","+e,function(o){if(0==o.status){var e=o.locations[0];wx.openLocation({latitude:e.lat,longitude:e.lng,name:"该同学位置"})}})}}]).service("InfoService$",["$rootScope","$http","User$",function(o,e,n){var t=this;this.majors=[],e.jsonp("/info/getAllMajor?callback=JSON_CALLBACK").success(function(o){t.majors=o}),this.searchMajorKeyword="",this.filter_majorByKeyword=function(o){return o.name.indexOf(t.searchMajorKeyword)>-1},this.School={schools:[],loadMore:function(){var e=n.getCurrentUserLocation(),i=new AV.Query("School");e&&i.near("location",e),t.School.searchSchoolKeyword.length>0?i.startsWith("name",t.School.searchSchoolKeyword):(i.skip(t.School.schools.length),i.limit(10)),i.find().done(function(e){if(e.length>0)for(var n=0;n<e.length;n++)t.School.schools.push(e[n].get("name"));o.$apply()})},searchSchoolKeyword:"",filter_schoolByKeyword:function(o){return o.indexOf(t.School.searchSchoolKeyword)>=0}},this.startSchoolYearOptions=[];for(var i=(new Date).getFullYear(),s=i-6;i>=s;s++)t.startSchoolYearOptions.push(s.toString())}]).service("IonicModalView$",["$rootScope","$ionicModal","$ionicHistory","InfoService$",function(o,e,n,t){this.registerChooseSchoolModalView=function(o,n){o.InfoService$=t,e.fromTemplateUrl("temp/tool/chooseSchoolModalView.html",{scope:o}).then(function(e){o.chooseSchoolModalView=e}),o.schoolOnChoose=function(e){n(e),o.chooseSchoolModalView.hide()}},this.registerChooseMajorModalView=function(o,n){o.InfoService$=t,e.fromTemplateUrl("temp/tool/chooseMajorModalView.html",{scope:o}).then(function(e){o.chooseMajorModalView=e}),o.majorOnChoose=function(e){n(e),o.chooseMajorModalView.hide()}},this.alertTitleAndPreModalView=function(n,t){var i=o.$new(!0);i.titleAndPreModalViewData={title:n,pre:t},e.fromTemplateUrl("temp/tool/titleAndPreModalView.html",{scope:i}).then(function(o){i.titleAndPreModalView=o,o.show()})}}]).service("User$",function(){var o=this,e=["openId","nickName","avatarUrl","sex","school","major","startSchoolYear"];this.signUpWithJSONUser=function(e){var n=o.jsonToAvosUser(e);return n.set("username",e.unionId),n.set("password",e.unionId),n.signUp(null)},this.getCurrentUserLocation=function(){var e=o.getCurrentAvosUser();return e?e.get("location"):null},this.getCurrentAvosUser=function(){return AV.User.current()},this.getCurrentJsonUser=function(){var e=o.getCurrentAvosUser();return e?o.avosUserToJson(e):null},this.avosUserToJson=function(o){for(var n={},t=0;t<e.length;t++){var i=e[t];n[i]=o.get(i)}return n.objectId=o.id,n.location=o.get("location"),n},this.jsonToAvosUser=function(o){for(var n=new AV.User,t=0;t<e.length;t++){var i=e[t];n.set(i,o[i])}return n},this.getAvosUserByOpenId=function(o){var e=new AV.Query(AV.User);return e.equalTo("openId",o),e.first()},this.getAvosUserByUnionId=function(o){var e=new AV.Query(AV.User);return e.equalTo("username",o),e.first()},this.sendMsgToUser=function(e,n,t,i){var s=o.getCurrentJsonUser(),a=s.nickName,r=s.openId;return AV.Cloud.run("sendTemplateMsgToUser",{sendName:a,senderId:r,receiverId:e,msg:n,usedBookAvosObjectId:t,role:i})}}).service("UsedBook$",["$rootScope","HasSellUsedBook$",function(o,e){var n=this,t=["owner","isbn13","price","des","image","title"];this.isLoading=!1,this.getUsedBookNumberForOwner=function(o){var e=new AV.Query("UsedBook"),n=new AV.User;return n.id=o,e.equalTo("owner",n),e.descending("updatedAt"),e.count()},this.loadUsedBookListForOwner=function(o){var e=new AV.Query("UsedBook");return e.equalTo("owner",o),e.descending("updatedAt"),e.find()},this.myAvosUsedBookList=[],this.loadMyAvosUsedBookList=function(){n.isLoading=!0;var e=new AV.Query("UsedBook");e.equalTo("owner",AV.User.current()),e.descending("updatedAt"),e.find().done(function(o){n.myAvosUsedBookList=o}).always(function(){n.isLoading=!1,o.$apply()})},this.removeUsedBook=function(o){window.confirm("你确定要删除它吗?")&&o.destroy().done(function(){n.loadMyAvosUsedBookList()}).fail(function(o){alert(o.message)})},this.usedBookHasSell=function(o){window.confirm("你确定它已经卖出了吗?")&&AV.Cloud.run("usedBookHasSell",{id:o.id},null).done(function(){n.loadMyAvosUsedBookList(),e.loadMyAvosUsedBookList()}).fail(function(o){alert(o.message)})},this.avosUsedBookToJson=function(o){for(var e={},n=0;n<t.length;n++){var i=t[n];e[i]=o.get(i)}return e.objectId=o.id,e.updatedAt=o.updatedAt,e},this.jsonUsedBookToAvos=function(o){for(var e=new AV.Object.extend("UsedBook"),n=new e,i=0;i<t.length;i++){var s=t[i];n.set(s,o[s])}return n},this.getJsonUsedBookByAvosObjectId=function(o,e){var t=new AV.Query("UsedBook");t.get(o).done(function(o){e(n.avosUsedBookToJson(o))})},this.getUsedBookNumberEqualISBN=function(o){var e=new AV.Query("UsedBook");return e.equalTo("isbn13",o),e.count()},this.ISBN={nowISBN13:"",nowEqualISBNJsonUsedBookList:[],loadMoreUsedBookEqualISBN:function(e){n.isLoading=!0,e!=n.ISBN.nowISBN13&&(n.ISBN.nowISBN13=e,n.ISBN.nowEqualISBNJsonUsedBookList=[]);var t=new AV.Query("UsedBook");t.equalTo("isbn13",n.ISBN.nowISBN13),t.descending("updatedAt"),t.skip(n.ISBN.nowEqualISBNJsonUsedBookList.length),t.limit(5),t.find().done(function(o){if(o.length>0)for(var e=0;e<o.length;e++)n.ISBN.nowEqualISBNJsonUsedBookList.push(n.avosUsedBookToJson(o[e]))}).always(function(){n.isLoading=!1,o.$apply()})}}}]).service("HasSellUsedBook$",["$rootScope",function(o){var e=this;this.myAvosUsedBookList=[],this.loadMyAvosUsedBookList=function(){var n=new AV.Query("HasSellUsedBook");n.equalTo("owner",AV.User.current()),n.find().done(function(o){e.myAvosUsedBookList=o}).always(function(){o.$apply()})},this.removeUsedBook=function(o){window.confirm("你确定要删除它吗?")&&o.destroy().done(function(){e.loadMyAvosUsedBookList()}).fail(function(o){alert(o.message)})}}]),APP.controller("book_recommend",["$scope","$ionicModal","BookRecommend$",function(o,e,n){o.BookRecommend$=n,n.MajorBook.loadMore(),n.NeedBook.loadMore(),n.NearBook.loadMore(),e.fromTemplateUrl("template/bookTags.html",{scope:o}).then(function(e){o.bookTagsModalView=e})}]).controller("book_searchList",["$scope","$timeout","$state","SearchBook$","WeChatJS$",function(o,e,n,t,i){o.SearchBook$=t,o.scanQRBtnOnClick=function(){i.scanQRCode(function(o){o&&o.length>=10&&o.length<=13?n.go("tab.book_oneBook",{isbn13:o}):alert("不合法的ISBN号")})}}]).controller("book_bookList",["$scope","$stateParams","BookRecommend$",function(o,e,n){o.title=e.title;var t=e.cmd;if("tag"==t){var i=e.tag;n.TagBook.setTag(i),n.TagBook.loadMore(),o.title=i,o.books=n.TagBook.books,o.loadMore=n.TagBook.loadMore,o.hasMore=n.TagBook.hasMore}else"need"==t?(o.books=n.NeedBook.books,o.loadMore=n.NeedBook.loadMore):"major"==t&&(o.books=n.MajorBook.books,o.loadMore=n.MajorBook.loadMore,o.title=n.MajorBook.major)}]).controller("book_usedBookList",["$scope","$stateParams","UsedBook$","BookRecommend$",function(o,e,n,t){var i=e.cmd;if(o.sortWay="","near"==i)o.title="你附近的二手书",o.jsonUsedBooks=t.NearBook.jsonBooks,o.loadMore=t.NearBook.loadMore;else if("isbn"==i){o.title="对应的二手书";var s=e.isbn13;n.ISBN.loadMoreUsedBookEqualISBN(s),o.jsonUsedBooks=n.ISBN.nowEqualISBNJsonUsedBookList,o.loadMore=n.ISBN.loadMoreUsedBookEqualISBN(s)}}]).controller("book_userList",["$scope","$stateParams","UsedBook$","BookRecommend$",function(o,e,n,t){function i(e){n.getUsedBookNumberForOwner(e.objectId).done(function(n){e.usedBookNumber=n,o.$apply()})}var s=e.cmd;if(o.sortWay="","near"==s){o.title="你附近的同学",o.jsonUsers=t.NearUser.jsonUsers;for(var a=0;a<o.jsonUsers.length;a++)i(o.jsonUsers[a]);o.loadMore=t.NearUser.loadMore}}]).controller("book_oneBook",["$scope","$state","$stateParams","$ionicModal","DoubanBook$","WeChatJS$","InfoService$","UsedBook$","IonicModalView$","BusinessSite$",function(o,e,n,t,i,s,a,r,l,c){o.isbn13=n.isbn13,o.book=null,o.isLoading=!0,i.getBookByISBD(o.isbn13,function(n){n?(n.image=n.image.replace("mpic","lpic"),o.book=n,o.isLoading=!1,o.$apply(),c.getBusinessInfoByISBN(n.id,function(e){o.businessInfos=e})):(alert("没有找到图书信息,再去搜搜看~"),e.go("tab.book_searchList"))}),o.showAuthorIntro=function(){var e=o.book.author.toString(),n=o.book.author_intro;l.alertTitleAndPreModalView(e,n)},o.showPubInfo=function(){var e="出版信息",n=o.book,t="作者:"+n.author.toString()+"\n出版社:"+n.publisher+"\n出版年:"+n.pubdate+"\n页数:"+n.pages+"\n定价:"+n.price+"\n装帧:"+n.binding+"\nISBN:"+n.isbn13+"\n目录:\n"+n.catalog;l.alertTitleAndPreModalView(e,t)},o.showSummary=function(){var e="图书简介",n=o.book.summary;l.alertTitleAndPreModalView(e,n)},o.UsedBook$=r,r.getUsedBookNumberEqualISBN(o.isbn13).done(function(e){o.usedBookNumber=e}),r.ISBN.loadMoreUsedBookEqualISBN(o.isbn13),o.WeChatJS$=s}]).controller("book_usedBookListByOwner",["$scope","$stateParams","UsedBook$","User$",function(o,e,n,t){o.UsedBook$=n;var i=e.ownerId,s=new AV.Query(AV.User);o.jsonUsedBookList=[],s.get(i).done(function(e){o.jsonOwnerInfo=t.avosUserToJson(e),n.loadUsedBookListForOwner(e).done(function(e){for(var t=0;t<e.length;t++)o.jsonUsedBookList.push(n.avosUsedBookToJson(e[t]));o.$apply()})})}]).controller("book_oneUsedBook",["$scope","$stateParams","UsedBook$","User$","WeChatJS$",function(o,e,n,t,i){o.WeChatJS$=i,o.usedBookAvosObjectId=e.usedBookAvosObjectId,n.getJsonUsedBookByAvosObjectId(o.usedBookAvosObjectId,function(e){e.image=e.image?e.image.replace("mpic","lpic"):"",o.jsonUsedBook=e,o.$apply();var i=o.jsonUsedBook.owner;i.fetch().done(function(e){o.ownerInfo=t.avosUserToJson(e),o.$apply()}),n.getUsedBookNumberForOwner(i.id).done(function(e){o.ownerUsedBookNumber=e,o.$apply()})})}]).controller("person_uploadOneUsedBook",["$scope","$state","$stateParams","$ionicHistory","$ionicModal","DoubanBook$","WeChatJS$","UsedBook$","User$",function(o,e,n,t,i,s,a,r,l){function c(){o.isLoading=!0,s.getBookByISBD_simple(o.usedBookInfo.isbn13,function(n){n?(o.doubanBookInfo=n,o.isLoading=!1,o.usedBookInfo.image=n.image.replace("mpic","lpic"),o.usedBookInfo.title=n.title,o.$apply()):(alert("没有找到图书信息,再去搜搜看~"),e.go("tab.book_searchList"))})}o.isLoading=!1,o.WeChatJS$=a,o.$on("$ionicView.afterEnter",function(){o.usedBookInfo={isbn13:n.isbn13,price:null,des:null,image:"",title:""},o.usedBookInfo.isbn13&&c(),o.usedBookInfo.owner=l.getCurrentAvosUser()}),i.fromTemplateUrl("template/noBarCodeModalView.html",{scope:o}).then(function(e){o.noBarCodeModalView=e}),o.scanQRBtnOnClick=function(){a.scanQRCode(function(e){o.usedBookInfo.isbn13=e,c()})},o.submitOnClick=function(){o.isLoading=!0;var n=r.jsonUsedBookToAvos(o.usedBookInfo);n.save(null).done(function(){e.go("tab.person_usedBooksList"),t.clearHistory()}).fail(function(o){alert(o.message)}).always(function(){o.isLoading=!1})}}]).controller("person_editPersonInfo",["$scope","$state","$ionicHistory","InfoService$","User$","IonicModalView$",function(o,e,n,t,i,s){o.attrHasChange=!1,o.userInfo=i.getCurrentJsonUser(),s.registerChooseSchoolModalView(o,function(e){o.attrHasChange=!0,o.userInfo.school=e}),s.registerChooseMajorModalView(o,function(e){o.attrHasChange=!0,o.userInfo.major=e}),o.startSchoolYearOptions=t.startSchoolYearOptions,o.submitOnClick=function(){var t=readCookie("unionId");loginWithUnionId(t).done(function(t){t.fetchWhenSave(!0),t.save({school:o.userInfo.school,major:o.userInfo.major,startSchoolYear:o.userInfo.startSchoolYear}).done(function(){alert("修改成功")}).fail(function(o){alert("修改失败:"+o.message)}).always(function(){e.go("tab.person_my"),n.clearHistory()})})}}]).controller("person_my",["$scope","$state","$stateParams","User$","UsedBook$",function(o,e,n,t,i){function s(){o.userInfo=t.getCurrentJsonUser(),i.getUsedBookNumberForOwner(t.getCurrentAvosUser().id).done(function(e){o.myUsedBookNumber=e,o.$apply()})}o.$on("$ionicView.afterEnter",s),o.logOut=function(){AV.User.logOut(),eraseCookie("unionId"),wx.closeWindow()}}]).controller("person_usedBookList",["$scope","UsedBook$","HasSellUsedBook$",function(o,e,n){o.UsedBook$=e,e.loadMyAvosUsedBookList(),o.HasSellUsedBook$=n,n.loadMyAvosUsedBookList()}]).controller("person_editOneUsedBook",["$scope","$state","$ionicHistory","$stateParams","UsedBook$",function(o,e,n,t,i){var s=t.indexInMyAvosUsedBook_notSell;o.avosUsedBook=i.myAvosUsedBookList[s],o.valueHasChange=!1,o.jsonUsedBookChangeInfo=i.avosUsedBookToJson(o.avosUsedBook),o.submitOnClick=function(){o.avosUsedBook.set("des",o.jsonUsedBookChangeInfo.des),o.avosUsedBook.set("price",o.jsonUsedBookChangeInfo.price),o.avosUsedBook.save(null).done(function(){e.go("tab.person_usedBooksList"),n.clearHistory()}).fail(function(o){alert(o.message)})}}]).controller("person_sendMsgToUser",["$scope","$state","$stateParams","$ionicHistory","User$","UsedBook$",function(o,e,n,t,i,s){var a=n.openId;o.isLoading=!1,o.msg={receiveMsg:n.msg,sendMsg:"",usedBookAvosObjectId:n.usedBookAvosObjectId,role:n.role},i.getAvosUserByOpenId(a).done(function(e){o.jsonUser=i.avosUserToJson(e),o.$apply()}),o.commonReplayWords=[],o.commonReplayWords="sell"==o.msg.role?["成交","不能再便宜了","这本书已经卖出去了"]:["成交","可以再便宜点吗?","你在什么地方?","书有破损吗?"],o.msg.usedBookAvosObjectId&&s.getJsonUsedBookByAvosObjectId(o.msg.usedBookAvosObjectId,function(e){o.jsonUsedBook=e,o.$apply()}),o.sendOnClick=function(){o.isLoading=!0,i.sendMsgToUser(a,o.msg.sendMsg,o.msg.usedBookAvosObjectId,o.msg.role).done(function(){alert("回复成功"),e.go("tab.person_my"),t.clearHistory()}).fail(function(o){alert("发送失败:"+JSON.stringify(o))}).always(function(){o.isLoading=!1,o.$apply()})}}]).controller("signUp",["$scope","$timeout","$state","$stateParams","$ionicHistory","$ionicModal","WeChatJS$","InfoService$","User$","IonicModalView$",function(o,e,n,t,i,s,a,r,l,c){o.isLoading=!0;var u=t.code,d=t.state;a.getOAuthUserInfo(u,function(e){o.isLoading=!1,o.userInfo=e,l.getAvosUserByUnionId(e.unionId).done(function(o){o&&loginWithUnionId(e.unionId).done(function(){n.go(d),i.clearHistory()})}),o.$apply()}),c.registerChooseSchoolModalView(o,function(e){o.userInfo.school=e}),c.registerChooseMajorModalView(o,function(e){o.userInfo.major=e}),o.startSchoolYearOptions=r.startSchoolYearOptions,o.submitOnClick=function(){o.isLoading=!0,l.signUpWithJSONUser(o.userInfo).done(function(){n.go(d),i.clearHistory()}).fail(function(o){alert(o.message)}).always(function(){o.isLoading=!1,o.$apply()})}}]).controller("hello",["$scope","$stateParams","WeChatJS$",function(o,e,n){var t=e.state;o.OAuthURL=n.getOAuthURL(t)}]),APP.directive("reviewStar",function(){function o(o,e){var n=o.numStars,t=o.score,i=o.numRaters,s='<i class="icon ion-ios-star energized"></i>',a='<i class="icon ion-ios-star-outline"></i>';e.append("<i>"+t+"分&nbsp</i>"),e.append("<i>"+i+"人参与&nbsp</i>");for(var r=1;5>=r;r++){var l;l=n>=r?angular.element(s).clone():angular.element(a).clone(),e.append(l)}}return{restrict:"E",scope:{numStars:"@",score:"@",numRaters:"@"},link:o}}).directive("userInfo",["WeChatJS$",function(o){function e(e){e.WeChatJS$=o}return{restrict:"E",scope:{jsonUserInfo:"=",userUsedBookNumber:"="},templateUrl:"temp/tool/userInfoTemplate.html",link:e}}]).directive("doubanBookOneLine",function(){return{restrict:"E",scope:{jsonBooksInfo:"="},templateUrl:"temp/tool/doubanBookOneLineTemplate.html",link:function(o){o.showNumber=Math.floor(document.body.clientWidth/80)}}}).directive("usedBookOneLine",function(){return{restrict:"E",scope:{jsonBooksInfo:"="},templateUrl:"temp/tool/usedBookOneLineTemplate.html",link:function(o){o.showNumber=Math.floor(document.body.clientWidth/80)}}}).directive("oneUsedBook",function(){return{restrict:"E",scope:{jsonUsedBook:"="},templateUrl:"temp/tool/oneUsedBookTemplate.html"}}),angular.module("APP").run(["$templateCache",function(o){o.put("temp/tabs.html",'<!--tabs父视图--><ion-tabs class="tabs-icon-top"><ion-tab title="图书" icon-on="ion-ios-book balanced" icon-off="ion-ios-book-outline" ui-sref="tab.book_recommend"><ion-nav-view name="tab-book"></ion-nav-view></ion-tab><ion-tab title="个人" icon-on="ion-ios-person balanced" icon-off="ion-ios-person-outline" ui-sref="tab.person_my"><ion-nav-view name="tab-person"></ion-nav-view></ion-tab></ion-tabs>'),o.put("temp/book/bookList.html",'<!--图书列表--><ion-view ng-controller="book_bookList" view-title="{{title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><ion-list><!-- 搜索结果列表--><ion-item class="item-thumbnail-left" collection-repeat="book in books" ui-sref="tab.book_oneBook({isbn13:book.isbn13})"><img ng-src="{{book.image}}"><h2>{{book.title}}</h2><p ng-if="book[\'publisher\']">{{book[\'publisher\']}}/{{book[\'pubdate\']}}</p><p ng-if="book.author">{{book.author.toString()}}</p><p ng-if="book.price">{{book.price}}</p></ion-item></ion-list><ion-infinite-scroll ng-if="hasMore()" on-infinite="loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-view>'),o.put("temp/book/oneBook.html",'<ion-view ng-controller="book_oneBook" view-title="{{book.title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><!-- 正在加载--><div style="text-align: center;padding-top: 10px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><!-- 图书基本信息--><div class="list card"><!-- 封面--><ion-item style="text-align: center"><img ng-src="{{book.image}}" style="height: 180px" ng-click="WeChatJS$.previewOneImage(book.image)"></ion-item><!-- 简介--><ion-item ng-if="book.summary" class="item-button-right"><h3>简介</h3><p style="white-space: pre-wrap">{{book.summary.substr(0,30)}}...</p><button class="button button-clear button-balanced" ng-click="showSummary()">详情</button></ion-item><!-- 作者--><ion-item ng-if="book.author.length>0" class="item-button-right">{{book.author.toString()}} 著 <button class="button button-small button-clear button-balanced" ng-if="book.author_intro" ng-click="showAuthorIntro()">作者简介</button></ion-item><!-- 出版信息--><ion-item class="item-button-right"><i ng-if="book.price">定价:{{book.price}}</i> <i>&nbsp;</i> <i ng-if="book[\'publisher\']">{{book[\'publisher\']}}/{{book[\'pubdate\']}}</i> <button class="button button-small button-clear button-balanced" ng-click="showPubInfo()">出版信息</button></ion-item><!-- 豆瓣书评--><ion-item ng-if="book[\'rating\']"><review-star num-stars="{{book[\'rating\'][\'average\']/2}}" score="{{book[\'rating\'][\'average\']}}" num-raters="{{book[\'rating\'][\'numRaters\']}}"></review-star></ion-item></div><!-- 电商购买新书--><div class="list card" ng-if="businessInfos.length>0"><ion-item class="item-divider">购买新书</ion-item><ion-item style="white-space:normal"><a class="button button-small button-outline button-balanced" style="margin: 5px" ng-repeat="info in businessInfos | orderBy:\'price\'" ng-href="{{info.url}}">{{info.name}}/{{info.price}}</a></ion-item></div><!-- 二手书--><div class="list card"><ion-item class="item-divider item-button-right">二手书 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneUsedBook({isbn13:book.isbn13})">上传旧书</button></ion-item><ion-item ng-if="usedBookNumber==0" style="text-align: center">还没有对应的二手书</ion-item><ion-item ng-if="UsedBook$.ISBN.nowEqualISBNJsonUsedBookList.length>0" ng-repeat="oneJsonUsedBook in UsedBook$.ISBN.nowEqualISBNJsonUsedBookList" ui-sref="tab.book_oneUsedBook({usedBookAvosObjectId:oneJsonUsedBook.objectId})"><h3>要价:{{oneJsonUsedBook.price}} 上传于:{{oneJsonUsedBook.updatedAt | date:\'mediumDate\' }}</h3><p ng-if="oneJsonUsedBook.des">{{oneJsonUsedBook.des}}</p></ion-item><ion-item ng-if="UsedBook$.ISBN.nowEqualISBNJsonUsedBookList.length>0" style="padding: 0;text-align: center"><a class="button button-small button-clear button-balanced" ui-sref="tab.book_usedBookList({cmd:\'isbn\',isbn13:isbn13})">共{{usedBookNumber}}本旧书,查看全部</a></ion-item></div></ion-content></ion-view>'),o.put("temp/book/oneUsedBook.html",'<!--一本二手书信息--><ion-view ng-controller="book_oneUsedBook" view-title="二手 {{jsonUsedBook.title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><!-- 图书基本信息--><div class="list card"><ion-item ng-if="jsonUsedBook.image" style="text-align: center"><img ng-src="{{jsonUsedBook.image}}" style="height: 180px" ng-click="WeChatJS$.previewOneImage(jsonUsedBook.image)"></ion-item><ion-item><h3>要价:{{jsonUsedBook.price}}</h3><p>时间:{{jsonUsedBook.updatedAt | date:\'mediumDate\' }}</p><p>书名:{{jsonUsedBook.title}}</p><p ng-if="jsonUsedBook.des" style="white-space: pre-wrap">描述:{{jsonUsedBook.des}}</p></ion-item></div><div class="list card"><ion-item class="item-divider item-button-right">主人信息 <a class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_sendMsgToUser({openId:ownerInfo.openId,usedBookAvosObjectId:usedBookAvosObjectId,role:\'buy\'})">联系主人</a></ion-item><user-info json-user-info="ownerInfo" user-used-book-number="ownerUsedBookNumber"></user-info></div></ion-content></ion-view>'),o.put("temp/book/recommend.html",'<ion-view ng-controller="book_recommend" view-title="书循"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><!-- 图书分类--><div ng-if="BookRecommend$[\'BookTag\'][\'tag\']"><ion-item class="item-divider item-button-right">图书分类 <button class="button button-small button-clear button-balanced" style="top: 0" ng-click="bookTagsModalView.show()">更多</button></ion-item><ion-item style="white-space:normal"><button class="button button-small button-outline button-balanced" style="margin: 5px" ui-sref="tab.book_bookList({cmd:\'tag\',tag:tag})" ng-repeat="tag in BookRecommend$[\'BookTag\'].getTagAttrNames()">{{tag}}</button></ion-item></div><!-- 根据专业推荐的书--><div ng-if="BookRecommend$.MajorBook.books.length>0"><ion-item class="item-divider item-button-right">{{BookRecommend$.MajorBook.major}} <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.book_bookList({cmd:\'major\'})">更多</button></ion-item><douban-book-one-line json-books-info="BookRecommend$.MajorBook.books"></douban-book-one-line></div><!-- 用户下学期需要的书--><div ng-if="BookRecommend$.NeedBook.books.length>0"><ion-item class="item-divider item-button-right">你可能需要 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.book_bookList({cmd:\'need\'})">更多</button></ion-item><douban-book-one-line json-books-info="BookRecommend$.NeedBook.books"></douban-book-one-line></div><!-- 用户附近的二手书--><div ng-if="BookRecommend$.NearBook.jsonBooks.length>0"><ion-item class="item-divider item-button-right">附近的旧书 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.book_usedBookList({cmd:\'near\'})">更多</button></ion-item><used-book-one-line json-books-info="BookRecommend$.NearBook.jsonBooks"></used-book-one-line></div><!-- 用户附近的用户--><div ng-if="BookRecommend$.NearUser.jsonUsers.length>0"><ion-item class="item-divider item-button-right">附近的同学 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.book_userList({cmd:\'near\'})">更多</button></ion-item><ion-item style="padding: 0"><img ng-repeat="one in BookRecommend$.NearUser.jsonUsers" ng-src="{{one.avatarUrl}}" ui-sref="tab.book_usedBookListByOwner({ownerId:one.objectId})" style="width: 40px;height: 40px;border-radius: 50%;overflow: hidden;margin: 5px"></ion-item></div></ion-content><!-- 图书所有分类--><script type="text/ng-template" id="template/bookTags.html"><ion-modal-view>\n            <ion-header-bar class="item-input-inset">\n                <h1 class="title">图书热门分类</h1>\n                <button class="button button-clear button-balanced"\n                        ng-click="bookTagsModalView.hide()">返回\n                </button>\n            </ion-header-bar>\n            <ion-content class="has-header">\n                <ion-list>\n                    <div ng-repeat="bigTag in BookRecommend$[\'BookTag\'].getTagAttrNames()">\n                        <ion-item class="item-divider item-button-right">{{bigTag}}</ion-item>\n                        <ion-item style="white-space:normal">\n                            <button class="button button-small button-outline button-balanced" style="margin: 5px"\n                                    ui-sref="tab.book_bookList({cmd:\'tag\',tag:tag})"\n                                    ng-click="bookTagsModalView.hide()"\n                                    ng-repeat="tag in BookRecommend$[\'BookTag\'][\'tag\'][bigTag]">\n                                {{tag}}\n                            </button>\n                        </ion-item>\n                    </div>\n                </ion-list>\n            </ion-content>\n        </ion-modal-view></script></ion-view>'),
o.put("temp/book/searchList.html",'<ion-view view-title="图书搜索"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content ng-controller="book_searchList"><ion-list><!-- 关键字输入框--><ion-item class="item-input-inset"><button class="button button-small button-clear" ng-click="scanQRBtnOnClick()">扫码</button><label class="item-input-wrapper"><i class="icon ion-search placeholder-icon"></i> <input type="search" placeholder="书名 作者 ISBN" ng-model="SearchBook$.keyword" ng-change="SearchBook$.searchInputOnChange()"></label><button class="button button-small button-clear" ng-click="SearchBook$.searchBtnOnClick()">搜索</button></ion-item><!-- 搜索结果列表--><ion-item class="item-thumbnail-left" collection-repeat="book in SearchBook$.books" ui-sref="tab.book_oneBook({isbn13:book.isbn13})"><img ng-src="{{book.image}}"><h2>{{book.title}}</h2><p ng-if="book[\'publisher\']">{{book[\'publisher\']}}/{{book[\'pubdate\']}}</p><p ng-if="book.author">{{book.author.toString()}}</p><p ng-if="book.price">{{book.price}}</p></ion-item></ion-list><ion-infinite-scroll ng-if="SearchBook$.hasMore()" on-infinite="SearchBook$.loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-view>'),o.put("temp/book/usedBookList.html",'<ion-view ng-controller="book_usedBookList" view-title="{{title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><!-- 排序方式--><div class="button-bar padding"><a class="button button-small" ng-click="sortWay=\'price\'" ng-class="{\'button-balanced\':sortWay==\'price\'}">图书价格</a> <a class="button button-small" ng-click="sortWay=\'location\'" ng-class="{\'button-balanced\':sortWay==\'location\'}">离你距离</a></div><ion-list><!-- 二手书列表--><one-used-book ng-repeat="jsonUsedBook in jsonUsedBooks | orderBy:sortWay" json-used-book="jsonUsedBook"></one-used-book></ion-list><ion-infinite-scroll on-infinite="loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-view>'),o.put("temp/book/usedBookListByOwner.html",'<ion-view ng-controller="book_usedBookListByOwner" view-title="主人的二手书"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><ion-list><ion-item class="item-divider item-button-right">主人信息 <a class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_sendMsgToUser({openId:jsonOwnerInfo.openId,role:\'buy\'})">联系主人</a></ion-item><user-info json-user-info="jsonOwnerInfo"></user-info><!-- 搜索结果列表--><one-used-book ng-if="jsonUsedBookList.length>0" ng-repeat="oneJsonUsedBook in jsonUsedBookList" json-used-book="oneJsonUsedBook"></one-used-book><ion-item ng-if="jsonUsedBookList.length==0" style="text-align: center;padding: 0"><a class="button button-small button-clear button-balanced" ui-sref="tab.book_recommend">主人还没旧书要卖,再去逛逛</a></ion-item></ion-list></ion-content></ion-view>'),o.put("temp/book/userList.html",'<!--用户列表--><ion-view ng-controller="book_userList" view-title="{{title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content class="padding"><div class="button-bar"><a class="button button-small" ng-click="sortWay=\'usedBookNumber\'" ng-class="{\'button-balanced\':sortWay==\'usedBookNumber\'}">旧书数量</a> <a class="button button-small" ng-click="sortWay=\'location\'" ng-class="{\'button-balanced\':sortWay==\'location\'}">离你距离</a></div><div class="card" ng-repeat="one in jsonUsers | orderBy:sortWay:true"><user-info json-user-info="one" user-used-book-number="one.usedBookNumber"></user-info></div><ion-infinite-scroll on-infinite="loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-view>'),o.put("temp/person/editOneUsedBook.html",'<!--编辑一本上传的二手书--><ion-view ng-controller="person_editOneUsedBook" view-title="编辑你的 图书名称"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons>+<ion-content class="padding"><!-- 图片信息--><div class="list card"><ion-item style="text-align: center"><img ng-src="{{avosUsedBook.get(\'image\')}}" style="height: 180px"></ion-item></div><!-- 其他信息--><div class="list card"><label class="item item-input item-stacked-label"><span class="input-label">描述</span> <input type="text" placeholder="这书有什么特别之处" ng-model="jsonUsedBookChangeInfo.des" ng-change="valueHasChange=true"></label><label class="item item-input item-stacked-label"><span class="input-label">要价</span> <input type="number" placeholder="人民币 只输入数值" ng-model="jsonUsedBookChangeInfo.price" ng-change="valueHasChange=true"></label></div><!-- 提交--><button class="button button-block button-outline button-balanced" ng-click="submitOnClick()" ng-disabled="!valueHasChange">提交修改</button></ion-content></ion-view>'),o.put("temp/person/editPersonInfo.html",'<!--编辑个人信息--><ion-view ng-controller="person_editPersonInfo" view-title="修改你的信息"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content class="padding"><!-- 基本信息--><user-info json-user-info="userInfo"></user-info><!-- 填写其他信息--><div class="list list-inset"><ion-item class="item-icon-right" ng-click="chooseSchoolModalView.show()">在读学校 <span class="item-note" ng-if="userInfo.school">{{userInfo.school}}</span> <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item class="item-icon-right" ng-click="chooseMajorModalView.show()">所学专业 <span class="item-note" ng-if="userInfo.major">{{userInfo.major}}</span> <i class="icon ion-ios-arrow-right balanced"></i></ion-item><label class="item item-input item-select"><span class="input-label">大学入学时间</span><select ng-model="userInfo.startSchoolYear" ng-change="attrHasChange=true" ng-options="one as one for one in startSchoolYearOptions"></select></label></div><!-- 提交--><button class="button button-block button-outline button-balanced" ng-click="submitOnClick()" ng-disabled="!attrHasChange">提交修改</button></ion-content></ion-view>'),o.put("temp/person/my.html",'<!--个人主页--><ion-view ng-controller="person_my" view-title="我的书循"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ng-click="logOut()">退出</button></ion-nav-buttons><ion-content><!-- 基本信息--><ion-item class="item-divider item-button-right">我的信息 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_editPersonInfo">修改信息</button></ion-item><user-info ng-if="userInfo" json-user-info="userInfo"></user-info><ion-item class="item-divider item-button-right">二手书 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneUsedBook">上传旧书</button></ion-item><!-- 我上传的二手书--><ion-item ng-if="myUsedBookNumber>0" ui-sref="tab.person_usedBooksList" class="item-icon-right">已上传{{myUsedBookNumber}}本旧书 <i class="icon ion-ios-arrow-right balanced"></i></ion-item></ion-content></ion-view>'),o.put("temp/person/sendMsgToUser.html",'<!--个人主页--><ion-view ng-controller="person_sendMsgToUser" view-title="回复{{jsonUser.nickName}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content class="padding"><!-- 正在加载--><div style="text-align: center;padding-top: 10px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><ion-list><!-- 二手书信息--><one-used-book ng-if="jsonUsedBook" json-used-book="jsonUsedBook"></one-used-book><!-- 对方用户信息--><user-info ng-if="jsonUser" json-user-info="jsonUser"></user-info><!-- 对方发的消息--><ion-item ng-if="msg.receiveMsg">{{msg.receiveMsg}}</ion-item><!-- 我的输入框--><label class="item item-input"><input type="text" ng-model="msg.sendMsg" placeholder="输入回复内容" autofocus="autofocus"></label></ion-list><button ng-disabled="!msg.sendMsg || isLoading" class="button button-block button-outline button-balanced" ng-click="sendOnClick()">发送</button><!-- 常用回复语--><ion-list ng-if="commonReplayWords.length>0"><ion-item class="item-divider item-button-right">快速回复内容</ion-item><ion-item style="white-space:normal;padding: 5px"><button class="button button-small button-outline button-balanced" style="margin: 5px" ng-disabled="isLoading" ng-repeat="word in commonReplayWords" ng-click="msg.sendMsg=word">{{word}}</button></ion-item></ion-list></ion-content></ion-view>'),o.put("temp/person/uploadOneUsedBook.html",'<ion-view ng-controller="person_uploadOneUsedBook" view-title="上传二手书"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content style="text-align: center" class="padding"><!-- 正在加载--><div style="text-align: center;padding-top: 10px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><!-- 扫码--><div ng-if="!usedBookInfo.isbn13"><h5>扫码书后面的条形码获得图书信息</h5><button class="button button-outline button-balanced" ng-click="scanQRBtnOnClick()">扫条形码</button><br><button class="button button-clear button-small button-balanced" ng-click="noBarCodeModalView.show()">没条码?</button></div><!-- 图书基本信息--><div class="list card" ng-if="usedBookInfo.isbn13"><!-- 封面--><ion-item style="text-align: center"><img ng-src="{{doubanBookInfo.image}}" style="height: 180px" ng-click="WeChatJS$.previewOneImage(doubanBookInfo.image)"></ion-item><ion-item><p>{{doubanBookInfo.title}}/<span ng-if="doubanBookInfo.price">{{doubanBookInfo.price}}</span></p><!-- 作者--><p ng-if="doubanBookInfo.author.length>0" class="item-button-right">{{doubanBookInfo.author.toString()}} 著</p><!-- 出版信息--><p ng-if="doubanBookInfo[\'publisher\']">{{doubanBookInfo[\'publisher\']}}/{{doubanBookInfo[\'pubdate\']}}</p></ion-item></div><hr style="margin: 10px"><!-- 填写价格和描述--><div class="list list-inset"><label class="item item-input"><input type="number" ng-model="usedBookInfo.price" placeholder="输入要价(人民币)"></label><label class="item item-input"><input type="text" ng-model="usedBookInfo.des" placeholder="对这本书你还有什么想说的吗?"></label></div><button ng-disabled="!(!isLoading && usedBookInfo.isbn13 && usedBookInfo.price)" class="button button-block button-outline button-balanced" ng-click="submitOnClick()">提交二手书</button></ion-content><script type="text/ng-template" id="template/noBarCodeModalView.html"><ion-modal-view>\n            <ion-header-bar>\n                <h2 class="title">书没条码时上传方法</h2>\n                <button class="button button-clear button-balanced"\n                        ng-click="noBarCodeModalView.hide()">返回\n                </button>\n            </ion-header-bar>\n            <ion-content class="padding" style="text-align: center">\n                <img style="max-width: 98%" ng-src="img/noCodeBar.png">\n                <button class="button button-block button-outline button-balanced" ui-sref="tab.book_searchList"\n                        ng-click="noBarCodeModalView.hide()">\n                    开始上传\n                </button>\n            </ion-content>\n        </ion-modal-view></script></ion-view>'),o.put("temp/person/usedBookList.html",'<!--管理上传的二手书列表--><ion-view ng-controller="person_usedBookList" view-title="管理我的二手图书"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content><ion-list><!-- 正在架上--><div style="text-align: center;margin: 10px" ng-if="UsedBook$.isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><ion-item class="item-divider item-button-right">正在架上 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneUsedBook({isbn13:book.isbn13})">上传旧书</button></ion-item><ion-item ng-repeat="oneAvosUsedBook in UsedBook$.myAvosUsedBookList" class="item-thumbnail-left"><img ng-if="oneAvosUsedBook.get(\'image\')" ng-src="{{oneAvosUsedBook.get(\'image\')}}" ui-sref="tab.book_oneBook({isbn13:oneAvosUsedBook.get(\'isbn13\')})"><p ng-if="oneAvosUsedBook.get(\'price\')">要价:{{oneAvosUsedBook.get(\'price\')}}</p><p ng-if="oneAvosUsedBook.get(\'title\')">书名:{{oneAvosUsedBook.get(\'title\')}}</p><p ng-if="oneAvosUsedBook.get(\'des\')">描述:{{oneAvosUsedBook.get(\'des\')}}</p><button class="button button-small button-outline button-assertive" ng-click="UsedBook$.removeUsedBook(oneAvosUsedBook)">删除</button> <button class="button button-small button-outline button-balanced" ui-sref="tab.person_editOneUsedBook({indexInMyAvosUsedBook_notSell:$index})">编辑</button> <button class="button button-small button-outline button-positive" ng-click="UsedBook$.usedBookHasSell(oneAvosUsedBook)">已卖</button></ion-item><ion-item ng-if="UsedBook$.myAvosUsedBookList.length==0">你还没有上传过书,点击 上传旧书</ion-item><!-- 已经卖出--><ion-item class="item-divider">已经卖出</ion-item><ion-item ng-repeat="oneAvosUsedBook in HasSellUsedBook$.myAvosUsedBookList" class="item-avatar item-button-right"><img ng-if="oneAvosUsedBook.get(\'image\')" ng-src="{{oneAvosUsedBook.get(\'image\')}}" ui-sref="tab.book_oneBook({isbn13:oneAvosUsedBook.get(\'isbn13\')})"><h3 ng-if="oneAvosUsedBook.get(\'title\')">书名:{{oneAvosUsedBook.get(\'title\')}}</h3><p ng-if="oneAvosUsedBook.get(\'des\')">描述:{{oneAvosUsedBook.get(\'des\')}}</p><button class="button button-small button-outline button-assertive" style="float: right" ng-click="HasSellUsedBook$.removeUsedBook(oneAvosUsedBook)">删除</button></ion-item><ion-item ng-if="HasSellUsedBook$.myAvosUsedBookList.length==0">你还没有已经卖出的书,点击 已卖</ion-item></ion-list></ion-content></ion-view>'),o.put("temp/tool/chooseMajorModalView.html",'<!-- 选择专业--><ion-modal-view><ion-header-bar class="item-input-inset"><!-- 关键字输入框--><label class="item-input-wrapper"><i class="icon ion-ios7-search placeholder-icon"></i> <input type="search" placeholder="输入名称搜索" ng-model="InfoService$.searchMajorKeyword"></label><button class="button button-clear button-balanced" ng-click="chooseMajorModalView.hide()">返回</button></ion-header-bar><ion-content class="has-header"><ul class="list"><ion-item item-height="55px" collection-repeat="oneMajor in InfoService$.majors | filter:InfoService$.filter_majorByKeyword" ng-click="majorOnChoose(oneMajor[\'name\'])">{{oneMajor[\'name\']}}</ion-item></ul></ion-content></ion-modal-view>'),o.put("temp/tool/chooseSchoolModalView.html",'<!-- 选择学校--><ion-modal-view><ion-header-bar class="item-input-inset"><button class="button button-clear button-balanced" ng-click="InfoService$.School.loadMore()">搜索</button><!-- 关键字输入框--><label class="item-input-wrapper"><i class="icon ion-ios7-search placeholder-icon"></i> <input type="search" placeholder="输入名称搜索" ng-model="InfoService$.School.searchSchoolKeyword"></label><button class="button button-clear button-balanced" ng-click="chooseSchoolModalView.hide()">返回</button></ion-header-bar><ion-content class="has-header"><ul class="list"><ion-item item-height="55px" collection-repeat="school in InfoService$.School.schools | filter:InfoService$.School.filter_schoolByKeyword" ng-click="schoolOnChoose(school)">{{school}}</ion-item></ul><ion-infinite-scroll on-infinite="InfoService$.School.loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-modal-view>'),o.put("temp/tool/doubanBookOneLineTemplate.html",'<ion-item style="text-align: center;padding: 0"><div ng-repeat="jsonBook in jsonBooksInfo.slice(0,showNumber)" ui-sref="tab.book_oneBook({isbn13:jsonBook.isbn13})" style="display: inline-block;padding: 5px;width: 80px;height: 120px"><img ng-if="jsonBook.image" ng-src="{{jsonBook.image}}" style="width: 70px;height: 100px"><h5 ng-if="jsonBook.title" class="title">{{jsonBook.title}}</h5></div></ion-item>'),o.put("temp/tool/hello.html",'<!-- 提示用户登入验证身份信息,进入书循--><ion-view ng-controller="hello" view-title="需要验证你的身份"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content style="text-align: center"><hr style="margin: 30px"><a class="button button-outline button-balanced" ng-href="{{OAuthURL}}">进入书循</a></ion-content></ion-view>'),o.put("temp/tool/oneUsedBookTemplate.html",'<!--一本二手书--><ion-item class="item-thumbnail-left" ui-sref="tab.book_oneUsedBook({usedBookAvosObjectId:jsonUsedBook.objectId})"><img ng-if="jsonUsedBook.image" ng-src="{{jsonUsedBook.image}}"><h3>要价:{{jsonUsedBook.price}}</h3><h4>{{jsonUsedBook.updatedAt | date:\'mediumDate\' }}</h4><p ng-if="jsonUsedBook.title">书名:{{jsonUsedBook.title}}</p><p ng-if="jsonUsedBook.des">描述:{{jsonUsedBook.des}}</p></ion-item>'),o.put("temp/tool/signUp.html",'<!--注册--><ion-view ng-controller="signUp" view-title="加入书循"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content class="padding"><!-- 正在加载--><div style="text-align: center;margin: 5px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><!-- 微信信息--><div class="item item-avatar" ng-if="userInfo.openId"><img ng-src="{{userInfo.avatarUrl}}"><h2>{{userInfo.nickName}} <i class="icon ion-male" style="color: #5eb1ed" ng-if="userInfo.sex==1"></i> <i class="icon ion-female" style="color: #ff6d9e" ng-if="userInfo.sex==2"></i></h2></div><!-- 填写其他信息--><div class="list list-inset"><ion-item class="item-icon-right" ng-click="chooseSchoolModalView.show()">你在读的学校 <span class="item-note" ng-if="userInfo.school">{{userInfo.school}}</span> <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item class="item-icon-right" ng-click="chooseMajorModalView.show()">你所学的专业 <span class="item-note" ng-if="userInfo.major">{{userInfo.major}}</span> <i class="icon ion-ios-arrow-right balanced"></i></ion-item><label class="item item-input item-select"><span class="input-label">大学入学时间</span><select ng-model="userInfo.startSchoolYear"><option ng-repeat="one in startSchoolYearOptions" value="{{one}}">{{one}}</option></select></label></div><!-- 提交--><button class="button button-block button-outline button-balanced" ng-click="submitOnClick()" ng-disabled="isLoading || !(userInfo.school && userInfo.major && userInfo.startSchoolYear)">立即加入</button></ion-content></ion-view>'),o.put("temp/tool/titleAndPreModalView.html",'<!--显示标题和详细文字的modal--><ion-modal-view><ion-header-bar><h2 class="title">{{titleAndPreModalViewData.title}}</h2><button class="button button-clear button-balanced" ng-click="titleAndPreModalView.hide()">返回</button></ion-header-bar><ion-content class="padding"><pre>{{titleAndPreModalViewData.pre}}</pre></ion-content></ion-modal-view>'),o.put("temp/tool/usedBookOneLineTemplate.html",'<ion-item style="text-align: center;padding: 0"><div ng-repeat="jsonBook in jsonBooksInfo.slice(0,showNumber)" ui-sref="tab.book_oneBook({isbn13:jsonBook.isbn13})" style="display: inline-block;padding: 5px;width: 80px;height: 134px"><h5 class="title">{{jsonBook.des}}</h5><img ng-if="jsonBook.image" ng-src="{{jsonBook.image}}" style="width: 70px;height: 100px"><h5 class="title">{{jsonBook.title}}</h5></div></ion-item>'),o.put("temp/tool/userInfoTemplate.html",'<!-- 用户基本信息--><div class="item item-avatar" ng-if="jsonUserInfo"><img ng-src="{{jsonUserInfo.avatarUrl}}"><h2>{{jsonUserInfo.nickName}} <i class="icon ion-male" style="color: #5eb1ed" ng-if="jsonUserInfo.sex==1"></i> <i class="icon ion-female" style="color: #ff6d9e" ng-if="jsonUserInfo.sex==2"></i> <i>{{jsonUserInfo.startSchoolYear}}级</i> <button ng-if="jsonUserInfo.location" class="button button-small button-clear button-balanced" style="float: right" ng-click="WeChatJS$.openMap(jsonUserInfo.location.latitude,jsonUserInfo.location.longitude)">地图</button></h2><p>{{jsonUserInfo.major}}/{{jsonUserInfo.school}}</p></div><!-- 主人所有旧书链接--><ion-item ng-if="userUsedBookNumber" style="padding: 0;text-align: center"><a ng-if="userUsedBookNumber>0" class="button button-small button-clear button-balanced" ui-sref="tab.book_usedBookListByOwner({ownerId:jsonUserInfo.objectId})">查看主人要卖的{{userUsedBookNumber}}本旧书</a> <a ng-if="userUsedBookNumber==0" class="button button-small button-clear button-balanced">主人还没有在买的二手书</a></ion-item>')}]);