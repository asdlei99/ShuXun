"use strict";function jsonp(e,o,t){var n=document.createElement("script");n.type="text/javascript";var i=Date.now()+String(Math.floor(100*Math.random()));n.src=e+(e.indexOf("?")>0?"&":"?")+"callback=CB"+i,n.onload=function(){n.parentNode.removeChild(n)},n.onerror=function(e){t&&t(e)},window["CB"+i]=function(e){o(e)},document.head.appendChild(n)}function createCookie(e,o,t){var n="";if(t){var i=new Date;i.setTime(i.getTime()+24*t*60*60*1e3),n="; expires="+i.toUTCString()}document.cookie=e+"="+o+n+"; path=/"}function readCookie(e){for(var o=e+"=",t=document.cookie.split(";"),n=0;n<t.length;n++){for(var i=t[n];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(o))return i.substring(o.length,i.length)}return null}function eraseCookie(e){createCookie(e,"",-1)}var Model={};if("undefined"!=typeof require)var AV=require("leanengine");Model.User=AV.Object.extend("_User",{avatarUrlWithSize:function(e){var o=this.get("avatarUrl");return o?o.substring(0,o.length-1)+e:null}}),Model.Status=AV.Object.extend("_Status"),Model.BookInfo=AV.Object.extend("BookInfo",{initialize:function(){this.on("change:image",this.genBigImage,this),this.attributes.image&&this.genBigImage()},genBigImage:function(){this.attributes.bigImage=this.get("image"),this.attributes.bigImage.indexOf(".douban.com/")>0&&(this.attributes.bigImage=this.attributes.bigImage.replace("mpic","lpic"))}}),Model.School=AV.Object.extend("School"),Model.UsedBook=AV.Object.extend("UsedBook"),"undefined"!=typeof module&&(module.exports=Model),AV.initialize("kusn9e3cp5znt5lic9fufqfmsvsibsoaejpah089x6v2n7e0","nt5l8v4n4m08zxttpt7upqxwgt6oy47lzb3f8c4juf34otfm"),window.location.host.indexOf("ishuxun.cn")<0&&AV.setProduction(!1);var WECHAT={AppID:"wx2940a8d3ddcad5e9"},LoadCount=Math.floor(document.body.clientWidth/80),RandomStart=(new Date).getDay()*Math.floor(10*Math.random());Array.prototype.pushUniqueArray=function(e){var o=this;AV._.each(e,function(e){e instanceof AV.Object?void 0===AV._.find(o,function(o){return o.id==e.id})&&o.push(e):o.push(e)})},Array.prototype.unshiftUniqueArray=function(e){var o=this;AV._.each(e,function(e){e instanceof AV.Object?void 0===AV._.find(o,function(o){return o.id==e.id})&&o.unshift(e):o.unshift(e)})};var APP=angular.module("APP",["ionic"],null).config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider",function(e,o,t){t.tabs.style("standard"),t.tabs.position("bottom"),e.state("tab",{url:"/tab","abstract":!0,templateUrl:"temp/tabs.html"}).state("tab.book_recommend",{url:"/book/recommend?major",views:{"tab-book":{templateUrl:"temp/book/recommend.html"}}}).state("tab.book_searchList",{url:"/book/searchList/:keyword",views:{"tab-book":{templateUrl:"temp/book/searchList.html"}}}).state("tab.book_bookList",{url:"/book/bookList?cmd&title&tag",views:{"tab-book":{templateUrl:"temp/book/bookList.html"}}}).state("tab.book_usedBookList",{url:"/book/usedBookList?cmd&isbn13&majorFilter",views:{"tab-book":{templateUrl:"temp/book/usedBookList.html"}}}).state("tab.book_oneBook",{url:"/book/oneBook/:isbn13",views:{"tab-book":{templateUrl:"temp/book/oneBook.html"}}}).state("tab.book_oneUsedBook",{url:"/book/oneUsedBook/:usedBookAvosObjectId",views:{"tab-book":{templateUrl:"temp/book/oneUsedBook.html"}}}).state("tab.book_oneNeedBook",{url:"/book/oneNeedBook/:usedBookAvosObjectId",views:{"tab-book":{templateUrl:"temp/book/oneNeedBook.html"}}}).state("tab.book_bookReview",{url:"/book/bookReview?doubanBookId&bookTitle",views:{"tab-book":{templateUrl:"temp/book/bookReview.html"}}}).state("tab.person_editOneUsedBook",{url:"/person/editOneUsedBook/:usedBookId",views:{"tab-person":{templateUrl:"temp/person/editOneUsedBook.html"}}}).state("tab.person_uploadOneUsedBook",{url:"/person/uploadOneUsedBook/:isbn13",views:{"tab-person":{templateUrl:"temp/person/uploadOneUsedBook.html"}}}).state("tab.person_uploadOneNeedBook",{url:"/person/uploadOneNeedBook/:isbn13",views:{"tab-person":{templateUrl:"temp/person/uploadOneNeedBook.html"}}}).state("tab.person_usedBooksList",{url:"/person/usedBookList",views:{"tab-person":{templateUrl:"temp/person/usedBookList.html"}}}).state("tab.person_needBooksList",{url:"/person/needBookList",views:{"tab-person":{templateUrl:"temp/person/needBookList.html"}}}).state("tab.person_statusList",{url:"/person/statusList?cmd",views:{"tab-person":{templateUrl:"temp/person/statusList.html"}}}).state("tab.person_editPersonInfo",{url:"/person/editPersonInfo",views:{"tab-person":{templateUrl:"temp/person/editPersonInfo.html"}}}).state("tab.person_my",{url:"/person/my",views:{"tab-person":{templateUrl:"temp/person/my.html"}}}).state("tab.person_sendMsgToUser",{url:"/person/sendMsgToUser?receiverObjectId&usedBookObjectId&role&inboxType",views:{"tab-person":{templateUrl:"temp/person/sendMsgToUser.html"}}}).state("tab.hello",{url:"/hello",views:{"tab-person":{templateUrl:"temp/tool/hello.html"}}}).state("tab.signUp",{url:"/signUp?code&state",views:{"tab-person":{templateUrl:"temp/tool/signUp.html"}}}).state("tab.userList",{url:"/userList?cmd&title&majorFilter",views:{"tab-book":{templateUrl:"temp/tool/userList.html"}}}).state("tab.userHome",{url:"/userHome/:ownerId",views:{"tab-book":{templateUrl:"temp/tool/userHome.html"}}}),o.otherwise("/tab/book/recommend")}]);APP.run(["$rootScope","$state","User$","WeChatJS$",function(e,o,t,n){n.config(),t.loginWithUnionId(readCookie("unionId")),e.$on("$stateChangeStart",function(e,t){var n=t.name;n.indexOf("tab.person_")>=0&&(AV.User.current()||(e.preventDefault(),o.go("tab.hello")))})}]),APP.service("BookInfo$",["$rootScope",function(e){var o=this;this.getJsonBookByISBN13=function(e){return AV.Cloud.run("getJsonBookByISBN13",{isbn13:e})},this.LatestBook={books:[],hasMoreFlag:!0,loadMore:function(){var t=new AV.Query(Model.BookInfo);t.select(["doubanId","isbn13","title","image","pubdate","author","publisher","pubdate","price"]),t.descending("pubdate"),t.skip(o.LatestBook.books.length+RandomStart),t.limit(LoadCount),t.find().done(function(t){t.length>0?o.LatestBook.books.pushUniqueArray(t):o.LatestBook.hasMoreFlag=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return o.LatestBook.hasMoreFlag}},this.searchBook=function(e){var o=new AV.SearchQuery("BookInfo");return o.queryString(e),o.find(null)}}]),APP.service("BookRecommend$",["$rootScope","DoubanBook$","BookInfo$",function(e,o,t){function n(e,o){var t=new AV.Query(Model.UsedBook);t.descending("updatedAt"),e&&t.equalTo("role",e);var n=AV.User.current(),i=n?n.get("location"):null;if(i&&t.near("location",i),o){var s=new AV.Query(Model.User);n&&s.notEqualTo("objectId",n.id),s.equalTo("major",o),t.matchesQuery("owner",s)}return t}var i=this;this.BookTag={tag:null,load:function(){AV.Cloud.run("getAllBookTags",null,null).done(function(o){i.BookTag.tag=o,e.$apply()})},getTagAttrNames:function(){return i.BookTag.tag?Object.keys(i.BookTag.tag):[]}},this.TagBook={nowTag:"",setTag:function(o){o!=i.TagBook.nowTag&&(i.TagBook.books.length=0,i.TagBook.nowTag=o,t.searchBook(o).done(function(o){i.TagBook.books.unshiftUniqueArray(o),e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")}))},books:[],hasMoreFlag:!0,loadMore:function(){o.getBooksByTag(i.TagBook.nowTag,i.TagBook.books.length,LoadCount,function(o){var t=o.books;if(t.length>0)for(var n=0;n<t.length;n++)i.TagBook.books.push(Model.BookInfo["new"](t[n]));else i.TagBook.hasMoreTag=!1;e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return i.TagBook.hasMoreFlag}},this.NearNeedBook={needBooks:[],hasMoreFlag:!0,loadMore:function(){var o=n("need",i.NearNeedBook._majorFilter);o.skip(i.NearNeedBook.needBooks.length+RandomStart),o.limit(LoadCount),o.find().done(function(o){o.length>0?i.NearNeedBook.needBooks.pushUniqueArray(o):i.NearNeedBook.hasMoreFlag=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return i.NearNeedBook.hasMoreFlag},_majorFilter:null,setMajorFilter:function(e){e!=i.NearNeedBook._majorFilter&&(RandomStart=0,i.NearNeedBook.needBooks.length=0,i.NearNeedBook.hasMoreFlag=!0,i.NearNeedBook._majorFilter=e,i.NearNeedBook.loadMore())},getMajorFilter:function(){return i.NearNeedBook._majorFilter},unshiftMajorBook:function(){var o=AV.User.current(),t=o?o.get("major"):null;n("need",t).find().done(function(o){i.NearNeedBook.needBooks.unshiftUniqueArray(AV._.shuffle(o)),e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})}},this.NearUsedBook={usedBooks:[],hasMoreFlag:!0,loadMore:function(){var o=n("sell",i.NearUsedBook._majorFilter);o.skip(i.NearUsedBook.usedBooks.length+RandomStart),o.limit(LoadCount),o.find().done(function(o){o.length>0?i.NearUsedBook.usedBooks.pushUniqueArray(o):i.NearUsedBook.hasMoreFlag=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return i.NearUsedBook.hasMoreFlag},_majorFilter:null,setMajorFilter:function(e){e!=i.NearUsedBook._majorFilter&&(RandomStart=0,i.NearUsedBook.usedBooks.length=0,i.NearUsedBook.hasMoreFlag=!0,i.NearUsedBook._majorFilter=e,i.NearUsedBook.loadMore())},getMajorFilter:function(){return i.NearUsedBook._majorFilter},unshiftMajorBook:function(){var o=AV.User.current(),t=o?o.get("major"):null;n("sell",t).find().done(function(o){i.NearUsedBook.usedBooks.unshiftUniqueArray(AV._.shuffle(o)),e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})}},this.NearUser={users:[],hasMoreFlag:!0,_buildQuery:function(e){var o=new AV.Query(Model.User);o.descending("updatedAt");var t=AV.User.current();t&&o.notEqualTo("objectId",t.id);var n=t?t.get("location"):null;return n&&o.near("location",n),e&&o.equalTo("major",e),o},loadMore:function(){var o=i.NearUser._buildQuery(i.NearUser._majorFilter);o.skip(i.NearUser.users.length),o.limit(Math.floor(document.body.clientWidth/50)),o.find().done(function(o){o.length>0?i.NearUser.users.pushUniqueArray(o):i.NearUser.hasMoreFlag=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return i.NearUser.hasMoreFlag},_majorFilter:null,setMajorFilter:function(e){e!=i.NearUser._majorFilter&&(i.NearUser.users.length=0,i.NearUser.hasMoreFlag=!0,i.NearUser._majorFilter=e,i.NearUser.loadMore())},getMajorFilter:function(){return i.NearUser._majorFilter},unshiftMajorUser:function(){var e=AV.User.current(),o=e?e.get("major"):null,t=i.NearUser._buildQuery(o);t.find().done(function(e){i.NearUser.users.unshiftUniqueArray(AV._.shuffle(e))})}}}]),APP.service("BusinessSite$",function(){this.getBusinessInfoByISBN=function(e){return AV.Cloud.run("getBusinessInfo",{isbn13:e},null)}}),APP.service("DoubanBook$",["$rootScope","BookInfo$",function(e,o){function t(e){for(var o=e.substring(3,12),t=0,n=0;9>n;n++){var i=parseInt(o.charAt(n));t+=i*(10-n)}var s=t%11,a=11-s,r=String(a);return 10==a?r="X":11==a&&(r="0"),String(o+r)}var n=this,i="http://api.douban.com/v2/book";this.getBookByISBD=function(e,n,s){function a(e){var o=i+"/isbn/"+e;return null==s&&(s="id,rating,author,pubdate,image,binding,translator,catalog,pages,publisher,isbn13,title,author_intro,summary,price"),o+="?fields="+s}jsonp(a(e),function(e){n(e)},function(){13==e.length&&jsonp(a(t(e)),function(e){n(e)},function(){o.getJsonBookByISBN13(e).done(function(e){n(e)}).fail(function(){n(null)})})})},this.getBookByISBD_simple=function(e,o){n.getBookByISBD(e,o,"author,pubdate,image,publisher,title,price,isbn13")},this.searchBooks=function(e,o,t){var n=new AV.Promise(null),s=i+"/search";return e&&e.length<1&&n.resolve([]),s+="?q="+e,o&&(s+="&start="+o),t&&(s+="&count="+t),s+="&fields=isbn13,title,image,author,publisher,pubdate,price",jsonp(s,function(e){n.resolve(e)},function(e){n.reject(e)}),n},this.getBooksByTag=function(e,o,t,n){var s=i+"/search";return!e||e.length<1?[]:(s+="?tag="+e,o&&(s+="&start="+o),t&&(s+="&count="+t),s+="&fields=isbn13,title,image,author,publisher,pubdate,price",void jsonp(s,function(e){n(e)}))},this.BookReview={reviewList:[],nowBookId:null,hasMoreFlag:!0,loadMore:function(){AV.Cloud.run("getDoubanBookReview",{id:n.BookReview.nowBookId,start:n.BookReview.reviewList.length},null).done(function(o){if(o.length>0)for(var t=0;t<o.length;t++)n.BookReview.reviewList.push(o[t]);else n.BookReview.hasMoreFlag=!1;e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMore:function(){return n.BookReview.hasMoreFlag},clear:function(){n.BookReview.reviewList=[],n.BookReview.hasMoreFlag=!0,e.$broadcast("scroll.infiniteScrollComplete")}}}]),APP.service("InfoService$",["$rootScope",function(e){var o=this;this.majors=[],AV.Cloud.run("getAllMajor",null,null).done(function(e){o.majors=e}),this.searchMajorKeyword="",this.filter_majorByKeyword=function(e){return e.name.indexOf(o.searchMajorKeyword)>-1},this.School={schools:[],loadMore:function(){var t=AV.User.current()?AV.User.current().get("location"):null,n=new AV.Query(Model.School);t&&n.near("location",t),o.School.searchSchoolKeyword.length>0?n.startsWith("name",o.School.searchSchoolKeyword):(n.skip(o.School.schools.length),n.limit(10)),n.find().done(function(t){if(t.length>0)for(var n=0;n<t.length;n++)o.School.schools.push(t[n].get("name"));e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},searchSchoolKeyword:"",filter_schoolByKeyword:function(e){return e.indexOf(o.School.searchSchoolKeyword)>=0}},this.startSchoolYearOptions=[];for(var t=(new Date).getFullYear(),n=t-6;t>=n;n++)o.startSchoolYearOptions.push(n.toString());this.commonUsedBookDesWords=["正版","新书","送笔记","可议价","不议价","配光盘","妹子白送"]}]),APP.service("IonicModalView$",["$rootScope","$ionicModal","$ionicHistory","InfoService$",function(e,o,t,n){this.registerChooseSchoolModalView=function(e,t){e.InfoService$=n,o.fromTemplateUrl("temp/tool/chooseSchoolModalView.html",{scope:e}).then(function(o){e.chooseSchoolModalView=o}),e.schoolOnChoose=function(o){t(o),e.chooseSchoolModalView.hide()}},this.registerChooseMajorModalView=function(e,t){e.InfoService$=n,o.fromTemplateUrl("temp/tool/chooseMajorModalView.html",{scope:e}).then(function(o){e.chooseMajorModalView=o}),e.majorOnChoose=function(o){t(o),e.chooseMajorModalView.hide()}},this.alertTitleAndPreModalView=function(t,n){var i=e.$new(!0);i.titleAndPreModalViewData={title:t,pre:n},o.fromTemplateUrl("temp/tool/titleAndPreModalView.html",{scope:i}).then(function(e){i.titleAndPreModalView=e,e.show()})}}]),APP.service("SearchBook$",["$rootScope","$timeout","DoubanBook$","BookInfo$",function(e,o,t,n){var i=this;this.keyword="",this.books=[],this.hasMore=function(){return i.books.length<i.totalNum},this.totalNum=0,this.loadMore=function(){i.isLoading=!0,i.keyword.length>0&&t.searchBooks(i.keyword,i.books.length,10).done(function(e){if(i.totalNum=e.total,i.totalNum>0)for(var o=e.books,t=0;t<o.length;t++)i.books.push(Model.BookInfo["new"](o[t]));else alert("没有找到你想要的图书")}).always(function(){i.isLoading=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})};var s=null;this.searchBtnOnClick=function(){i.loadMore(),o.cancel(s)},this.searchInputOnChange=function(){i.books=[],i.totalNum=0,o.cancel(s),s=o(function(){i.loadFromBookInfo(),i.searchBtnOnClick()},1e3)},this.loadFromBookInfo=function(){i.isLoading=!0,n.searchBook(i.keyword).done(function(o){i.books.unshiftUniqueArray(o),i.totalNum+=o.length,i.isLoading=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})}}]),APP.service("Status$",["$rootScope",function(e){var o=this;this.unreadCountSum=function(){return o.NewUsedBookStatus.unreadCount+o.NewNeedBookStatus.unreadCount+o.PrivateStatus.unreadCount+o.ReviewUsedBookStatus.unreadCount},this.loadUnreadStatusesCount=function(){var t=AV.User.current();t&&(AV.Status.countUnreadStatuses(t,"newUsedBook").done(function(t){o.NewUsedBookStatus.unreadCount=t.unread,e.$apply()}),AV.Status.countUnreadStatuses(t,"newNeedBook").done(function(t){o.NewNeedBookStatus.unreadCount=t.unread,e.$apply()}),AV.Status.countUnreadStatuses(t,"private").done(function(t){o.PrivateStatus.unreadCount=t.unread,e.$apply()}),AV.Status.countUnreadStatuses(t,"reviewUsedBook").done(function(t){o.ReviewUsedBookStatus.unreadCount=t.unread,e.$apply()}))},this.NewUsedBookStatus={unreadCount:0,statusList:[],load:function(){var t=AV.Status.inboxQuery(AV.User.current(),"newUsedBook");t.include("usedBook"),t.include("source"),t.limit(o.NewUsedBookStatus.unreadCount),t.find().done(function(t){o.NewUsedBookStatus.statusList.length=0;for(var n=0;n<t.length;n++){var i=t[n];i.attributes=i.data,o.NewUsedBookStatus.statusList.push(i)}o.NewUsedBookStatus.unreadCount=0,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})}},this.NewNeedBookStatus={unreadCount:0,statusList:[],load:function(){var t=AV.Status.inboxQuery(AV.User.current(),"newNeedBook");t.include("usedBook"),t.include("source"),t.limit(o.NewNeedBookStatus.unreadCount),t.find().done(function(t){o.NewNeedBookStatus.statusList.length=0;for(var n=0;n<t.length;n++){var i=t[n];i.attributes=i.data,o.NewNeedBookStatus.statusList.push(i)}o.NewNeedBookStatus.unreadCount=0,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})}},this.PrivateStatus={unreadCount:0,statusList:[],load:function(){var t=AV.Status.inboxQuery(AV.User.current(),"private");t.include("usedBook"),t.include("source"),t.limit(o.PrivateStatus.unreadCount),t.find().done(function(t){o.PrivateStatus.statusList.length=0;for(var n=0;n<t.length;n++){var i=t[n];i.attributes=i.data,o.PrivateStatus.statusList.push(i)}o.PrivateStatus.unreadCount=0,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})}},this.ReviewUsedBookStatus={unreadCount:0,statusList:[],load:function(){var t=AV.Status.inboxQuery(AV.User.current(),"reviewUsedBook");t.include("usedBook"),t.include("source"),t.limit(o.ReviewUsedBookStatus.unreadCount),t.find().done(function(t){o.ReviewUsedBookStatus.statusList.length=0;for(var n=0;n<t.length;n++){var i=t[n];i.attributes=i.data,o.ReviewUsedBookStatus.statusList.push(i)}o.ReviewUsedBookStatus.unreadCount=0,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})}},this.sendPrivateMsg=function(e,o,t,n){var i=new AV.Status(null,o);return i.set("to",AV.Object.createWithoutData("_User",e)),n&&i.set("usedBook",AV.Object.createWithoutData("UsedBook",n)),i.set("role",t),AV.Status.sendPrivateStatus(i,e)},this.reviewUsedBook=function(e,o,t,n){var i=new AV.Promise(null),s=new AV.Query(Model.UsedBook);return s.select("owner"),s.get(o).done(function(o){var a=o.get("owner");s=new AV.Query(Model.User),s.equalTo("objectId",a.id);var r=new AV.Status(null,t);r.query=s,r.inboxType="reviewUsedBook",r.set("to",AV.Object.createWithoutData("_User",e)),r.set("role",n),r.set("usedBook",o),r.send().done(function(e){e.attributes=e.data,i.resolve(e)}).fail(function(e){i.reject(e)})}).fail(function(e){i.reject(e)}),i},this.getStatusList_reviewBook=function(e){var o=new AV.Query(Model.Status),t=AV.Object.createWithoutData("UsedBook",e);return o.equalTo("inboxType","reviewUsedBook"),o.equalTo("usedBook",t),o.include("source","to"),o.find()},this.makeQueryStatusList_twoUser=function(e,o){if(e){var t=AV.User.current(),n=AV.Object.createWithoutData("_User",e),i=new AV.Query(Model.Status);i.equalTo("source",t),i.equalTo("to",n);var s=new AV.Query(Model.Status);if(s.equalTo("source",n),s.equalTo("to",t),o){var a=AV.Object.createWithoutData("UsedBook",o);i.equalTo("usedBook",a),s.equalTo("usedBook",a)}return AV.Query.or(i,s)}return new AV.Error(1,"缺少avosUserId")},this.cleanMyInbox=function(e,t,n){var i=AV.User.current(),s=AV.Status.inboxQuery(i,e);t&&s.equalTo("usedBook",AV.Object.createWithoutData("UsedBook",t)),n&&s.equalTo("source",AV.Object.createWithoutData("_User",n)),s.find().done(function(){o.loadUnreadStatusesCount()})}}]),APP.service("UsedBook$",["$rootScope",function(e){var o=this;this.isLoading=!1,this.loadUsedBookListForOwner=function(e){var o=e.relation("usedBooks").query();return o.equalTo("role","sell"),o.find()},this.loadNeedBookListForOwner=function(e){var o=e.relation("usedBooks").query();return o.equalTo("role","need"),o.find()},this.myUsedBookList=[],this.loadMyUsedBookList=function(){o.isLoading=!0;var t=AV.User.current().relation("usedBooks").query();t.equalTo("role","sell"),t.descending("updatedAt"),t.find().done(function(e){o.myUsedBookList.length=0,o.myUsedBookList.pushUniqueArray(e)}).always(function(){o.isLoading=!1,e.$apply()})},this.myNeedBookList=[],this.loadMyNeedBookList=function(){o.isLoading=!0;var t=AV.User.current().relation("usedBooks").query();t.equalTo("role","need"),t.descending("updatedAt"),t.find().done(function(e){o.myNeedBookList.length=0,o.myNeedBookList.pushUniqueArray(e)}).always(function(){o.isLoading=!1,e.$apply()})},this.removeUsedBook=function(e){var t=e.get("role");window.confirm("你确定要删除它吗?将不可恢复")&&e.destroy().done(function(){"sell"==t?o.loadMyUsedBookList():"need"==t&&o.loadMyNeedBookList()}).fail(function(e){alert(e.message)})},this.ISBN_sell={getUsedBookNumberEqualISBN:function(e){var o=new AV.Query(Model.UsedBook);return o.equalTo("role","sell"),o.equalTo("isbn13",e),o.count()},nowISBN13:"",nowEqualISBNUsedBooks:[],loadMoreUsedBookEqualISBN:function(t){o.isLoading=!0,t!=o.ISBN_sell.nowISBN13&&(o.ISBN_sell.nowISBN13=t,o.ISBN_sell.nowEqualISBNUsedBooks=[],o.ISBN_sell.hasMoreFlag=!0);var n=new AV.Query(Model.UsedBook);n.equalTo("isbn13",o.ISBN_sell.nowISBN13),n.equalTo("role","sell"),n.descending("updatedAt"),n.skip(o.ISBN_sell.nowEqualISBNUsedBooks.length),n.limit(5),n.include("owner"),n.find().done(function(e){e.length>0?o.ISBN_sell.nowEqualISBNUsedBooks.pushUniqueArray(e):o.ISBN_sell.hasMoreFlag=!1}).always(function(){o.isLoading=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMoreFlag:!0,hasMore:function(){return o.ISBN_sell.hasMoreFlag}},this.ISBN_need={getNeedBookNumberEqualISBN:function(e){var o=new AV.Query(Model.UsedBook);return o.equalTo("role","need"),o.equalTo("isbn13",e),o.count()},nowISBN13:"",nowEqualISBNNeedBooks:[],loadMoreNeedBookEqualISBN:function(t){o.isLoading=!0,t!=o.ISBN_need.nowISBN13&&(o.ISBN_need.nowISBN13=t,o.ISBN_need.nowEqualISBNNeedBooks=[],o.ISBN_need.hasMoreFlag=!0);var n=new AV.Query(Model.UsedBook);n.equalTo("isbn13",o.ISBN_need.nowISBN13),n.equalTo("role","need"),n.descending("updatedAt"),n.skip(o.ISBN_need.nowEqualISBNNeedBooks.length),n.limit(5),n.include("owner"),n.find().done(function(e){e.length>0?o.ISBN_need.nowEqualISBNNeedBooks.pushUniqueArray(e):o.ISBN_need.hasMoreFlag=!1}).always(function(){o.isLoading=!1,e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMoreFlag:!0,hasMore:function(){return o.ISBN_need.hasMoreFlag}}}]),APP.service("User$",["$rootScope","Status$",function(e,o){var t=this;this.signUpWithJSONUser=function(e){var o=e.unionId;delete e.unionId;var t=Model.User["new"](e);return t.set("username",o),t.set("password",o),t.signUp(null)},this.followUser=function(o){var t=AV.User.current();t?t.follow(o).done(function(){e.$broadcast("FollowSomeone")}).fail(function(e){alert("关注失败:"+e.message)}):alert("请先登入")},this.unfollowUser=function(o){var t=AV.User.current();t?t.unfollow(o).done(function(){e.$broadcast("UnfollowSomeone")}).fail(function(e){alert("取消关注失败:"+e.message)}):alert("请先登入")},this.Followee={users:[],loadMore:function(){var o=AV.User.current().followeeQuery();if(o.include("followee"),o.skip(t.Followee.users.length),o.limit(10),t.Followee._majorFilter){var n=new AV.Query(Model.User);n.equalTo("major",t.Followee._majorFilter),o.matchesQuery("followee",n)}o.find().done(function(o){if(o.length>0){for(var n=0;n<o.length;n++)o[n].avatarUrlWithSize=Model.User.prototype.avatarUrlWithSize;t.Followee.users.pushUniqueArray(o)}else t.Followee.hasMoreFlag=!1;e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMoreFlag:!0,hasMore:function(){return t.Followee.hasMoreFlag},_majorFilter:null,setMajorFilter:function(e){e!=t.Followee._majorFilter&&(t.Followee.users.length=0,t.Followee.hasMoreFlag=!0,t.Followee._majorFilter=e,t.Followee.loadMore())},getMajorFilter:function(){return t.Followee._majorFilter}},this.Follower={users:[],loadMore:function(){var o=AV.User.current().followerQuery();if(o.include("follower"),o.skip(t.Follower.users.length),o.limit(10),t.Follower._majorFilter){var n=new AV.Query(Model.User);n.equalTo("major",t.Follower._majorFilter),o.matchesQuery("follower",n)}o.find().done(function(o){if(o.length>0){for(var n=0;n<o.length;n++)o[n].avatarUrlWithSize=Model.User.prototype.avatarUrlWithSize;t.Follower.users.pushUniqueArray(o)}else t.Follower.hasMoreFlag=!1;e.$apply(),e.$broadcast("scroll.infiniteScrollComplete")})},hasMoreFlag:!0,hasMore:function(){return t.Follower.hasMoreFlag},_majorFilter:null,setMajorFilter:function(e){e!=t.Follower._majorFilter&&(t.Follower.users.length=0,t.Follower.hasMoreFlag=!0,t.Follower._majorFilter=e,t.Follower.loadMore())},getMajorFilter:function(){return t.Follower._majorFilter}},this.loginWithUnionId=function(e){var t=new AV.Promise(null);return e?AV.User.logIn(e,e).done(function(e){t.resolve(e),o.loadUnreadStatusesCount()}).fail(function(e){t.reject(e)}):t.reject("unionId错误"),t},this.getOAuthUserInfo=function(e){var o=new AV.Promise(null);return e?AV.Cloud.run("getWechatOAuthUserInfo",{code:e},null).done(function(e){var t={openId:e.openid,unionId:e.unionid,nickName:e.nickname,sex:e.sex,avatarUrl:e.headimgurl};createCookie("unionId",t.unionId,365),o.resolve(t)}).fail(function(e){o.reject(e)}):o.reject("不合法的code"),o},this.updateMyInfoWithJson=function(e){var o=new AV.Promise(null),n=readCookie("unionId");return t.loginWithUnionId(n).done(function(t){for(var n in e)t.set(n,e[n]);t.save().done(function(){o.resolve(t)}).fail(function(e){o.reject(e)})}).fail(function(e){o.reject(e)}),o}}]),APP.service("WeChatJS$",["$rootScope",function(e){function o(e){var o={title:"书循",desc:"让你的课本重复利用",link:window.location.href,imgUrl:"http://"+window.location.host+"/wechat/img/logo-R.png"};return o=angular.extend(o,e)}var t=this;this.config=function(){AV.Cloud.run("getWechatJsConfig",{url:location.href.split("#")[0]},null).done(function(e){wx.config(e)})},wx.ready(function(){wx.onMenuShareTimeline(o()),wx.onMenuShareAppMessage(o()),wx.onMenuShareQQ(o()),wx.onMenuShareWeibo(o()),wx.getLocation({success:function(e){AV.Cloud.run("updateMyLocation",{latitude:e.latitude,longitude:e.longitude},null)},fail:function(){AV.Cloud.run("updateMyLocation",null,null)},cancel:function(){AV.Cloud.run("updateMyLocation",null,null)}})}),wx.error(function(){t.config()}),this.scanQRCode=function(o){wx.scanQRCode({needResult:1,scanType:["barCode"],success:function(t){o(t.resultStr.split(",")[1]),e.$apply()}})},this.previewOneImage=function(e){wx.previewImage({current:e,urls:[e]})},this.getOAuthURL=function(){var e=location.href.split("#")[0]+"#/tab/signUp";return"https://open.weixin.qq.com/connect/oauth2/authorize?appid="+WECHAT.AppID+"&redirect_uri="+encodeURIComponent(e)+"&response_type=code&scope=snsapi_base&state=#wechat_redirect"},this.openMap=function(e,o){jsonp("http://apis.map.qq.com/ws/coord/v1/translate?type=1&key=R3DBZ-HEYRF-ZSZJ3-JAJJN-2ZWFF-SLBJV&output=jsonp&locations="+e+","+o,function(e){if(0==e.status){var o=e.locations[0];wx.openLocation({latitude:o.lat,longitude:o.lng,name:"该同学位置"})}})}}]),APP.controller("book_bookList",["$scope","$stateParams","BookRecommend$","BookInfo$",function(e,o,t,n){e.title=o.title;var i=o.cmd;if("tag"==i){var s=o.tag;t.TagBook.setTag(s),t.TagBook.loadMore(),e.title=s,e.books=t.TagBook.books,e.loadMore=t.TagBook.loadMore,e.hasMore=t.TagBook.hasMore}else"latest"==i&&(e.books=n.LatestBook.books,e.loadMore=n.LatestBook.loadMore,e.title="新书速递",e.hasMore=n.LatestBook.hasMore)}]),APP.controller("book_bookReview",["$scope","$stateParams","DoubanBook$",function(e,o,t){e.BookReview=t.BookReview,e.BookReview.nowBookId=o.doubanBookId,e.title=o.bookTitle+" 书评",e.$on("$ionicView.afterLeave",function(){e.BookReview.clear()})}]),APP.controller("book_oneBook",["$scope","$state","$stateParams","$ionicModal","DoubanBook$","WeChatJS$","InfoService$","UsedBook$","IonicModalView$","BusinessSite$","User$",function(e,o,t,n,i,s,a,r,l,u,d){e.User$=d,e.isbn13=t.isbn13,e.book=null,e.isLoading=!0,i.getBookByISBD(e.isbn13,function(t){t?(t.image=t.image.replace("mpic","lpic"),e.book=t,e.isbn13=t.isbn13,e.isLoading=!1,e.$apply(),u.getBusinessInfoByISBN(t.isbn13).done(function(o){e.businessInfos=o,e.$apply()})):(alert("没有找到图书信息,再去搜搜看~"),o.go("tab.book_searchList"))}),e.showAuthorIntro=function(){var o=e.book.author.toString(),t=e.book.author_intro;l.alertTitleAndPreModalView(o,t)},e.showPubInfo=function(){var o="出版信息",t=e.book,n="作者:"+t.author.toString()+"\n出版社:"+t.publisher+"\n出版年:"+t.pubdate+"\n页数:"+t.pages+"\n定价:"+t.price+"\n装帧:"+t.binding+"\nISBN:"+t.isbn13+"\n目录:\n"+t.catalog;l.alertTitleAndPreModalView(o,n)},e.showSummary=function(){var o="图书简介",t=e.book.summary;l.alertTitleAndPreModalView(o,t)},e.UsedBook$=r,r.ISBN_sell.getUsedBookNumberEqualISBN(e.isbn13).done(function(o){e.usedBookNumber=o}),r.ISBN_sell.loadMoreUsedBookEqualISBN(e.isbn13),r.ISBN_need.getNeedBookNumberEqualISBN(e.isbn13).done(function(o){e.needBookNumber=o}),r.ISBN_need.loadMoreNeedBookEqualISBN(e.isbn13),e.WeChatJS$=s}]),APP.controller("book_oneUsedBook",["$scope","$stateParams","UsedBook$","User$","WeChatJS$","Status$",function(e,o,t,n,i,s){e.User$=n,e.WeChatJS$=i,e.usedBookObjectId=o.usedBookAvosObjectId,e.usedBook=new Model.UsedBook,e.usedBook.id=e.usedBookObjectId,e.usedBook.fetch().done(function(){e.usedBook.attributes.image&&e.usedBook.set("image",e.usedBook.attributes.image.replace("mpic","lpic")),e.usedBook.attributes.owner.fetch().done(function(){e.$apply()}),e.$apply()}),s.getStatusList_reviewBook(e.usedBookObjectId).done(function(o){e.statusList=o,e.$apply()})}]),APP.controller("book_recommend",["$scope","$state","$stateParams","$ionicModal","BookRecommend$","IonicModalView$","User$","BookInfo$",function(e,o,t,n,i,s,a,r){function l(){if(e.major=t.major,e.major)i.NearUsedBook.setMajorFilter(e.major),i.NearNeedBook.setMajorFilter(e.major),i.NearUser.setMajorFilter(e.major),i.TagBook.setTag(e.major);else{i.NearUsedBook.unshiftMajorBook(),i.NearNeedBook.unshiftMajorBook(),i.NearUser.unshiftMajorUser();var o=AV.User.current();o&&i.TagBook.setTag(o.get("major"))}i.TagBook.loadMore()}e.User$=a,e.BookRecommend$=i,e.LatestBook=r.LatestBook,i.NearUser.loadMore(),i.BookTag.load(),e.LatestBook.loadMore(),i.NearUsedBook.loadMore(),i.NearNeedBook.loadMore(),n.fromTemplateUrl("template/bookTags.html",{scope:e}).then(function(o){e.bookTagsModalView=o}),e.$on("$ionicView.afterEnter",l),s.registerChooseMajorModalView(e,function(e){o.go("tab.book_recommend",{major:e})})}]),APP.controller("book_searchList",["$scope","$timeout","$state","$stateParams","SearchBook$","WeChatJS$",function(e,o,t,n,i,s){e.SearchBook$=i;var a=n.keyword;a&&(i.keyword=a,i.searchBtnOnClick()),e.scanQRBtnOnClick=function(){s.scanQRCode(function(e){e&&e.length>=10&&e.length<=13?t.go("tab.book_oneBook",{isbn13:e}):alert("不合法的ISBN号")})}}]),APP.controller("book_usedBookList",["$scope","$stateParams","UsedBook$","BookRecommend$","IonicModalView$",function(e,o,t,n,i){e.cmd=o.cmd,e.sortWay="","nearUsed"==e.cmd?(e.title="你附近的二手书",e.usedBooks=n.NearUsedBook.usedBooks,e.loadMore=n.NearUsedBook.loadMore,e.hasMore=n.NearUsedBook.hasMore,e.setMajorFilter=n.NearUsedBook.setMajorFilter,e.getMajorFilter=n.NearUsedBook.getMajorFilter):"nearNeed"==e.cmd?(e.title="你附近的求书",e.usedBooks=n.NearNeedBook.needBooks,e.loadMore=n.NearNeedBook.loadMore,e.hasMore=n.NearNeedBook.hasMore,e.setMajorFilter=n.NearNeedBook.setMajorFilter,e.getMajorFilter=n.NearNeedBook.getMajorFilter):"isbnUsed"==e.cmd?(e.title="对应要卖的旧书",e.isbn13=o.isbn13,e.usedBooks=t.ISBN_sell.nowEqualISBNUsedBooks,e.loadMore=t.ISBN_sell.loadMoreUsedBookEqualISBN,e.hasMore=t.ISBN_sell.hasMore):"isbnNeed"==e.cmd&&(e.title="需要这本书的同学",e.isbn13=o.isbn13,e.usedBooks=t.ISBN_need.nowEqualISBNNeedBooks,e.loadMore=t.ISBN_need.loadMoreNeedBookEqualISBN,e.hasMore=t.ISBN_need.hasMore),i.registerChooseMajorModalView(e,function(o){e.setMajorFilter&&e.setMajorFilter(o),e.title+="-"+o});var s=o.majorFilter;s&&e.setMajorFilter&&(e.setMajorFilter(s),e.title+="-"+e.getMajorFilter())}]),APP.controller("hello",["$scope","$state","$stateParams","$ionicHistory","WeChatJS$","User$",function(e,o,t,n,i,s){
s.loginWithUnionId(readCookie("unionId")).done(function(){o.go("tab.person_my"),n.clearHistory()}),e.OAuthURL=i.getOAuthURL()}]),APP.controller("person_editOneUsedBook",["$scope","$state","$ionicHistory","$stateParams","UsedBook$",function(e,o,t,n,i){var s=n.usedBookId;e.usedBook=new Model.UsedBook,e.usedBook.id=s,e.usedBook.fetch().done(function(){e.$apply()}),e.valueHasChange=!1,e.submitOnClick=function(){e.usedBook.set("des",e.usedBook.attributes.des),e.usedBook.set("price",e.usedBook.attributes.price),e.usedBook.save(null).done(function(){"sell"==e.usedBook.get("role")?(i.loadMyUsedBookList(),o.go("tab.person_usedBooksList")):"need"==e.usedBook.get("role")&&(i.loadMyNeedBookList(),o.go("tab.person_needBooksList")),t.clearHistory()}).fail(function(e){alert(e.message)})}}]),APP.controller("person_editPersonInfo",["$scope","$state","$ionicHistory","InfoService$","User$","IonicModalView$",function(e,o,t,n,i,s){e.attrHasChange=!1,e.me=AV.User.current();var a=e.me.attributes;e.userInfo={school:a.school,major:a.major,wechatAlert:a.wechatAlert,startSchoolYear:a.startSchoolYear},s.registerChooseSchoolModalView(e,function(o){e.attrHasChange=!0,e.userInfo.school=o}),s.registerChooseMajorModalView(e,function(o){e.attrHasChange=!0,e.userInfo.major=o}),e.startSchoolYearOptions=n.startSchoolYearOptions,e.confirmWechatAlert=function(){0==e.userInfo.wechatAlert&&(e.userInfo.wechatAlert=!window.confirm("关闭后有同学给你发消息时你将收不到通知,确定关闭吗?"))},e.submitOnClick=function(){i.updateMyInfoWithJson(e.userInfo).done(function(){alert("修改成功"),AV.User.current().fetch()}).fail(function(e){alert("修改失败:"+e.message)}).always(function(){o.go("tab.person_my"),t.clearHistory()})}}]),APP.controller("person_my",["$scope","$state","$stateParams","User$","Status$",function(e,o,t,n,i){function s(){e.user=AV.User.current();var o=AV.User.current().relation("usedBooks"),t=o.query();t.equalTo("role","sell"),t.count().done(function(o){e.myUsedBookNumber=o,e.$apply()}),t=o.query(),t.equalTo("role","need"),t.count().done(function(o){e.myNeedBookNumber=o,e.$apply()}),t=AV.User.current().followeeQuery(),t.count().done(function(o){e.followeeNumber=o,e.$apply()}),t=AV.User.current().followerQuery(),t.count().done(function(o){e.followerNumber=o,e.$apply()}),i.loadUnreadStatusesCount()}e.Status$=i,e.$on("$ionicView.afterEnter",s),e.logOut=function(){AV.User.logOut(),eraseCookie("unionId"),wx.closeWindow()}}]),APP.controller("person_needBookList",["$scope","$ionicScrollDelegate","UsedBook$",function(e,o,t){e.UsedBook$=t,t.loadMyNeedBookList(),e.$on("$ionicView.afterEnter",function(){o.scrollTop(!0)})}]),APP.controller("person_sendMsgToUser",["$scope","$state","$stateParams","$ionicHistory","$ionicScrollDelegate","User$","UsedBook$","Status$",function(e,o,t,n,i,s,a,r){function l(){var o=r.makeQueryStatusList_twoUser(u,e.msg.usedBookObjectId);o.skip(e.statusList.length),o.find().done(function(o){e.statusList.pushUniqueArray(o),i.scrollBottom(!0),e.$apply()})}var u=t.receiverObjectId;e.isLoading=!1,e.msg={inboxType:t.inboxType,role:t.role,sendMsg:"",usedBookObjectId:t.usedBookObjectId},e.nowModel=function(){if("private"==e.msg.inboxType){if("sell"==e.msg.role)return"回应卖家的私信";if("buy"==e.msg.role)return"给图书主人发私信"}else if("reviewUsedBook"==e.msg.inboxType){if("sell"==e.msg.role)return"回复买家对旧书的评论";if("buy"==e.msg.role)return"对主人的旧书发表评论"}},AV.Object.createWithoutData("_User",u).fetch().done(function(o){e.user=o,e.$apply()}),e.statusList=[],e.commonReplayWords=[],e.commonReplayWords="sell"==e.msg.role?["求微信号","成交","不能再便宜了","这本书已经卖出去了"]:["求微信号","成交","可以再便宜点吗?","你在什么地方?","书有破损吗?"],e.msg.usedBookObjectId&&(e.usedBook=new Model.UsedBook,e.usedBook.id=e.msg.usedBookObjectId,e.usedBook.fetch().done(function(){e.$apply()})),e.sendOnClick=function(){e.isLoading=!0;var o;"private"==e.msg.inboxType?o=r.sendPrivateMsg(u,e.msg.sendMsg,e.msg.role,e.msg.usedBookObjectId):"reviewUsedBook"==e.msg.inboxType&&(o=r.reviewUsedBook(u,e.msg.usedBookObjectId,e.msg.sendMsg,e.msg.role)),o.done(function(){e.statusList.push(Model.Status["new"]({message:e.msg.sendMsg})),i.scrollBottom(!0)}).fail(function(e){alert("发送失败:"+JSON.stringify(e))}).always(function(){e.isLoading=!1,e.msg.sendMsg="",e.$apply()})};var d;e.$on("$ionicView.afterEnter",function(){d=setInterval(function(){r.makeQueryStatusList_twoUser(u,e.msg.usedBookObjectId).count().done(function(o){o>e.statusList.length&&l()})},1e3)}),e.$on("$ionicView.afterLeave",function(){clearInterval(d),r.cleanMyInbox(e.msg.inboxType,e.msg.usedBookObjectId,u)})}]),APP.controller("person_statusList",["$scope","$stateParams","Status$",function(e,o,t){e.cmd=o.cmd,"newUsedBook"==e.cmd?(e.title="同学新上传的旧书",e.statusList=t.NewUsedBookStatus.statusList,t.NewUsedBookStatus.load()):"newNeedBook"==e.cmd?(e.title="同学新发布的求书",e.statusList=t.NewNeedBookStatus.statusList,t.NewNeedBookStatus.load()):"private"==e.cmd?(e.title="你收到的私信",e.statusList=t.PrivateStatus.statusList,t.PrivateStatus.load()):"reviewUsedBook"==e.cmd&&(e.title="同学对你的书的评论",e.statusList=t.ReviewUsedBookStatus.statusList,t.ReviewUsedBookStatus.load())}]),APP.controller("person_uploadOneUsedBook",["$scope","$state","$stateParams","$ionicHistory","$ionicScrollDelegate","$ionicModal","DoubanBook$","WeChatJS$","UsedBook$","InfoService$",function(e,o,t,n,i,s,a,r,l,u){function d(){e.isLoading=!0,a.getBookByISBD_simple(e.usedBookInfo.isbn13,function(t){t?(e.doubanBookInfo=t,e.usedBookInfo.isbn13=t.isbn13,e.isLoading=!1,e.usedBookInfo.image=t.image.replace("mpic","lpic"),e.usedBookInfo.title=t.title,e.$apply()):(alert("没有找到图书信息,再去搜搜看~"),o.go("tab.book_searchList"))})}e.isLoading=!1,e.WeChatJS$=r,e.$on("$ionicView.afterEnter",function(){e.usedBookInfo={isbn13:t.isbn13,price:null,des:"",image:"",title:""},i.scrollTop(),e.usedBookInfo.isbn13&&d(),e.usedBookInfo.owner=AV.User.current()}),s.fromTemplateUrl("template/helpModalView.html",{scope:e}).then(function(o){e.noBarCodeModalView=o}),e.scanQRBtnOnClick=function(){r.scanQRCode(function(o){e.usedBookInfo.isbn13=o,d()})},e.submitOnClick=function(t){e.usedBookInfo.role=t,e.isLoading=!0;var i=Model.UsedBook["new"](e.usedBookInfo);i.save(null).done(function(){"sell"==t?(l.loadMyUsedBookList(),o.go("tab.person_usedBooksList")):"need"==t&&(l.loadMyNeedBookList(),o.go("tab.person_needBooksList")),n.clearHistory()}).fail(function(e){alert(e.message)}).always(function(){e.isLoading=!1,e.$apply()})},e.commonWords=u.commonUsedBookDesWords}]),angular.module("APP").run(["$templateCache",function(e){e.put("temp/tabs.html",'<ion-tabs ng-controller="tabs" class="tabs-icon-top"><ion-tab title="图书" icon-on="ion-ios-book balanced" icon-off="ion-ios-book-outline" ui-sref="tab.book_recommend"><ion-nav-view name="tab-book"></ion-nav-view></ion-tab><ion-tab title="个人" icon-on="ion-ios-person balanced" icon-off="ion-ios-person-outline" ui-sref="tab.person_my" badge="Status$.NewUsedBookStatus.unreadCount>0 || Status$.NewNeedBookStatus.unreadCount>0 || Status$.PrivateStatus.unreadCount>0 || Status$.ReviewUsedBookStatus.unreadCount>0 ? \'.\' : null" badge-style="badge-assertive"><ion-nav-view name="tab-person"></ion-nav-view></ion-tab></ion-tabs>'),e.put("temp/book/bookList.html",'<ion-view ng-controller="book_bookList" view-title="{{title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><ion-list><ion-item class="item-thumbnail-left" collection-repeat="book in books" ui-sref="tab.book_oneBook({isbn13:book.attributes.isbn13})"><img ng-src="{{book.attributes.image}}"><h2>{{book.attributes.title}}</h2><p ng-if="book.attributes.publisher">{{book.attributes.publisher}}/{{book.attributes.pubdate}}</p><p ng-if="book.attributes.author">{{book.attributes.author.toString()}}</p><p ng-if="book.attributes.price">{{book.attributes.price}}</p></ion-item></ion-list><ion-infinite-scroll ng-if="hasMore()" on-infinite="loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-view>'),e.put("temp/book/bookReview.html",'<ion-view ng-controller="book_bookReview" view-title="{{title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><ion-item collection-repeat="one in BookReview.reviewList" class="item-avatar"><img ng-src="{{one.avatarUrl}}"><h3>{{one.title}}</h3><p style="white-space: pre-wrap">{{one.context}}</p></ion-item><ion-item ng-if="BookReview.reviewList.length==0" style="text-align: center">还没有对应的书评</ion-item><ion-infinite-scroll ng-if="BookReview.hasMore()" on-infinite="BookReview.loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-view>'),e.put("temp/book/oneBook.html",'<ion-view ng-controller="book_oneBook" view-title="{{book.title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><div style="text-align: center;padding-top: 10px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><div class="list card"><ion-item style="text-align: center"><img ng-src="{{book.image}}" style="height: 180px" ng-click="WeChatJS$.previewOneImage(book.image)"></ion-item><ion-item ng-if="book.summary" class="item-button-right"><h3>简介</h3><p style="white-space: pre-wrap">{{book.summary.substr(0,30)}}...</p><button class="button button-clear button-balanced" ng-click="showSummary()">详情</button></ion-item><ion-item ng-if="book.author.length>0" class="item-button-right">{{book.author.toString()}} 著 <button class="button button-small button-clear button-balanced" ng-if="book.author_intro" ng-click="showAuthorIntro()">作者简介</button></ion-item><ion-item class="item-button-right"><i ng-if="book.price">定价:{{book.price}}</i> <i>&nbsp;</i> <i ng-if="book.publisher">{{book.publisher}}/{{book.pubdate}}</i> <button class="button button-small button-clear button-balanced" ng-click="showPubInfo()">出版</button></ion-item><ion-item ng-if="book.rating" class="item-button-right"><review-star num-stars="{{book.rating.average/2}}" score="{{book.rating.average}}" num-raters="{{book.rating.numRaters}}"></review-star><button class="button button-small button-clear button-balanced" ui-sref="tab.book_bookReview({doubanBookId:book.id,bookTitle:book.title})">书评</button></ion-item></div><div class="list card" ng-if="businessInfos.length>0"><ion-item class="item-divider">购买新书</ion-item><ion-item style="white-space:normal"><a class="button button-small button-outline button-balanced" style="margin: 5px" ng-repeat="info in businessInfos | orderBy:\'price\'" ng-href="{{info.url}}">{{info.name}}/{{info.price}}</a></ion-item></div><div class="list card"><ion-item class="item-divider item-button-right">要卖对应旧书的同学 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneUsedBook({isbn13:book.isbn13})">上传旧书</button></ion-item><ion-item ng-if="usedBookNumber==0" style="text-align: center">还没有对应的二手书</ion-item><ion-item ng-if="UsedBook$.ISBN_sell.nowEqualISBNUsedBooks.length>0" ng-repeat="usedBook in UsedBook$.ISBN_sell.nowEqualISBNUsedBooks" class="item-avatar"><img ng-src="{{usedBook.attributes.owner.avatarUrlWithSize(64)}}" ui-sref="tab.userHome({ownerId:usedBook.attributes.owner.id})"><div ui-sref="tab.book_oneUsedBook({usedBookAvosObjectId:usedBook.id})"><h3 style="white-space: pre-wrap">{{usedBook.attributes.price}}元 {{usedBook.attributes.des}}</h3><p>上传于:{{usedBook.updatedAt | date:\'mediumDate\' }}</p></div></ion-item><ion-item ng-if="UsedBook$.ISBN_sell.nowEqualISBNUsedBooks.length>0" style="padding: 0;text-align: center"><a class="button button-small button-clear button-balanced" ui-sref="tab.book_usedBookList({cmd:\'isbnUsed\',isbn13:isbn13})">共{{usedBookNumber}}本旧书,查看全部</a></ion-item></div><div class="list card"><ion-item class="item-divider item-button-right">正需要它的同学 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneNeedBook({isbn13:book.isbn13})">发布求书</button></ion-item><ion-item ng-if="needBookNumber==0" style="text-align: center">还没有同学想要它</ion-item><ion-item ng-if="UsedBook$.ISBN_need.nowEqualISBNNeedBooks.length>0" ng-repeat="usedBook in UsedBook$.ISBN_need.nowEqualISBNNeedBooks" class="item-avatar"><img ng-src="{{usedBook.attributes.owner.avatarUrlWithSize(64)}}" ui-sref="tab.userHome({ownerId:usedBook.attributes.owner.id})"><div ui-sref="tab.book_oneNeedBook({usedBookAvosObjectId:usedBook.id})"><p ng-if="usedBook.attributes.price">最高承受{{usedBook.attributes.price}}元</p><p ng-if="usedBook.attributes.des">{{usedBook.attributes.des}}</p><p>发布于:{{usedBook.updatedAt | date:\'mediumDate\' }}</p></div></ion-item><ion-item ng-if="UsedBook$.ISBN_need.nowEqualISBNNeedBooks.length>0" style="padding: 0;text-align: center"><a class="button button-small button-clear button-balanced" ui-sref="tab.book_usedBookList({cmd:\'isbnNeed\',isbn13:isbn13})">共{{needBookNumber}}位同学想要这本书,查看全部</a></ion-item></div></ion-content></ion-view>'),e.put("temp/book/oneNeedBook.html",'<ion-view ng-controller="book_oneUsedBook" view-title="求书 {{usedBook.attributes.title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><div class="list card"><ion-item ng-if="usedBook.attributes.image" style="text-align: center"><img ng-src="{{usedBook.attributes.image}}" style="height: 180px" ng-click="WeChatJS$.previewOneImage(usedBook.attributes.image)"></ion-item><ion-item ui-sref="tab.book_oneBook({isbn13:usedBook.attributes.isbn13})"><h3>书名:{{usedBook.attributes.title}}</h3><p>最高承受价:{{usedBook.attributes.price}}</p><p>发布时间:{{usedBook.updatedAt | date:\'mediumDate\' }}</p><p ng-if="usedBook.attributes.des" style="white-space: pre-wrap">附加描述:{{usedBook.attributes.des}}</p></ion-item></div><div class="list card"><ion-item class="item-divider item-button-right">求书同学信息 <a class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_sendMsgToUser({receiverObjectId:usedBook.attributes.owner.id,usedBookObjectId:usedBookObjectId,role:\'buy\',inboxType:\'private\'})">私信主人</a></ion-item><user-info user="usedBook.attributes.owner" used-book-object-id="usedBook.id"></user-info></div><div class="list card"><ion-item class="item-divider item-button-right">大家都说 <a class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_sendMsgToUser({receiverObjectId:usedBook.attributes.owner.id,usedBookObjectId:usedBookObjectId,role:\'buy\',inboxType:\'reviewUsedBook\'})">我也要说</a></ion-item><ion-item ng-if="statusList.length==0">还没有同学评论,快来抢沙发~</ion-item><ion-item class="item-avatar" ng-repeat="status in statusList"><img ng-src="{{status.attributes.source.avatarUrlWithSize(64)}}" ui-sref="tab.userHome({ownerId:status.attributes.source.id})"><h2 style="white-space: pre-wrap">{{status.attributes.message}}</h2><p>{{status.updatedAt | date:\'mediumDate\'}}</p><img style="width: 40px;height: 40px;position: absolute;top: 16px;right: 16px;border-radius: 50%" ui-sref="tab.userHome({ownerId:status.attributes.to.id})" ng-src="{{status.attributes.source.avatarUrlWithSize(64)}}"></ion-item></div></ion-content></ion-view>'),e.put("temp/book/oneUsedBook.html",'<ion-view ng-controller="book_oneUsedBook" view-title="二手 {{usedBook.attributes.title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><div class="list card"><ion-item ng-if="usedBook.attributes.image" style="text-align: center"><img ng-src="{{usedBook.attributes.image}}" style="height: 180px" ng-click="WeChatJS$.previewOneImage(usedBook.attributes.image)"></ion-item><ion-item ui-sref="tab.book_oneBook({isbn13:usedBook.attributes.isbn13})"><h3>书名:{{usedBook.attributes.title}}</h3><p>要价:{{usedBook.attributes.price}}</p><p>上传时间:{{usedBook.updatedAt | date:\'mediumDate\' }}</p><p ng-if="usedBook.attributes.des" style="white-space: pre-wrap">主人描述:{{usedBook.attributes.des}}</p></ion-item></div><div class="list card"><ion-item class="item-divider item-button-right">旧书主人信息 <a class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_sendMsgToUser({receiverObjectId:usedBook.attributes.owner.id,usedBookObjectId:usedBookObjectId,role:\'buy\',inboxType:\'private\'})">私信主人</a></ion-item><user-info user="usedBook.attributes.owner" used-book-object-id="usedBook.id"></user-info></div><div class="list card"><ion-item class="item-divider item-button-right">大家都说 <a class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_sendMsgToUser({receiverObjectId:usedBook.attributes.owner.id,usedBookObjectId:usedBookObjectId,role:\'buy\',inboxType:\'reviewUsedBook\'})">发表评论</a></ion-item><ion-item ng-if="statusList.length==0">还没有同学评论,快来抢沙发~</ion-item><ion-item class="item-avatar" ng-repeat="status in statusList"><img ng-src="{{status.attributes.source.avatarUrlWithSize(64)}}" ui-sref="tab.userHome({ownerId:status.attributes.source.id})"><h2 style="white-space: pre-wrap">{{status.attributes.message}}</h2><p>{{status.updatedAt | date:\'mediumDate\'}}</p><img style="width: 40px;height: 40px;position: absolute;top: 16px;right: 16px;border-radius: 50%" ui-sref="tab.userHome({ownerId:status.attributes.to.id})" ng-src="{{status.attributes.to.avatarUrlWithSize(64)}}"></ion-item></div></ion-content></ion-view>'),e.put("temp/book/recommend.html",'<ion-view ng-controller="book_recommend" view-title="{{major ? major : \'书循\'}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_searchList">寻书</button></ion-nav-buttons><ion-content><div ng-if="BookRecommend$[\'BookTag\'][\'tag\']"><ion-item class="item-divider item-button-right">图书分类 <button class="button button-small button-clear button-balanced" style="top: 0" ng-click="bookTagsModalView.show()">更多</button></ion-item><ion-item style="white-space:normal"><button class="button button-small button-outline button-balanced" style="margin: 5px" ui-sref="tab.book_bookList({cmd:\'tag\',tag:tag})" ng-repeat="tag in BookRecommend$[\'BookTag\'].getTagAttrNames()">{{tag}}</button></ion-item></div><div ng-if="LatestBook.books.length>0"><ion-item class="item-divider item-button-right">新书速递 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.book_bookList({cmd:\'latest\'})">更多</button></ion-item><douban-book-one-line books="LatestBook.books"></douban-book-one-line></div><div ng-if="BookRecommend$.NearUsedBook.usedBooks.length>0"><ion-item class="item-divider item-button-right">附近卖书 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.book_usedBookList({cmd:\'nearUsed\'})">更多</button></ion-item><used-book-one-line book-infos="BookRecommend$.NearUsedBook.usedBooks"></used-book-one-line></div><div ng-if="BookRecommend$.NearUser.users.length>0"><ion-item class="item-divider item-button-right">附近同学 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.userList({cmd:\'near\'})">更多</button></ion-item><ion-item style="padding: 0;text-align: center"><img ng-repeat="one in BookRecommend$.NearUser.users" ng-if="one.attributes.avatarUrl" ng-src="{{one.avatarUrlWithSize(64)}}" ui-sref="tab.userHome({ownerId:one.id})" style="width: 40px;height: 40px;border-radius: 50%;overflow: hidden;margin: 5px"></ion-item></div><div ng-if="BookRecommend$.NearNeedBook.needBooks.length>0"><ion-item class="item-divider item-button-right">附近求书 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.book_usedBookList({cmd:\'nearNeed\'})">更多</button></ion-item><used-book-one-line book-infos="BookRecommend$.NearNeedBook.needBooks"></used-book-one-line></div><div ng-if="BookRecommend$.TagBook.books.length>0"><ion-item class="item-divider item-button-right">{{major}}专业推荐读物 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.book_bookList({cmd:\'tag\',tag:major})">更多</button></ion-item><douban-book-one-line books="BookRecommend$.TagBook.books"></douban-book-one-line></div><ion-item class="item-icon-right" ng-click="chooseMajorModalView.show()">去其他专业看看<i class="icon ion-ios-arrow-right"></i></ion-item><ion-item class="item-icon-right" ng-if="major" ui-sref="tab.book_recommend({major:null})">看所有专业的书<i class="icon ion-ios-arrow-right"></i></ion-item></ion-content><script type="text/ng-template" id="template/bookTags.html"><ion-modal-view>\n            <ion-header-bar class="item-input-inset">\n                <h1 class="title">图书热门分类</h1>\n                <button class="button button-clear button-balanced"\n                        ng-click="bookTagsModalView.hide()">返回\n                </button>\n            </ion-header-bar>\n            <ion-content class="has-header">\n                <ion-list>\n                    <div ng-repeat="bigTag in BookRecommend$[\'BookTag\'].getTagAttrNames()">\n                        <ion-item class="item-divider item-button-right">{{bigTag}}</ion-item>\n                        <ion-item style="white-space:normal">\n                            <button class="button button-small button-outline button-balanced" style="margin: 5px"\n                                    ui-sref="tab.book_bookList({cmd:\'tag\',tag:tag})"\n                                    ng-click="bookTagsModalView.hide()"\n                                    ng-repeat="tag in BookRecommend$[\'BookTag\'][\'tag\'][bigTag]">\n                                {{tag}}\n                            </button>\n                        </ion-item>\n                    </div>\n                </ion-list>\n            </ion-content>\n        </ion-modal-view></script></ion-view>'),e.put("temp/book/searchList.html",'<ion-view view-title="图书搜索"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content ng-controller="book_searchList"><ion-list><ion-item class="item-input-inset"><button class="button button-small button-clear" ng-click="scanQRBtnOnClick()">扫码</button><label class="item-input-wrapper"><i class="icon ion-search placeholder-icon"></i> <input type="search" placeholder="书名 作者 ISBN" ng-model="SearchBook$.keyword" ng-change="SearchBook$.searchInputOnChange()"></label><button class="button button-small button-clear" ng-click="SearchBook$.searchBtnOnClick()">搜索</button></ion-item><ion-item class="item-thumbnail-left" collection-repeat="bookInfo in SearchBook$.books" ui-sref="tab.book_oneBook({isbn13:bookInfo.attributes.isbn13})"><img ng-src="{{bookInfo.attributes.image}}"><h2>{{bookInfo.attributes.title}}</h2><p ng-if="bookInfo.attributes.publisher">{{bookInfo.attributes.publisher}}/{{bookInfo.attributes.pubdate}}</p><p ng-if="bookInfo.attributes.author">{{bookInfo.attributes.author.toString()}}</p><p ng-if="bookInfo.attributes.price">{{bookInfo.attributes.price}}</p></ion-item></ion-list><ion-infinite-scroll ng-if="SearchBook$.hasMore()" on-infinite="SearchBook$.loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-view>'),e.put("temp/book/usedBookList.html",'<ion-view ng-controller="book_usedBookList" view-title="{{title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content><div class="button-bar padding"><a class="button button-small" ng-click="sortWay=\'attributes.price\'" ng-class="{\'button-balanced\':sortWay==\'attributes.price\'}">图书价格</a> <a class="button button-small" ng-click="sortWay=\'attributes.location\'" ng-class="{\'button-balanced\':sortWay==\'attributes.location\'}">离你距离</a> <a class="button button-small" ng-if="setMajorFilter" ng-class="{\'button-balanced\':getMajorFilter()}" ng-click="chooseMajorModalView.show()">{{getMajorFilter() ? getMajorFilter() :\'主人专业\'}}</a> <a class="button button-small button-energized" ng-click="setMajorFilter()" ng-if="getMajorFilter()">取消限制</a></div><ion-list><one-used-book ng-if="cmd==\'nearUsed\' || cmd ==\'isbnUsed\'" ng-repeat="usedBook in usedBooks | orderBy:sortWay" used-book="usedBook"></one-used-book><one-need-book ng-if="cmd==\'nearNeed\' || cmd == \'isbnNeed\'" ng-repeat="needBook in usedBooks | orderBy:sortWay" need-book="needBook"></one-need-book></ion-list><ion-infinite-scroll ng-if="hasMore()" on-infinite="loadMore(isbn13)" distance="1%"></ion-infinite-scroll></ion-content></ion-view>'),e.put("temp/person/editOneUsedBook.html",'<ion-view ng-controller="person_editOneUsedBook" view-title="编辑你的{{usedBook.attributes.title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content class="padding"><div class="list card"><ion-item style="text-align: center"><img ng-src="{{usedBook.attributes.image}}" style="height: 180px"></ion-item></div><div class="list card"><label class="item item-input item-stacked-label"><span class="input-label">价格</span> <input type="number" placeholder="人民币 只输入数值" ng-model="usedBook.attributes.price" ng-change="valueHasChange=true"></label><label class="item item-input item-stacked-label"><span class="input-label">描述</span> <input type="text" placeholder="这书有什么特别之处" ng-model="usedBook.attributes.des" ng-change="valueHasChange=true"></label></div><button class="button button-block button-outline button-balanced" ng-click="submitOnClick()" ng-disabled="!valueHasChange">提交修改</button></ion-content></ion-view>'),e.put("temp/person/editPersonInfo.html",'<ion-view ng-controller="person_editPersonInfo" view-title="修改你的信息"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content class="padding"><user-info user="me"></user-info><div class="list list-inset"><ion-item class="item-icon-right" ng-click="chooseSchoolModalView.show()">在读学校 <span class="item-note" ng-if="userInfo.school">{{userInfo.school}}</span> <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item class="item-icon-right" ng-click="chooseMajorModalView.show()">所学专业 <span class="item-note" ng-if="userInfo.major">{{userInfo.major}}</span> <i class="icon ion-ios-arrow-right balanced"></i></ion-item><label class="item item-input item-select"><span class="input-label">大学入学时间</span><select ng-model="userInfo.startSchoolYear" ng-change="attrHasChange=true" ng-options="one as one for one in startSchoolYearOptions"></select></label><ion-toggle ng-model="userInfo.wechatAlert" ng-change="attrHasChange=true;confirmWechatAlert()">消息提醒</ion-toggle></div><button class="button button-block button-outline button-balanced" ng-click="submitOnClick()" ng-disabled="!attrHasChange">提交修改</button></ion-content></ion-view>'),e.put("temp/person/my.html",'<ion-view ng-controller="person_my" view-title="我的书循"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ng-click="logOut()">退出</button></ion-nav-buttons><ion-content><ion-item ng-if="Status$.NewUsedBookStatus.unreadCount>0" ui-sref="tab.person_statusList({cmd:\'newUsedBook\'})">你关注的同学新上传了旧书<span class="badge badge-assertive">{{Status$.NewUsedBookStatus.unreadCount}}</span></ion-item><ion-item ng-if="Status$.NewNeedBookStatus.unreadCount>0" ui-sref="tab.person_statusList({cmd:\'newNeedBook\'})">你关注的同学新发布了求书<span class="badge badge-assertive">{{Status$.NewNeedBookStatus.unreadCount}}</span></ion-item><ion-item ng-if="Status$.PrivateStatus.unreadCount>0" ui-sref="tab.person_statusList({cmd:\'private\'})">有同学给你发私信<span class="badge badge-assertive">{{Status$.PrivateStatus.unreadCount}}</span></ion-item><ion-item ng-if="Status$.ReviewUsedBookStatus.unreadCount>0" ui-sref="tab.person_statusList({cmd:\'reviewUsedBook\'})">有同学评价你的书<span class="badge badge-assertive">{{Status$.ReviewUsedBookStatus.unreadCount}}</span></ion-item><ion-item class="item-divider item-button-right">我的信息 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_editPersonInfo">修改信息</button></ion-item><user-info ng-if="user" user="user" hide-used-book="true"></user-info><ion-item class="item-divider item-button-right">我发布的求书 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneNeedBook">发布求书</button></ion-item><ion-item ng-if="myNeedBookNumber>0" ui-sref="tab.person_needBooksList" class="item-icon-right">已发布{{myNeedBookNumber}}个求书 <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item class="item-divider item-button-right">我上传的旧书 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneUsedBook">上传旧书</button></ion-item><ion-item ng-if="myUsedBookNumber>0" ui-sref="tab.person_usedBooksList" class="item-icon-right">已上传{{myUsedBookNumber}}本旧书 <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item class="item-divider item-button-right">我关注的同学 <button class="button button-small button-clear button-balanced" style="top: 0" ui-sref="tab.userList({cmd:\'near\'})">附近同学</button></ion-item><ion-item ng-if="followeeNumber>0" ui-sref="tab.userList({cmd:\'followee\'})" class="item-icon-right">已关注{{followeeNumber}}位同学 <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item ng-if="followeeNumber==0" ui-sref="tab.userList({cmd:\'near\'})">你还没有关注的同学,去逛逛</ion-item><ion-item class="item-divider">我的粉丝</ion-item><ion-item ng-if="followerNumber>0" ui-sref="tab.userList({cmd:\'follower\'})" class="item-icon-right">有{{followerNumber}}位同学关注我 <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item ng-if="followerNumber==0" ui-sref="tab.userList({cmd:\'follower\'})" class="item-icon-right">还没有粉丝,去发点什么吧</ion-item></ion-content></ion-view>'),e.put("temp/person/needBookList.html",'<ion-view ng-controller="person_needBookList" view-title="管理我发布的求书"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content><ion-list><div style="text-align: center;margin: 10px" ng-if="UsedBook$.isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><ion-item class="item-divider item-button-right">正在求书 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneNeedBook">发布求书</button></ion-item><ion-item collection-repeat="needBook in UsedBook$.myNeedBookList" class="item-thumbnail-left"><img ng-if="needBook.attributes.image" ng-src="{{needBook.attributes.image}}" ui-sref="tab.book_oneBook({isbn13:needBook.attributes.isbn13})"><p ng-if="needBook.attributes.price">最高承受价格:{{needBook.attributes.price}}</p><p ng-if="needBook.attributes.title">书名:{{needBook.attributes.title}}</p><p ng-if="needBook.attributes.des">描述:{{needBook.attributes.des}}</p><button class="button button-small button-outline button-assertive" ng-click="UsedBook$.removeUsedBook(needBook)">已买删除</button> <button class="button button-small button-outline button-balanced" ui-sref="tab.person_editOneUsedBook({usedBookId:needBook.id})">修改信息</button></ion-item><ion-item ng-if="UsedBook$.myNeedBookList.length==0">你还没有发布过,点击发布求书</ion-item></ion-list></ion-content></ion-view>'),e.put("temp/person/sendMsgToUser.html",'<ion-view ng-controller="person_sendMsgToUser" view-title="回复{{user.attributes.nickName}}"><style>.message {\n            display: block;\n            clear: both;\n            border-radius: 10px;\n            padding: 5px;\n            margin: 5px;\n            max-width: 80%;\n            white-space: normal;\n        }</style><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content><user-info ng-if="user" user="user"></user-info><one-used-book ng-if="usedBook" used-book="usedBook"></one-used-book><ion-item style="margin: 0;padding: 0;border-right: none;border-left: none"><ol ng-if="statusList.length>0" style="margin: 5px;padding: 0;list-style-type:none"><li ng-repeat="status in statusList" class="message" ng-style="{float:status.attributes.source.id==user.id ? \'left\':\'right\',backgroundColor:status.attributes.source.id==user.id ? \'#30bf4c\':\'#e6e5eb\'}">{{status.attributes.message}}</li></ol></ion-item><ion-item class="item-divider" style="text-align: center" ng-if="nowModel()">{{nowModel()}}</ion-item><label class="item item-input"><input type="text" ng-model="msg.sendMsg" placeholder="输入回复内容"></label><button ng-disabled="!msg.sendMsg || isLoading" class="button button-block button-outline button-balanced" ng-click="sendOnClick()">发送</button><div style="text-align: center;padding-top: 10px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><ion-list ng-if="commonReplayWords.length>0"><ion-item class="item-divider item-button-right">快速回复内容</ion-item><ion-item style="white-space:normal;padding: 5px"><button class="button button-small button-outline button-balanced" style="margin: 5px" ng-disabled="isLoading" ng-repeat="word in commonReplayWords" ng-click="msg.sendMsg=word">{{word}}</button></ion-item></ion-list></ion-content></ion-view>'),
e.put("temp/person/statusList.html",'<ion-view ng-controller="person_statusList" view-title="{{title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content class="padding"><div class="card" ng-if="cmd==\'newUsedBook\'" ng-repeat="status in statusList"><one-used-book used-book="status.attributes.usedBook"></one-used-book><user-info user="status.attributes.source"></user-info></div><div class="card" ng-if="cmd==\'newNeedBook\'" ng-repeat="status in statusList"><one-need-book need-book="status.attributes.usedBook"></one-need-book><user-info user="status.attributes.source"></user-info></div><div class="card" ng-if="cmd==\'private\'" ng-repeat="status in statusList"><ion-item><p style="white-space: pre-wrap">{{status.attributes.message}}</p><button style="float:right" class="button button-clear button-balanced button-small" ui-sref="tab.person_sendMsgToUser({receiverObjectId:status.attributes.source.id,role:status.attributes.role==\'buy\' ? \'sell\' : \'buy\',inboxType:\'private\',usedBookObjectId:status.attributes.usedBook.id})">回复私信</button></ion-item><one-used-book ng-if="status.attributes.usedBook && status.attributes.usedBook.attributes.role==\'sell\'" used-book="status.attributes.usedBook"></one-used-book><one-need-book ng-if="status.attributes.usedBook && status.attributes.usedBook.attributes.role==\'need\'" need-book="status.attributes.usedBook"></one-need-book><user-info user="status.attributes.source"></user-info></div><div class="card" ng-if="cmd==\'reviewUsedBook\'" collection-repeat="status in statusList"><ion-item><p style="white-space: pre-wrap">{{status.attributes.message}}</p><button style="float:right" class="button button-clear button-balanced button-small" ui-sref="tab.person_sendMsgToUser({receiverObjectId:status.attributes.source.id,role:status.attributes.role==\'buy\' ? \'sell\' : \'buy\',inboxType:\'reviewUsedBook\',usedBookObjectId:status.attributes.usedBook.id})">回复评论</button></ion-item><one-used-book ng-if="status.attributes.usedBook && status.attributes.usedBook.attributes.role==\'sell\'" used-book="status.attributes.usedBook"></one-used-book><one-need-book ng-if="status.attributes.usedBook && status.attributes.usedBook.attributes.role==\'need\'" need-book="status.attributes.usedBook"></one-need-book><user-info user="status.attributes.source"></user-info></div><div class="card" ng-if="statusList.length==0"><ion-item style="text-align: center">没有未读消息</ion-item></div></ion-content></ion-view>'),e.put("temp/person/uploadOneNeedBook.html",'<ion-view ng-controller="person_uploadOneUsedBook" view-title="发布求书"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content style="text-align: center" class="padding"><div style="text-align: center;padding-top: 10px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><div ng-if="!usedBookInfo.isbn13"><h5>获得你需要的图书信息</h5><button class="button button-outline button-balanced" ng-click="noBarCodeModalView.show()">开始获取</button><br><button class="button button-clear button-small button-balanced" ng-click="scanQRBtnOnClick()">扫码获得</button></div><div class="list card" ng-if="usedBookInfo.isbn13"><ion-item style="text-align: center"><img ng-src="{{doubanBookInfo.image}}" style="height: 180px" ng-click="WeChatJS$.previewOneImage(doubanBookInfo.image)"></ion-item><ion-item><p>{{doubanBookInfo.title}} <span ng-if="doubanBookInfo.price">{{doubanBookInfo.price}}</span></p><p ng-if="doubanBookInfo[\'author\'].length>0">{{doubanBookInfo[\'author\'].toString()}} 著</p><p ng-if="doubanBookInfo[\'publisher\']">{{doubanBookInfo[\'publisher\']}} {{doubanBookInfo[\'pubdate\']}}</p></ion-item></div><hr style="margin: 10px"><div class="list list-inset"><label class="item item-input"><input type="number" ng-model="usedBookInfo.price" placeholder="输入你最高承受价(数字,人民币元)"></label><label class="item item-input"><input type="text" ng-model="usedBookInfo.des" placeholder="对这本书你还有什么想说的吗?"></label></div><button ng-disabled="!(!isLoading && usedBookInfo.isbn13)" class="button button-block button-outline button-balanced" ng-click="submitOnClick(\'need\')">发布求书</button><ion-list ng-if="commonWords.length>0"><ion-item class="item-divider item-button-right">常用描述内容</ion-item><ion-item style="white-space:normal;padding: 5px"><button class="button button-small button-outline button-balanced" style="margin: 5px" ng-disabled="isLoading" ng-repeat="word in commonWords" ng-click="usedBookInfo.des=usedBookInfo.des+\' \'+word">{{word}}</button></ion-item></ion-list></ion-content><script type="text/ng-template" id="template/helpModalView.html"><ion-modal-view>\n            <ion-header-bar>\n                <h2 class="title">发布求书方法</h2>\n                <button class="button button-clear button-balanced"\n                        ng-click="noBarCodeModalView.hide()">返回\n                </button>\n            </ion-header-bar>\n            <ion-content class="padding" style="text-align: center">\n                <button class="button button-block button-outline button-balanced" ui-sref="tab.book_searchList"\n                        ng-click="noBarCodeModalView.hide()">\n                    开始获取\n                </button>\n                <img style="max-width: 98%" ng-src="../img/uploadHelp.png">\n            </ion-content>\n        </ion-modal-view></script></ion-view>'),e.put("temp/person/uploadOneUsedBook.html",'<ion-view ng-controller="person_uploadOneUsedBook" view-title="上传二手书"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content style="text-align: center" class="padding"><div style="text-align: center;padding-top: 10px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><div ng-if="!usedBookInfo.isbn13"><h5>扫码书后面的条形码获得图书信息</h5><button class="button button-outline button-balanced" ng-click="scanQRBtnOnClick()">扫条形码</button><br><button class="button button-clear button-small button-balanced" ng-click="noBarCodeModalView.show()">没条码?</button></div><div class="list card" ng-if="usedBookInfo.isbn13"><ion-item style="text-align: center"><img ng-src="{{doubanBookInfo.image}}" style="height: 180px" ng-click="WeChatJS$.previewOneImage(doubanBookInfo.image)"></ion-item><ion-item><p>{{doubanBookInfo.title}} <span ng-if="doubanBookInfo.price">{{doubanBookInfo.price}}</span></p><p ng-if="doubanBookInfo[\'author\'].length>0">{{doubanBookInfo[\'author\'].toString()}} 著</p><p ng-if="doubanBookInfo[\'publisher\']">{{doubanBookInfo[\'publisher\']}} {{doubanBookInfo[\'pubdate\']}}</p></ion-item></div><hr style="margin: 10px"><div class="list list-inset"><label class="item item-input"><input type="number" ng-model="usedBookInfo.price" placeholder="输入要价(数字,人民币元)"></label><label class="item item-input"><input type="text" ng-model="usedBookInfo.des" placeholder="对这本书你还有什么想说的吗?"></label></div><button ng-disabled="!(!isLoading && usedBookInfo.isbn13 && usedBookInfo.price)" class="button button-block button-outline button-balanced" ng-click="submitOnClick(\'sell\')">提交二手书</button><ion-list ng-if="commonWords.length>0"><ion-item class="item-divider item-button-right">常用描述内容</ion-item><ion-item style="white-space:normal;padding: 5px"><button class="button button-small button-outline button-balanced" style="margin: 5px" ng-disabled="isLoading" ng-repeat="word in commonWords" ng-click="usedBookInfo.des=usedBookInfo.des+\' \'+word">{{word}}</button></ion-item></ion-list></ion-content><script type="text/ng-template" id="template/helpModalView.html"><ion-modal-view>\n            <ion-header-bar>\n                <h2 class="title">书没条码时上传方法</h2>\n                <button class="button button-clear button-balanced"\n                        ng-click="noBarCodeModalView.hide()">返回\n                </button>\n            </ion-header-bar>\n            <ion-content class="padding" style="text-align: center">\n                <button class="button button-block button-outline button-balanced" ui-sref="tab.book_searchList"\n                        ng-click="noBarCodeModalView.hide()">\n                    开始上传\n                </button>\n                <img style="max-width: 98%" ng-src="../img/uploadHelp.png">\n            </ion-content>\n        </ion-modal-view></script></ion-view>'),e.put("temp/person/usedBookList.html",'<ion-view ng-controller="person_usedBookList" view-title="管理我上传的旧书"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.person_my">我</button></ion-nav-buttons><ion-content><div style="text-align: center;margin: 10px" ng-if="UsedBook$.isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><ion-list><ion-item class="item-divider item-button-right">正在架上 <button class="button button-clear button-balanced" style="top: 0" ui-sref="tab.person_uploadOneUsedBook">上传旧书</button></ion-item><ion-item collection-repeat="usedBook in UsedBook$.myUsedBookList" class="item-thumbnail-left"><img ng-if="usedBook.attributes.image" ng-src="{{usedBook.attributes.image}}" ui-sref="tab.book_oneBook({isbn13:usedBook.attributes.isbn13})"><p ng-if="usedBook.attributes.price">要价:{{usedBook.attributes.price}}</p><p ng-if="usedBook.attributes.title">书名:{{usedBook.attributes.title}}</p><p ng-if="usedBook.attributes.des">描述:{{usedBook.attributes.des}}</p><button class="button button-small button-outline button-assertive" ng-click="UsedBook$.removeUsedBook(usedBook)">已卖删除</button> <button class="button button-small button-outline button-balanced" ui-sref="tab.person_editOneUsedBook({usedBookId:usedBook.id})">修改信息</button></ion-item><ion-item ng-if="UsedBook$.myUsedBookList.length==0">你还没有上传过书,点击 上传旧书</ion-item></ion-list></ion-content></ion-view>'),e.put("temp/tool/chooseMajorModalView.html",'<ion-modal-view><ion-header-bar class="item-input-inset"><label class="item-input-wrapper"><i class="icon ion-ios-search placeholder-icon balanced"></i> <input type="search" placeholder="输入专业名称搜索" ng-model="InfoService$.searchMajorKeyword"></label><button class="button button-clear button-balanced" ng-click="chooseMajorModalView.hide()">返回</button></ion-header-bar><ion-content class="has-header"><ul class="list"><ion-item item-height="55px" item-width="100%" collection-repeat="oneMajor in InfoService$.majors | filter:InfoService$.filter_majorByKeyword" ng-click="majorOnChoose(oneMajor.name)">{{oneMajor.name}}</ion-item></ul></ion-content></ion-modal-view>'),e.put("temp/tool/chooseSchoolModalView.html",'<ion-modal-view><ion-header-bar class="item-input-inset"><button class="button button-clear button-balanced" ng-click="InfoService$.School.loadMore()">搜索</button><label class="item-input-wrapper"><i class="icon ion-ios-search placeholder-icon balanced"></i> <input type="search" placeholder="输入名称搜索" ng-model="InfoService$.School.searchSchoolKeyword"></label><button class="button button-clear button-balanced" ng-click="chooseSchoolModalView.hide()">返回</button></ion-header-bar><ion-content class="has-header"><ul class="list"><ion-item item-height="55px" item-width="100%" collection-repeat="school in InfoService$.School.schools | filter:InfoService$.School.filter_schoolByKeyword" ng-click="schoolOnChoose(school)">{{school}}</ion-item></ul><ion-infinite-scroll on-infinite="InfoService$.School.loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-modal-view>'),e.put("temp/tool/doubanBookOneLineTemplate.html",'<ion-item style="text-align: center;padding: 0"><div ng-repeat="book in books.slice(0,showNumber)" ui-sref="tab.book_oneBook({isbn13:book.attributes.isbn13})" style="display: inline-block;padding: 5px;width: 80px;height: 120px"><img ng-if="book.attributes.image" ng-src="{{book.attributes.image}}" style="width: 70px;height: 100px"><h5 ng-if="book.attributes.title" class="title">{{book.attributes.title}}</h5></div></ion-item>'),e.put("temp/tool/hello.html",'<ion-view ng-controller="hello" view-title="需要验证你的身份"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content style="text-align: center"><hr style="margin: 30px"><a class="button button-outline button-balanced" ng-href="{{OAuthURL}}">进入书循</a></ion-content></ion-view>'),e.put("temp/tool/oneNeedBookTemplate.html",'<ion-item class="item-thumbnail-left" ui-sref="tab.book_oneNeedBook({usedBookAvosObjectId:needBook.id})"><img ng-if="needBook.attributes.image" ng-src="{{needBook.attributes.image}}"><h3 ng-if="needBook.attributes.price">最高承受价:{{needBook.attributes.price}}</h3><p>时间:{{needBook.updatedAt | date:\'mediumDate\' }}</p><p ng-if="needBook.attributes.title">书名:{{needBook.attributes.title}}</p><p ng-if="needBook.attributes.des">描述:{{needBook.attributes.des}}</p></ion-item>'),e.put("temp/tool/oneUsedBookTemplate.html",'<ion-item class="item-thumbnail-left" ui-sref="tab.book_oneUsedBook({usedBookAvosObjectId:usedBook.id})"><img ng-if="usedBook.attributes.image" ng-src="{{usedBook.attributes.image}}"><h3>要价:{{usedBook.attributes.price}}</h3><p>时间:{{usedBook.updatedAt | date:\'mediumDate\' }}</p><p ng-if="usedBook.attributes.title">书名:{{usedBook.attributes.title}}</p><p ng-if="usedBook.attributes.des">描述:{{usedBook.attributes.des}}</p></ion-item>'),e.put("temp/tool/signUp.html",'<ion-view ng-controller="signUp" view-title="加入书循"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content class="padding"><div style="text-align: center;margin: 5px" ng-if="isLoading"><ion-spinner icon="ripple" class="spinner-balanced"></ion-spinner></div><div class="item item-avatar" ng-if="userInfo.openId"><img ng-src="{{userInfo.avatarUrl}}"><h2>{{userInfo.nickName}} <i class="icon ion-male" style="color: #5eb1ed" ng-if="userInfo.sex==1"></i> <i class="icon ion-female" style="color: #ff6d9e" ng-if="userInfo.sex==2"></i></h2></div><div class="list list-inset"><ion-item class="item-icon-right" ng-click="chooseSchoolModalView.show()">你在读的学校 <span class="item-note" ng-if="userInfo.school">{{userInfo.school}}</span> <i class="icon ion-ios-arrow-right balanced"></i></ion-item><ion-item class="item-icon-right" ng-click="chooseMajorModalView.show()">你所学的专业 <span class="item-note" ng-if="userInfo.major">{{userInfo.major}}</span> <i class="icon ion-ios-arrow-right balanced"></i></ion-item><label class="item item-input item-select"><span class="input-label">大学入学时间</span><select ng-model="userInfo.startSchoolYear"><option ng-repeat="one in startSchoolYearOptions" value="{{one}}">{{one}}</option></select></label></div><button class="button button-block button-outline button-balanced" ng-click="submitOnClick()" ng-disabled="isLoading || !(userInfo.school && userInfo.major && userInfo.startSchoolYear)">立即加入</button></ion-content></ion-view>'),e.put("temp/tool/titleAndPreModalView.html",'<ion-modal-view><ion-header-bar><h2 class="title">{{titleAndPreModalViewData.title}}</h2><button class="button button-clear button-balanced" ng-click="titleAndPreModalView.hide()">返回</button></ion-header-bar><ion-content class="padding"><pre>{{titleAndPreModalViewData.pre}}</pre></ion-content></ion-modal-view>'),e.put("temp/tool/usedBookOneLineTemplate.html",'<ion-item style="text-align: center;padding: 0"><div ng-repeat="bookInfo in bookInfos.slice(0,showNumber)" ui-sref="tab.book_oneBook({isbn13:bookInfo.attributes.isbn13})" style="display: inline-block;padding: 5px;width: 80px;height: 134px"><h5 class="title">{{bookInfo.attributes.des}}</h5><img ng-if="bookInfo.attributes.image" ng-src="{{bookInfo.attributes.image}}" style="width: 70px;height: 100px"><h5 class="title">{{bookInfo.attributes.title}}</h5></div></ion-item>'),e.put("temp/tool/userHome.html",'<ion-view ng-controller="userHome" view-title="主人的二手书"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content><ion-list><user-info user="owner" hide-used-book="true"></user-info><ion-item class="item-divider item-button-right">主人上传的二手书列表</ion-item><one-used-book ng-if="usedBooks.length>0" ng-repeat="usedBook in usedBooks" used-book="usedBook"></one-used-book><ion-item ng-if="usedBooks.length==0" ui-sref="tab.book_recommend">主人还没旧书要卖,再去逛逛</ion-item><ion-item class="item-divider item-button-right">主人发布的求书列表</ion-item><one-need-book ng-if="needBooks.length>0" ng-repeat="needBook in needBooks" need-book="needBook"></one-need-book><ion-item ng-if="needBooks.length==0" ui-sref="tab.book_recommend">主人还没发布过求书,再去逛逛</ion-item></ion-list></ion-content></ion-view>'),e.put("temp/tool/userInfoTemplate.html",'<div class="item item-avatar" ng-if="user"><img ng-src="{{user.avatarUrlWithSize(64)}}"><h2>{{user.attributes.nickName}} <i class="icon ion-male" style="color: #5eb1ed" ng-if="user.attributes.sex==1"></i> <i class="icon ion-female" style="color: #ff6d9e" ng-if="user.attributes.sex==2"></i> <i>{{user.attributes.startSchoolYear}}级</i></h2><p style="white-space: pre-wrap">{{user.attributes.major}}/{{user.attributes.school}}</p><button ng-if="AV.User.current() && !isMe()" class="button button-small button-clear button-balanced" style="float: right" ui-sref="tab.person_sendMsgToUser({receiverObjectId:user.id,role:\'buy\',inboxType:\'private\',usedBookObjectId:usedBookObjectId})">发私信</button> <button ng-if="user.attributes.location" class="button button-small button-clear button-balanced" style="float: right" ng-click="WeChatJS$.openMap(user.attributes.location.latitude,user.attributes.location.longitude)">地图</button> <button ng-if="AV.User.current() && !isMyFollowee && !isMe()" class="button button-small button-clear button-balanced" style="float: right" ng-click="User$.followUser(user.id)">关注Ta</button> <button ng-if="isMyFollowee" class="button button-small button-clear button-energized" style="float: right" ng-click="User$.unfollowUser(user.id)">取消关注</button></div><ion-item class="item-divider" ng-if="!hideUsedBook" style="padding: 0;text-align: center"><a class="button button-small button-clear button-balanced" ui-sref="tab.userHome({ownerId:user.id})">主人有{{user.userUsedBookNumber}}本旧书要卖,发布了{{user.userNeedBookNumber}}个求书</a></ion-item>'),e.put("temp/tool/userList.html",'<ion-view ng-controller="userList" view-title="{{title}}"><ion-nav-buttons side="right"><button class="button button-clear button-balanced" ui-sref="tab.book_recommend">书循</button></ion-nav-buttons><ion-content class="padding"><div class="button-bar"><a class="button button-small" ng-click="sortWay=\'userUsedBookNumber\'" ng-class="{\'button-balanced\':sortWay==\'userUsedBookNumber\'}">数量</a> <a class="button button-small" ng-click="sortWay=\'location\'" ng-class="{\'button-balanced\':sortWay==\'location\'}">距离</a> <a class="button button-small" ng-class="{\'button-balanced\':getMajorFilter()}" ng-click="chooseMajorModalView.show()">{{getMajorFilter() ? getMajorFilter() :\'专业\'}}</a> <a class="button button-small button-energized" ng-click="setMajorFilter()" ng-if="getMajorFilter()">取消专业限制</a></div><div class="card" collection-repeat="one in users | orderBy:sortWay:true"><user-info user="one"></user-info></div><ion-infinite-scroll ng-if="hasMore()" on-infinite="loadMore()" distance="1%"></ion-infinite-scroll></ion-content></ion-view>')}]),APP.controller("person_usedBookList",["$scope","$ionicScrollDelegate","UsedBook$",function(e,o,t){e.UsedBook$=t,t.loadMyUsedBookList(),e.$on("$ionicView.afterEnter",function(){o.scrollTop(!0)})}]),APP.controller("signUp",["$scope","$timeout","$state","$stateParams","$ionicHistory","$ionicModal","InfoService$","User$","Status$","IonicModalView$",function(e,o,t,n,i,s,a,r,l,u){e.isLoading=!0;var d=n.code,c="tab.person_my";r.getOAuthUserInfo(d).done(function(o){e.isLoading=!1,e.userInfo=o,r.loginWithUnionId(o.unionId).done(function(){l.loadUnreadStatusesCount(),t.go(c),i.clearHistory(),r.updateMyInfoWithJson(o)}),e.$apply()}).fail(function(){alert("要先关注书循微信号哦"),window.location.href="http://mp.weixin.qq.com/s?__biz=MzAwMDQwMjMxNg==&mid=205566574&idx=1&sn=5784b3b5f4d870ca4715c2dd56d8f01e#rd"}),u.registerChooseSchoolModalView(e,function(o){e.userInfo.school=o}),u.registerChooseMajorModalView(e,function(o){e.userInfo.major=o}),e.startSchoolYearOptions=a.startSchoolYearOptions,e.submitOnClick=function(){e.isLoading=!0,r.signUpWithJSONUser(e.userInfo).done(function(){t.go(c),i.clearHistory()}).fail(function(e){alert(e.message)}).always(function(){e.isLoading=!1,e.$apply()})}}]),APP.controller("tabs",["$scope","Status$",function(e,o){e.Status$=o}]),APP.controller("userHome",["$scope","$stateParams","UsedBook$",function(e,o,t){e.UsedBook$=t;var n=o.ownerId,i=new AV.Query(Model.User);i.get(n).done(function(o){e.owner=o,t.loadUsedBookListForOwner(o).done(function(o){e.usedBooks=o,e.$apply()}),t.loadNeedBookListForOwner(o).done(function(o){e.needBooks=o,e.$apply()})})}]),APP.controller("userList",["$scope","$stateParams","UsedBook$","BookRecommend$","User$","IonicModalView$",function(e,o,t,n,i,s){var a=o.cmd;e.sortWay="","near"==a?(e.title="你附近的同学",e.users=n.NearUser.users,e.loadMore=n.NearUser.loadMore,e.hasMore=n.NearUser.hasMore,e.setMajorFilter=n.NearUser.setMajorFilter,e.getMajorFilter=n.NearUser.getMajorFilter):"followee"==a?(e.title="我关注的同学",e.users=i.Followee.users,e.loadMore=i.Followee.loadMore,e.hasMore=i.Followee.hasMore,e.setMajorFilter=i.Followee.setMajorFilter,e.getMajorFilter=i.Followee.getMajorFilter):"follower"==a&&(e.title="我的粉丝",e.users=i.Follower.users,e.loadMore=i.Follower.loadMore,e.hasMore=i.Follower.hasMore,e.setMajorFilter=i.Follower.setMajorFilter,e.getMajorFilter=i.Follower.getMajorFilter),s.registerChooseMajorModalView(e,function(o){e.setMajorFilter(o)});var r=o.majorFilter;r&&e.setMajorFilter(r)}]),APP.directive("doubanBookOneLine",function(){return{restrict:"E",scope:{books:"="},templateUrl:"temp/tool/doubanBookOneLineTemplate.html",link:function(e){e.showNumber=Math.floor(document.body.clientWidth/80)}}}),APP.directive("oneNeedBook",function(){return{restrict:"E",scope:{needBook:"="},templateUrl:"temp/tool/oneNeedBookTemplate.html"}}),APP.directive("oneUsedBook",function(){return{restrict:"E",scope:{usedBook:"="},templateUrl:"temp/tool/oneUsedBookTemplate.html"}}),APP.directive("reviewStar",function(){function e(e,o){var t=e.numStars,n=e.score,i=e.numRaters,s='<i class="icon ion-ios-star energized"></i>',a='<i class="icon ion-ios-star-outline"></i>';o.append("<i>"+n+"分&nbsp</i>"),o.append("<i>"+i+"人参与&nbsp</i>");for(var r=1;5>=r;r++){var l;l=t>=r?angular.element(s).clone():angular.element(a).clone(),o.append(l)}}return{restrict:"E",scope:{numStars:"@",score:"@",numRaters:"@"},link:e}}),APP.directive("usedBookOneLine",function(){return{restrict:"E",scope:{bookInfos:"="},templateUrl:"temp/tool/usedBookOneLineTemplate.html",link:function(e){e.showNumber=Math.floor(document.body.clientWidth/80)}}}),APP.directive("userInfo",["WeChatJS$","User$",function(e,o){function t(t){function n(){if(t.user){t.user.userUsedBookNumber=0;var e=AV.Object.createWithoutData("_User",t.user.id),o=e.relation("usedBooks").query();o.equalTo("role","sell"),o.count().done(function(e){t.user.userUsedBookNumber=e,t.$apply()})}}function i(){if(t.user){t.user.userNeedBookNumber=0;var e=AV.Object.createWithoutData("_User",t.user.id),o=e.relation("usedBooks").query();o.equalTo("role","need"),o.count().done(function(e){t.user.userNeedBookNumber=e,t.$apply()})}}function s(){if(t.user&&AV.User.current()){var e=AV.User.current().followeeQuery();e.equalTo("followee",AV.Object.createWithoutData("_User",t.user.id)),e.count().done(function(e){t.isMyFollowee=1==e,t.$apply()})}}t.AV=AV,t.WeChatJS$=e,t.User$=o,t.isMyFollowee=!1,t.isMe=function(){return t.user.id==AV.User.current().id},t.$watch(function(){return t.user?t.user.attributes:null},function(){s(),(null==t.hideUsedBook||0==t.hideUsedBook)&&(n(),i())}),t.$on("FollowSomeone",function(){s()}),t.$on("UnfollowSomeone",function(){s()})}return{restrict:"E",scope:{user:"=",hideUsedBook:"=?",usedBookObjectId:"=?"},templateUrl:"temp/tool/userInfoTemplate.html",link:t}}]);